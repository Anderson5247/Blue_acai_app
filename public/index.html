<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blue Açaí – Cardápio Interativo</title>
    <style>
        :root { --purple: #5A0F8D; --light-purple: #F3E5FF; --dark-text: #333; --card-bg: #fff; --danger-red: #dc3545; --danger-red-hover: #c82333; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light-purple); color: var(--dark-text); }
        header { background: var(--purple); color: #fff; text-align: center; padding: 1rem; }
        header img { max-width: 120px; margin-bottom: .5rem; }
        main { max-width: 800px; margin: 1rem auto; padding: 0 1rem; }
        .card { background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); padding: 1rem; margin-bottom: 1rem; }
        fieldset { border: none; margin: 1rem 0; transition: opacity .3s; }
        fieldset[disabled] { opacity: .6; pointer-events: none; }
        legend { font-weight: bold; margin-bottom: .5rem; color: var(--purple); }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: .75rem; }
        label { display: flex; align-items: center; cursor: pointer; font-size: .95rem; padding: 5px; border-radius: 4px; transition: background-color 0.2s; }
        label:hover:not(.disabled-item) { background-color: #f0f0f0; }
        label.disabled-item { text-decoration: line-through; color: #aaa !important; cursor: not-allowed; }
        label input { margin-right: .5rem; cursor: pointer; }
        label input:disabled { cursor: not-allowed; }
        .counter { margin-left: .5rem; color: var(--purple); font-weight: normal; font-size: .9rem; }
        .buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: .75rem; margin-top: 1.5rem; }
        .buttons button { padding: .75rem; border: none; border-radius: 4px; background: var(--purple); color: #fff; cursor: pointer; transition: background-color 0.2s; font-size: 0.85rem; white-space: nowrap; }
        .buttons button:hover:not(:disabled) { background-color: #4a0c74; }
        .buttons button:disabled { background: #ccc; cursor: not-allowed; }
        #ordersSection { border-top: 2px solid var(--purple); margin-top: 1.5rem; padding-top: 1rem; }
        #ordersList li { margin-bottom: .75rem; list-style: none; padding: .5rem; border-bottom: 1px dashed #eee; }
        .order-item-container { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .order-item-details { flex-grow: 1; line-height: 1.5; }
        .repeat-item-btn { padding: 5px 10px; font-size: 0.8rem; background-color: var(--light-purple); color: var(--purple); border: 1px solid var(--purple); border-radius: 5px; cursor: pointer; flex-shrink: 0; transition: background-color 0.2s; }
        .repeat-item-btn:hover { background-color: var(--purple); color: #fff; }
        .produtos-opcoes { display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin-top: 1rem; }
        .produto-card { border: 2px solid #ccc; border-radius: 10px; padding: 1rem; width: 210px; text-align: center; transition: 0.3s; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .produto-card input[type="radio"] { position: absolute; top: 10px; right: 10px; transform: scale(1.3); accent-color: var(--purple); z-index: 2; }
        .produto-card:hover { border-color: var(--purple); transform: translateY(-3px); }
        label.produto-card.selected { border-color: var(--purple); background-color: #faf5ff; }
        .produto-card img { width: 100%; max-height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 0.75rem; }
        .produto-card strong, .produto-card span { display: block; }
        .produto-card strong { font-size: 1rem; margin-top: 0.5rem; }
        .produto-card span { font-size: 0.85rem; color: #555; margin-top: 0.25rem; line-height: 1.3; }
        .pix-info-container { background-color: #fdf1ff; border: 1px solid var(--purple); padding: 1rem; margin-top: 1.5rem; border-radius: 8px; text-align: center; }
        .pix-info-container.hidden { display: none; }
        #orderPageTotal { text-align: right; margin-top: 1rem; font-weight: bold; font-size: 1.1em; padding: 0.75rem; background-color: #f0f0f0; border-radius: 0 0 8px 8px; }
        .special-flavors-fs label { border: 1px solid #ccc; padding: 10px; border-radius: 5px; background-color: #f9f9f9; }
        .special-flavors-fs label.selected-radio { border-color: var(--purple); background-color: #e9d8f3; font-weight: bold; }
        .special-flavors-fs label input[type="radio"] { accent-color: var(--purple); }
        .special-flavors-fs label small { display: block; font-size: 0.8em; color: #555; margin-left: 1.5rem; margin-top: 0.2em; font-weight: normal; }
    </style>
</head>
<body>
    <header>
        <img src="/images/logo.png" alt="Logomarca Blue Açaí" />
        <h1>Blue Açaí</h1>
        <p>Monte seu açaí como quiser!</p>
    </header>
    <main>
        <div class="card">
            <form id="formPedido">
                <fieldset id="fsProdutoPrincipal"><legend>1. Escolha o Produto <span class="section-status">(Obrigatório)</span></legend><div class="produtos-opcoes" id="boxProdutosPrincipais"></div></fieldset>
                <fieldset id="fs-copo_felicidade" class="special-flavors-fs" disabled><legend>2. Escolha o Sabor do Copo <span class="section-status">(Obrigatório)</span></legend><div class="grid-2" id="box-copo_felicidade"></div></fieldset>
                <fieldset id="fs-fatia_bolo_doce_amor" class="special-flavors-fs" disabled><legend>2. Escolha o Sabor do Bolo <span class="section-status">(Obrigatório)</span></legend><div class="grid-2" id="box-fatia_bolo_doce_amor"></div></fieldset>
                <fieldset id="fsFrutas" disabled><legend>2. Frutas <span id="cntFrutas" class="counter">(0/?)</span></legend><div class="grid-2" id="boxFrutas"></div></fieldset>
                <fieldset id="fsCremes" disabled><legend>3. Cremes <span id="cntCremes" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCremes"></div></fieldset>
                <fieldset id="fsAccomp" disabled><legend>4. Acompanhamentos <span id="cntAccomp" class="counter">(0/?)</span></legend><div class="grid-2" id="boxAccomp"></div></fieldset>
                <fieldset id="fsCoverage" disabled><legend>5. Cobertura(s) <span id="cntCover" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCoverage"></div></fieldset>
                <fieldset id="fsAskAdd" disabled><legend>6. Deseja adicionais? <span class="section-status">(Obrigatório para Açaí)</span></legend><div class="grid-2" id="boxAskAdd"></div></fieldset>
                <fieldset id="fsAdd" disabled><legend>7. Adicionais <span id="cntAdd" class="counter">(0/14)</span></legend><div class="grid-2" id="boxAdd"></div></fieldset>
                <fieldset id="fsPayment" disabled><legend>8. Forma de Pagamento <span class="section-status">(Obrigatório)</span></legend><div class="grid-2" id="boxPayment"></div></fieldset>
                <fieldset id="fsDelivery" disabled><legend>9. Entrega ou Retirada <span class="section-status">(Obrigatório)</span></legend><div class="grid-2" id="boxDelivery"></div></fieldset>
                <div class="buttons">
                    <button type="button" id="btnCancel">❌ Limpar Pedido</button>
                    <button type="button" id="btnAdd" disabled>➕ Adicionar ao Pedido</button>
                    <button type="button" id="btnFinish" disabled>✅ Finalizar e Enviar</button>
                </div>
                <div id="pixInfo" class="pix-info-container hidden"></div>
            </form>
        </div>
        <div class="card" id="ordersSection" style="display:none;">
            <h2>Seu Pedido</h2>
            <ul id="ordersList"></ul>
            <div id="orderPageTotal">Total Geral (com frete): R$ <span id="orderPageTotalValue">0,00</span></div>
        </div>
    </main>
    <div id="shopClosedContainer" class="card" style="display: none; text-align: center; padding: 2rem; margin: 1rem auto; max-width: 800px;">
        <h2>Estamos Fechados no Momento</h2>
        <p id="closedMessageText"></p>
    </div>

    <script>
        let state = {};
        let orders = [];
        let allItemsData = {};

        const qs = (selector) => document.querySelector(selector);
        
        const enable = el => { if (el) el.disabled = false; };
        const disable = el => { if (el) el.disabled = true; };
        
        const updateCounter = (element, count, max) => { if (element) element.textContent = `( ${count} / ${max ?? '?'} )`; };

        function updateButtonStates() {
            const itemValid = validateCurrentItem();
            const finalFieldsValid = !!state.payment && !!state.delivery;
            qs('#btnAdd').disabled = !(itemValid && finalFieldsValid);
            qs('#btnFinish').disabled = orders.length === 0 || !finalFieldsValid;
        }

        function validateCurrentItem() {
            if (!state.produtoPrincipal) return false;
            const { type, id } = state.produtoPrincipal;
            if (type === 'acai') {
                const checkSection = (key) => {
                    const fieldset = qs(`#fs${key.charAt(0).toUpperCase() + key.slice(1)}`);
                    if (fieldset.disabled) return true;
                    const items = state[key] || [];
                    const noneValue = key === 'add' ? 'Nenhum Adicional' : 'Nenhuma';
                    return items.length > 0 && !(items.includes(noneValue) && items.length > 1);
                };
                if (!qs('#fsAskAdd').disabled && !state.wantAdd) return false;
                return ['frutas', 'cremes', 'accomp', 'cover'].every(key => checkSection(key)) && (state.wantAdd === 'Não' || checkSection('add'));
            }
            if (type === 'produto_especial') {
                const productData = allItemsData.produtos_especiais.find(p => p.id === id);
                return !productData?.requires_flavor_selection || !!state.selectedFlavor;
            }
            return false;
        }

        function renderOrders() {
            qs('#ordersSection').style.display = orders.length > 0 ? 'block' : 'none';
            qs('#ordersList').innerHTML = '';
            let totalGeral = 0;
            const deliveryFeeMatch = state.delivery?.match(/R\$ (\d+[.,]\d{2})/);
            const deliveryFee = deliveryFeeMatch ? parseFloat(deliveryFeeMatch[1].replace(',', '.')) : 0;

            orders.forEach((order, i) => {
                let subTotal = order.produtoPrincipal.price;
                let details = '';
                if (order.produtoPrincipal.type === 'acai') {
                    const formatList = (list) => (list && !list.includes('Nenhuma') && !list.includes('Nenhum Adicional')) ? list.join(', ') : 'Nenhum';
                    details += `Frutas: ${formatList(order.frutas)}<br>`;
                    details += `Cremes: ${formatList(order.cremes)}<br>`;
                    details += `Acompanhamentos: ${formatList(order.accomp)}<br>`;
                    details += `Coberturas: ${formatList(order.cover)}<br>`;
                    if (order.wantAdd === 'Sim' && order.add && !order.add.includes('Nenhum Adicional')) {
                        order.add.forEach(() => subTotal += 1.00);
                        details += `Adicionais: ${order.add.map(a => a.split(' - R$')[0]).join(', ')}`;
                    } else {
                        details += `Adicionais: Nenhum`;
                    }
                } else if (order.produtoPrincipal.type === 'produto_especial') {
                    details += `Sabor: ${order.selectedFlavor || 'N/A'}`;
                }
                
                const li = document.createElement('li');
                li.innerHTML = `<div class="order-item-container">
                                    <div class="order-item-details">
                                        <strong>Item ${i + 1}: ${order.produtoPrincipal.name}</strong><br>
                                        <small>${details}</small><br>
                                        <strong>Subtotal: R$ ${subTotal.toFixed(2).replace('.', ',')}</strong>
                                    </div>
                                    <button type="button" class="repeat-item-btn" data-order-index="${i}">Repetir Item</button>
                                </div>`;
                qs('#ordersList').appendChild(li);
                totalGeral += subTotal;
            });
            totalGeral += deliveryFee;
            qs('#orderPageTotalValue').textContent = totalGeral.toFixed(2).replace('.', ',');
            updateButtonStates();
        }
        
        function generateSummaryText() {
            let totalGeral = 0;
            const itemsPayload = [];
            let adminText = "Blue Açaí - Novo Pedido!\n\n";

            orders.forEach((order, i) => {
                let subTotal = order.produtoPrincipal.price;
                const itemPayload = { produto: order.produtoPrincipal.name, tipo: order.produtoPrincipal.type };
                
                adminText += `*Item ${i + 1}:* ${order.produtoPrincipal.name}\n`;

                if(order.produtoPrincipal.type === 'acai') {
                    const formatList = (list) => (list && !list.includes('Nenhuma') && !list.includes('Nenhum Adicional')) ? list.join(', ') : 'Nenhum';
                    itemPayload.frutas = formatList(order.frutas);
                    itemPayload.cremes = formatList(order.cremes);
                    itemPayload.acompanhamentos = formatList(order.accomp);
                    itemPayload.coberturas = formatList(order.cover);

                    adminText += `*Frutas:* ${itemPayload.frutas}\n`;
                    adminText += `*Cremes:* ${itemPayload.cremes}\n`;
                    adminText += `*Acompanhamentos:* ${itemPayload.acompanhamentos}\n`;
                    adminText += `*Coberturas:* ${itemPayload.coberturas}\n`;

                    if (order.wantAdd === 'Sim' && order.add && !order.add.includes('Nenhum Adicional')) {
                        order.add.forEach(() => subTotal += 1.00);
                        const formattedAdicionais = order.add.map(a => a.split(' - R$')[0].toUpperCase()).join(', ');
                        itemPayload.adicionais = formattedAdicionais;
                        adminText += `*Adicionais:* *${itemPayload.adicionais}*\n`;
                    } else {
                        itemPayload.adicionais = 'Nenhum';
                        adminText += `*Adicionais:* ${itemPayload.adicionais}\n`;
                    }
                } else if (order.produtoPrincipal.type === 'produto_especial') {
                    itemPayload.sabor = order.selectedFlavor || 'N/A';
                    adminText += `*Sabor:* ${itemPayload.sabor}\n`;
                }

                adminText += '\n'; 
                itemPayload.totalPedido = subTotal.toFixed(2);
                itemsPayload.push(itemPayload);
                totalGeral += subTotal;
            });
            
            const deliveryFeeMatch = state.delivery?.match(/R\$ (\d+[.,]\d{2})/);
            const deliveryFee = deliveryFeeMatch ? parseFloat(deliveryFeeMatch[1].replace(',', '.')) : 0;
            totalGeral += deliveryFee;

            adminText = adminText.trimEnd();
            adminText += `\n\n------------------------------\n`;
            adminText += `*Pagamento:* ${state.payment}\n`;
            adminText += `*Entrega/Retirada:* ${state.delivery.split(' - R$')[0]}\n`;
            if (deliveryFee > 0) adminText += `*Taxa de Entrega:* R$ ${deliveryFee.toFixed(2).replace('.', ',')}\n`;
            adminText += `*TOTAL GERAL DO PEDIDO: R$ ${totalGeral.toFixed(2).replace('.', ',')}*\n`;
            
            const payloadForServer = { pedidoCompleto: itemsPayload, valorTotal: totalGeral, metodoPagamento: state.payment, tipoEntrega: state.delivery, resumoParaAdmin: adminText };
            return { admin: adminText, payload: payloadForServer };
        }

        function setupListeners() {
            const form = qs('#formPedido');

            const setupCheckListeners = (fieldset, max, key) => {
                const originalBox = fieldset.querySelector('.grid-2');
                const newBox = originalBox.cloneNode(true);
                originalBox.parentNode.replaceChild(newBox, originalBox);
                
                const checkboxes = newBox.querySelectorAll('input[type="checkbox"]');
                const noneCheckbox = Array.from(checkboxes).find(c => c.value.toLowerCase().includes('nenhum'));
                
                state[key] = [];
                if (noneCheckbox && !noneCheckbox.disabled) {
                    noneCheckbox.checked = true;
                    state[key].push(noneCheckbox.value);
                }
                updateCounter(fieldset.querySelector('.counter'), 0, max);
                
                newBox.addEventListener('change', e => {
                    if (e.target.type !== 'checkbox') return;
                    
                    const chk = e.target;
                    if (chk === noneCheckbox && chk.checked) {
                        checkboxes.forEach(other => { if(other !== chk) other.checked = false; });
                    } else if(chk.checked && noneCheckbox) {
                        noneCheckbox.checked = false;
                    }

                    state[key] = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
                    let count = state[key].filter(v => !v.toLowerCase().includes('nenhum')).length;

                    if (count > max) {
                        chk.checked = false;
                        alert(`Máximo de ${max} opções para esta categoria.`);
                        state[key] = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
                    }
                    
                    count = state[key].filter(v => !v.toLowerCase().includes('nenhum')).length;
                    if (count === 0 && noneCheckbox && !noneCheckbox.disabled) {
                        noneCheckbox.checked = true;
                        state[key] = [noneCheckbox.value];
                    }

                    updateCounter(fieldset.querySelector('.counter'), count, max);
                    updateButtonStates();
                });
            };

            form.addEventListener('change', e => {
                const target = e.target;
                if (target.type !== 'radio') return;
                
                const name = target.name;
                qsa(`input[name="${name}"]`).forEach(r => r.closest('label')?.classList.remove('selected-radio', 'selected'));
                target.closest('label')?.classList.add('selected-radio', 'selected');

                if (name === 'produtoPrincipal') {
                    Object.keys(state).forEach(key => key !== 'payment' && key !== 'delivery' ? delete state[key] : null);
                    qsa('fieldset:not(#fsProdutoPrincipal, #fsPayment, #fsDelivery)').forEach(disable);

                    const selectedCard = target.closest('.produto-card');
                    const { productType, productId, price } = selectedCard.dataset;
                    state.produtoPrincipal = { type: productType, id: productId, name: target.value, price: parseFloat(price) };
                    
                    if (productType === 'acai') {
                        let limits = {};
                        if (productId === 'size-300') limits = { f: 1, c: 1, a: 3, co: 1 };
                        else if (productId === 'size-500') limits = { f: 2, c: 2, a: 3, co: 1 };
                        else if (productId === 'size-1L') limits = { f: 3, c: 3, a: 4, co: 2 };
                        
                        [qs('#fsFrutas'), qs('#fsCremes'), qs('#fsAccomp'), qs('#fsCoverage'), qs('#fsAskAdd')].forEach(enable);
                        setupCheckListeners(qs('#fsFrutas'), limits.f, 'frutas');
                        setupCheckListeners(qs('#fsCremes'), limits.c, 'cremes');
                        setupCheckListeners(qs('#fsAccomp'), limits.a, 'accomp');
                        setupCheckListeners(qs('#fsCoverage'), limits.co, 'cover');
                    } else if (productType === 'produto_especial') {
                        const productData = allItemsData.produtos_especiais.find(p => p.id === productId);
                        if (productData?.requires_flavor_selection) enable(qs(`#fs-${productId}`));
                    }
                } else if (name.startsWith('flavor-')) {
                    state.selectedFlavor = target.value;
                } else if (name === 'wantAdd') {
                    state.wantAdd = target.value;
                    const addFs = qs('#fsAdd');
                    state.wantAdd === 'Sim' ? enable(addFs) : disable(addFs);
                    if (state.wantAdd === 'Sim') setupCheckListeners(addFs, 14, 'add');
                } else if (name === 'payment' || name === 'delivery') {
                    state[name] = target.value;
                    if (name === 'payment') qs('#pixInfo').classList.toggle('hidden', target.value !== 'Pix');
                }
                updateButtonStates();
            });

            qs('#btnCancel').addEventListener('click', () => { if (confirm("Deseja limpar tudo?")) resetFullForm(true); });
            
            qs('#btnAdd').addEventListener('click', () => {
                orders.push(JSON.parse(JSON.stringify(state)));
                const currentPayment = state.payment;
                const currentDelivery = state.delivery;
                resetFullForm(false);
                state.payment = currentPayment;
                state.delivery = currentDelivery;
                if(state.payment) qs(`input[name="payment"][value="${state.payment}"]`)?.closest('label').classList.add('selected-radio');
                if(state.delivery) qs(`input[name="delivery"][value="${state.delivery}"]`)?.closest('label').classList.add('selected-radio');
                renderOrders();
            });

            qs('#btnFinish').addEventListener('click', async () => {
                if (validateCurrentItem() && !qs('#btnAdd').disabled) {
                    orders.push(JSON.parse(JSON.stringify(state)));
                }
                if (orders.length === 0) return alert("Seu pedido está vazio.");
                
                renderOrders();
                const summary = generateSummaryText();
                const phoneNumber = '5598985016035';
                const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(summary.admin)}`;

                try {
                    qs('#btnFinish').disabled = true;
                    const response = await fetch('/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(summary.payload) });
                    if (!response.ok) throw new Error('Falha ao registrar pedido.');
                    alert("Pedido enviado! Redirecionando para o WhatsApp.");
                    window.location.href = whatsappURL;
                    await resetFullForm(true);
                } catch (error) {
                    alert(`Erro de conexão. Envie o pedido manualmente no WhatsApp:\n\n${summary.admin}`);
                    qs('#btnFinish').disabled = false;
                }
            });
            
            qs('#ordersList').addEventListener('click', e => {
                if (e.target.classList.contains('repeat-item-btn')) {
                    const index = parseInt(e.target.dataset.orderIndex, 10);
                    if (orders[index]) {
                        orders.push(JSON.parse(JSON.stringify(orders[index])));
                        renderOrders();
                    }
                }
            });
        }
        
        async function resetFullForm(fetchData = true) {
            Object.keys(state).forEach(key => delete state[key]);
            qs('#formPedido').reset();
            qsa('.selected, .selected-radio').forEach(el => el.classList.remove('selected', 'selected-radio'));
            qsa('fieldset:not(#fsProdutoPrincipal)').forEach(disable);
            if(fetchData) await fetchAndApplyItemAvailability();
            renderOrders();
            updateButtonStates();
        }

        async function fetchAndApplyItemAvailability() {
            try {
                const response = await fetch('/api/items');
                if (!response.ok) throw new Error('Falha ao buscar itens');
                allItemsData = await response.json();
                
                qs('#shopClosedContainer').style.display = 'none';
                qs('main > .card').style.display = 'block';

                if (allItemsData.shopInfo?.isOpen === false) {
                    qs('main > .card').style.display = 'none';
                    qs('#ordersSection').style.display = 'none';
                    qs('#shopClosedContainer').style.display = 'block';
                    qs('#closedMessageText').innerText = allItemsData.shopInfo.closedMessage.replace(/\\n/g, '\n');
                    return;
                }

                const renderCheckboxes = (containerId, items, name) => {
                    const container = qs(containerId);
                    if (!container) return;
                    container.innerHTML = items.map(item => `
                        <label class="${!item.available ? 'disabled-item' : ''}">
                            <input type="checkbox" name="${name}" value="${item.name}" data-item-id="${item.id}" ${!item.available ? 'disabled' : ''} />
                            ${item.name.split(' - R$')[0]} ${item.name.includes('R$') ? ` - R$ ${item.name.split(' - R$')[1]}`:''}
                        </label>
                    `).join('');
                };

                const renderRadios = (containerId, items, name) => {
                     const container = qs(containerId);
                     if (!container) return;
                     container.innerHTML = items.map(item => `<label><input type="radio" name="${name}" value="${item.name}">${item.name}</label>`).join('');
                };

                // --- CÓDIGO RESTAURADO ---
                renderCheckboxes('#boxFrutas', allItemsData.frutas, 'frutas[]');
                renderCheckboxes('#boxCremes', allItemsData.cremes, 'cremes[]');
                renderCheckboxes('#boxAccomp', allItemsData.acompanhamentos, 'accomp[]');
                renderCheckboxes('#boxCoverage', allItemsData.coberturas, 'coberturas[]');
                renderCheckboxes('#boxAdd', allItemsData.adicionais, 'add[]');
                renderRadios('#boxAskAdd', [{name: 'Sim'}, {name: 'Não'}], 'wantAdd');
                renderRadios('#boxPayment', [{name: 'Pix'}, {name: 'Dinheiro'}, {name: 'Cartão'}], 'payment');
                renderRadios('#boxDelivery', [{name: 'Retirada'}, {name: 'Outeiro - R$ 3.00'}, {name: 'Cedral - R$ 5.00'}], 'delivery');
                // --- FIM DO CÓDIGO RESTAURADO ---

                qs('#pixInfo').innerHTML = `<h3>Pagamento via PIX</h3><p><strong>Nome:</strong> Bruna Raquel Carvalho Campos</p><p><strong>Chave PIX (Celular):</strong> (98) 985016035</p><p><small>Por favor, envie o comprovante após finalizar o pedido no WhatsApp.</small></p>`;

                const mainProductsContainer = qs('#boxProdutosPrincipais');
                const acaiProducts = [
                    { id: 'size-300', name: 'Copo Pequeno (300ml)', price: 10.00, img: '/images/copo-pequeno.jpg', description: 'Até 1 fruta, até 1 creme,<br>até 3 acompanhamentos,<br>até 1 cobertura', available: true },
                    { id: 'size-500', name: 'Copo Grande (500ml)', price: 15.00, img: '/images/copo-grande.jpg', description: 'Até 2 frutas, até 2 cremes,<br>até 3 acompanhamentos,<br>até 1 cobertura', available: true },
                    { id: 'size-1L', name: 'Pote da Felicidade (1 litro)', price: 40.00, img: '/images/pote-felicidade.jpg', description: 'Até 3 frutas, até 3 cremes,<br>até 4 acompanhamentos,<br>até 2 coberturas', available: true }
                ];
                const renderCard = (prod, type) => {
                    const imgMap = { 'copo_felicidade': '/images/copo-felicidade.jpg', 'fatia_bolo_doce_amor': '/images/fatia-bolo.jpg' };
                    const img = imgMap[prod.id] || prod.img || '/images/logo.png';
                    return `<label class="produto-card ${!prod.available ? 'disabled-item' : ''}" for="prod-${prod.id}" data-product-type="${type}" data-product-id="${prod.id}" data-price="${prod.price}">
                                <img src="${img}" alt="${prod.name}" />
                                <input type="radio" name="produtoPrincipal" value="${prod.name}" id="prod-${prod.id}" ${!prod.available ? 'disabled' : ''}/>
                                <div>
                                    <strong>${prod.name}</strong> - R$ ${prod.price.toFixed(2).replace('.', ',')}
                                    <span>${prod.description}</span>
                                </div>
                            </label>`;
                };
                mainProductsContainer.innerHTML = acaiProducts.map(p => renderCard(p, 'acai')).join('') + 
                                                  (allItemsData.produtos_especiais || []).map(p => renderCard(p, 'produto_especial')).join('');

                setupListeners();
                enable(qs('#fsPayment'));
                enable(qs('#fsDelivery'));
            } catch(e) {
                console.error(e);
                qs('main').innerHTML = '<h2>Erro ao carregar o cardápio. Tente novamente mais tarde.</h2>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', resetFullForm);
    </script>
</body>
</html>
