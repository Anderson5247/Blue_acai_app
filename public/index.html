<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blue A√ßa√≠ ‚Äì Card√°pio Interativo</title>
    <style>
        :root {
            --purple: #5A0F8D;
            --light-purple: #F3E5FF;
            --dark-text: #333;
            --card-bg: #fff;
            --danger-red: #dc3545;
            --danger-red-hover: #c82333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--light-purple);
            color: var(--dark-text);
        }

        header {
            background: var(--purple);
            color: #fff;
            text-align: center;
            padding: 1rem;
        }

        header img {
            max-width: 120px;
            margin-bottom: .5rem;
        }

        main {
            max-width: 800px;
            margin: 1rem auto;
            padding: 0 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        fieldset {
            border: none;
            margin: 1rem 0;
            transition: opacity .3s;
        }

        fieldset[disabled] {
            opacity: .6;
            /* pointer-events: none; /* Removido daqui e tratado no JS para permitir desabilitados vis√≠veis */
        }

        fieldset[disabled] label {
             pointer-events: none; /* Impede clique nos labels quando o fieldset est√° desabilitado */
        }


        legend {
            font-weight: bold;
            margin-bottom: .5rem;
            color: var(--purple);
        }

        legend .section-status {
            font-weight: normal;
            font-size: 0.85em;
            color: #666;
            margin-left: 5px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: .75rem;
        }

        label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: .95rem;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        label:hover:not(.disabled-item) {
            background-color: #f0f0f0;
        }

        label.disabled-item {
            text-decoration: line-through;
            color: #aaa !important;
            cursor: not-allowed;
            pointer-events: none; /* Desabilita clique em itens individuais indispon√≠veis */
        }

        label input[type="checkbox"],
        label input[type="radio"] {
            margin-right: .5rem;
            cursor: pointer;
        }

        label input[type="checkbox"]:disabled,
        label input[type="radio"]:disabled {
            cursor: not-allowed;
        }

        .counter {
            margin-left: .5rem;
            color: var(--purple);
            font-weight: normal;
            font-size: .9rem;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: .75rem;
            margin-top: 1.5rem;
        }

        .buttons button {
            padding: .75rem;
            border: none;
            border-radius: 4px;
            background: var(--purple);
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .buttons button#btnCancel {
            background-color: var(--danger-red);
        }
        .buttons button#btnCancel:hover:not(:disabled) {
            background-color: var(--danger-red-hover);
        }

        .buttons button:hover:not(:disabled) {
            background-color: #4a0c74;
        }

        .buttons button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #summary {
            display: none;
            white-space: pre-wrap;
        }

        #ordersSection {
            border-top: 2px solid var(--purple);
            margin-top: 1.5rem;
            padding-top: 1rem;
        }

        #ordersList li {
            margin-bottom: .75rem;
            list-style: none;
            padding-left: 1.5rem;
            position: relative;
            border-bottom: 1px dashed #eee;
            padding-bottom: 0.5rem;
        }

        #ordersList li::before {
            content: 'üç¶';
            position: absolute;
            left: 0;
            top: 0;
            font-size: 0.9em;
        }

        /* Estilos adaptados para incluir Copo da Felicidade na se√ß√£o de produtos/tamanhos */
        .produtos-opcoes { display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin-top: 1rem; }
        .produto-card { background: var(--card-bg); border: 2px solid #ccc; border-radius: 10px; padding: 1rem; width: 210px; text-align: center; transition: 0.3s; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; position: relative; }
        .produto-card input[type="radio"] { position: absolute; top: 10px; right: 10px; transform: scale(1.3); cursor: pointer; }
        .produto-card:hover { border-color: var(--purple); transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12); }
        label.produto-card.selected { border-color: var(--purple); box-shadow: 0 5px 10px rgba(90, 15, 141, 0.2); background-color: #faf5ff; }
        .produto-card img { width: 100%; max-height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 0.75rem; }
        .produto-card strong { font-size: 1rem; color: #333; display: block; margin-top: 0.5rem; }
        .produto-card span { font-size: 0.85rem; color: #555; margin-top: 0.25rem; display: block; line-height: 1.3; }
        /* Remover estilos espec√≠ficos de .tamanho-card para usar .produto-card */
        .tamanhos-opcoes, .tamanho-card { /* Estes seletores n√£o ser√£o mais usados diretamente para o layout principal */ }


        .pix-info-container {
            background-color: #fdf1ff;
            border: 1px solid var(--purple);
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        .pix-info-container.hidden {
            display: none;
        }
        .pix-info-container h3 { color: var(--purple); margin-bottom: 0.75rem; }
        .pix-info-container p { margin-bottom: 0.5rem; line-height: 1.4; }
        .pix-info-container small { color: #555; font-style: italic; }

        #orderPageTotal {
            text-align: right; margin-top: 1rem; font-weight: bold;
            font-size: 1.1em; padding: 0.75rem; background-color: #f0f0f0;
            border-top: 1px solid #ddd; border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        /* Estilo espec√≠fico para a sele√ß√£o de sabor do Copo da Felicidade */
        #fsCopoFelicidadeFlavors .grid-2 label { /* Adapte conforme necess√°rio */
             border: 1px solid #ccc; /* Adiciona uma borda para diferenciar os sabores */
             padding: 10px;
             border-radius: 5px;
             background-color: #f9f9f9;
             display: flex; /* Garante que label use flexbox para align-items: center */
             align-items: center;
        }
         #fsCopoFelicidadeFlavors .grid-2 label.selected-radio {
             border-color: var(--purple);
             background-color: #e9d8f3; /* Cor de fundo mais clara ao selecionar */
             font-weight: bold;
         }
         #fsCopoFelicidadeFlavors .grid-2 label input[type="radio"] {
             margin-right: 0.5rem;
             cursor: pointer;
         }
          #fsCopoFelicidadeFlavors .grid-2 label small {
             display: block; /* Quebra linha para a descri√ß√£o interna */
             font-size: 0.8em;
             color: #555;
             margin-left: 1.5rem; /* Ajuste para alinhar com o texto do sabor */
             margin-top: 0.2em; /* Espa√ßo entre sabor e descri√ß√£o */
             font-weight: normal;
          }
           #fsCopoFelicidadeFlavors .grid-2 label span { /* Usar span para o nome do sabor */
             display: inline; /* Mant√©m o nome do sabor na mesma linha do r√°dio */
             font-weight: bold;
           }


    </style>
</head>
<body>
    <header>
        <img src="/images/logo.png" alt="Logomarca Blue A√ßa√≠" />
        <h1>Blue A√ßa√≠</h1>
        <p>Monte seu a√ßa√≠ como quiser!</p>
    </header>
    <main>
        <div class="card">
            <form id="formPedido">
                <fieldset id="fsProdutoPrincipal">
                     <legend>1. Escolha o Produto <span class="section-status">(Obrigat√≥rio)</span></legend>
                     <div class="produtos-opcoes" id="boxProdutosPrincipais">
                         </div>
                </fieldset>

                <fieldset id="fsCopoFelicidadeFlavors" disabled>
                     <legend>2. Escolha o Sabor <span class="section-status">(Obrigat√≥rio)</span></legend>
                     <div class="grid-2" id="boxCopoFelicidadeFlavors">
                         </div>
                 </fieldset>

                <fieldset id="fsFrutas" disabled><legend>2. Frutas <span id="cntFrutas" class="counter">(0/?)</span></legend><div class="grid-2" id="boxFrutas"><label for="chk-morango"><input type="checkbox" value="Morango" id="chk-morango" data-item-id="morango" />Morango</label><label for="chk-banana"><input type="checkbox" value="Banana" id="chk-banana" data-item-id="banana" />Banana</label><label for="chk-kiwi"><input type="checkbox" value="Kiwi" id="chk-kiwi" data-item-id="kiwi" />Kiwi</label><label for="chk-maca"><input type="checkbox" value="Ma√ß√£" id="chk-maca" data-item-id="maca" />Ma√ß√£</label><label for="chk-uva"><input type="checkbox" value="Uva" id="chk-uva" data-item-id="uva" />Uva</label><label for="chk-frutas-nenhuma"><input type="checkbox" value="Nenhuma" id="chk-frutas-nenhuma" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsCremes" disabled><legend>3. Cremes <span id="cntCremes" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCremes"><label for="chk-ninho"><input type="checkbox" value="Ninho" id="chk-ninho" data-item-id="ninho" />Ninho</label><label for="chk-maracuja"><input type="checkbox" value="Maracuj√°" id="chk-maracuja" data-item-id="maracuja" />Maracuj√°</label><label for="chk-morango-creme"><input type="checkbox" value="Morango" id="chk-morango-creme" data-item-id="morango_creme" />Morango</label><label for="chk-tutti-frutti-creme"><input type="checkbox" value="Tutti Frutti" id="chk-tutti-frutti-creme" data-item-id="tutti_frutti_creme" />Tutti Frutti</label><label for="chk-chocolate-avela"><input type="checkbox" value="Chocolate com Avel√£" id="chk-chocolate-avela" data-item-id="chocolate_avela" />Chocolate c/Avel√£</label><label for="chk-cremes-nenhum"><input type="checkbox" value="Nenhuma" id="chk-cremes-nenhum"/>Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsAccomp" disabled><legend>4. Acompanhamentos <span id="cntAccomp" class="counter">(0/?)</span></legend><div class="grid-2" id="boxAccomp"><label for="chk-amendoim-acomp"><input type="checkbox" value="Amendoim" id="chk-amendoim-acomp" data-item-id="amendoim_acomp" />Amendoim</label><label for="chk-pacoca-acomp"><input type="checkbox" value="Pa√ßoca" id="chk-pacoca-acomp" data-item-id="pacoca_acomp" />Pa√ßoca</label><label for="chk-granola-acomp"><input type="checkbox" value="Granola" id="chk-granola-acomp" data-item-id="granola_acomp" />Granola</label><label for="chk-farinha-lactea-acomp"><input type="checkbox" value="Farinha L√°ctea" id="chk-farinha-lactea-acomp" data-item-id="farinha_lactea_acomp" />Farinha L√°ctea</label><label for="chk-leite-po-acomp"><input type="checkbox" value="Leite em P√≥" id="chk-leite-po-acomp" data-item-id="leite_po_acomp" />Leite em P√≥</label><label for="chk-confetes-acomp"><input type="checkbox" value="Confetes" id="chk-confetes-acomp" data-item-id="confetes_acomp" />Confetes</label><label for="chk-tapioca-acomp"><input type="checkbox" value="Tapioca" id="chk-tapioca-acomp" data-item-id="tapioca_acomp" />Tapioca</label><label for="chk-uva-passa-acomp"><input type="checkbox" value="Uva Passa" id="chk-uva-passa-acomp" data-item-id="uva_passa_acomp" />Uva Passa</label><label for="chk-accomp-nenhum"><input type="checkbox" value="Nenhuma" id="chk-accomp-nenhum" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsCoverage" disabled><legend>5. Cobertura(s) <span id="cntCover" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCoverage"><label for="chk-chocolate-cob"><input type="checkbox" value="Chocolate" id="chk-chocolate-cob" data-item-id="chocolate_cob" />Chocolate</label><label for="chk-morango-cob"><input type="checkbox" value="Morango" id="chk-morango-cob" data-item-id="morango_cob" />Morango</label><label for="chk-leite-condensado-cob"><input type="checkbox" value="Leite Condensado" id="chk-leite-condensado-cob" data-item-id="leite_condensado_cob" />Leite Condensado</label><label for="chk-tutti-frutti-cob"><input type="checkbox" value="Tutti Frutti" id="chk-tutti-frutti-cob" data-item-id="tutti_frutti_cob" />Tutti Frutti</label><label for="chk-ice-blue-cob"><input type="checkbox" value="Ice Blue" id="chk-ice-blue-cob" data-item-id="ice_blue_cob" />Ice Blue</label><label for="chk-kiwi-cob"><input type="checkbox" value="Kiwi" id="chk-kiwi-cob" data-item-id="kiwi_cob" />Kiwi</label><label for="chk-cover-nenhuma"><input type="checkbox" value="Nenhuma" id="chk-cover-nenhuma" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsAskAdd" disabled><legend>6. Deseja adicionais? <span class="section-status">(Obrigat√≥rio)</span></legend><div class="grid-2"><label><input type="radio" name="wantAdd" value="Sim" required />Sim</label><label><input type="radio" name="wantAdd" value="N√£o" />N√£o</label></div></fieldset>
                <fieldset id="fsAdd" disabled><legend>7. Adicionais <span id="cntAdd" class="counter">(0/14)</span></legend><div class="grid-2" id="boxAdd"><label for="chk-ovomaltine-add"><input type="checkbox" value="Ovomaltine - R$ 1.00" id="chk-ovomaltine-add" data-item-id="ovomaltine_add" />Ovomaltine R$ 1.00</label><label for="chk-escureto-add"><input type="checkbox" value="Escureto - R$ 1.00" id="chk-escureto-add" data-item-id="escureto_add" />Escureto R$ 1.00</label><label for="chk-chocoball-add"><input type="checkbox" value="Chocoball - R$ 1.00" id="chk-chocoball-add" data-item-id="chocoball_add" />Chocoball R$ 1.00</label><label for="chk-amendoim-add"><input type="checkbox" value="Amendoim - R$ 1.00" id="chk-amendoim-add" data-item-id="amendoim_add" />Amendoim R$ 1.00</label><label for="chk-pacoca-add"><input type="checkbox" value="Pa√ßoca - R$ 1.00" id="chk-pacoca-add" data-item-id="pacoca_add" />Pa√ßoca R$ 1.00</label><label for="chk-granola-add"><input type="checkbox" value="Granola - R$ 1.00" id="chk-granola-add" data-item-id="granola_add" />Granola R$ 1.00</label><label for="chk-farinha-lactea-add"><input type="checkbox" value="Farinha L√°ctea - R$ 1.00" id="chk-farinha-lactea-add" data-item-id="farinha_lactea_add" />Farinha L√°ctea R$ 1.00</label><label for="chk-leite-po-add"><input type="checkbox" value="Leite em p√≥ - R$ 1.00" id="chk-leite-po-add" data-item-id="leite_po_add" />Leite em p√≥ R$ 1.00</label><label for="chk-confetes-add"><input type="checkbox" value="Confetes - R$ 1.00" id="chk-confetes-add" data-item-id="confetes_add" />Confetes R$ 1.00</label><label for="chk-tapioca-add"><input type="checkbox" value="Tapioca - R$ 1.00" id="chk-tapioca-add" data-item-id="tapioca_add" />Tapioca R$ 1.00</label><label for="chk-uva-passa-add"><input type="checkbox" value="Uva Passa - R$ 1.00" id="chk-uva-passa-add" data-item-id="uva_passa_add" />Uva Passa R$ 1.00</label><label for="chk-mms-add"><input type="checkbox" value="M&MS - R$ 1.00" id="chk-mms-add" data-item-id="mms_add" />M&MS R$ 1.00</label><label for="chk-marshmallow-add"><input type="checkbox" value="Marshmallow - R$ 1.00" id="chk-marshmallow-add" data-item-id="marshmallow_add" />Marshmallow R$ 1.00</label><label for="chk-doce-leite-add"><input type="checkbox" value="Doce de leite - R$ 1.00" id="chk-doce-leite-add" data-item-id="doce_leite_add" />Doce de leite R$ 1.00</label><label for="chk-add-nenhum"><input type="checkbox" value="Nenhuma" id="chk-add-nenhum" />Nenhum Adicional</label></div></fieldset>

                <fieldset id="fsPayment" disabled>
                    <legend>8. Forma de Pagamento <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="payment" value="Pix" required />Pix</label>
                        <label><input type="radio" name="payment" value="Dinheiro" />Dinheiro</label>
                        <label><input type="radio" name="payment" value="Cart√£o" />Cart√£o</label>
                    </div>
                </fieldset>

                <fieldset id="fsDelivery" disabled>
                    <legend>9. Entrega ou Retirada <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="delivery" value="Retirada" required />Retirada</label>
                        <label><input type="radio" name="delivery" value="Outeiro - R$ 3.00" />Entrega - Outeiro (R$ 3.00)</label>
                        <label><input type="radio" name="delivery" value="Cedral - R$ 5.00" />Entrega - Cedral (R$ 5.00)</label>
                    </div>
                </fieldset>

                <div class="buttons">
                    <button type="button" id="btnCancel">‚ùå Cancelar Pedido Atual</button>
                    <button type="button" id="btnAdd" disabled>‚ûï Adicionar Outro Pedido</button>
                    <button type="button" id="btnFinish" disabled>‚úÖ Finalizar e Enviar</button>
                </div>

                <div id="pixInfo" class="pix-info-container hidden">
                    <h3>Pagamento via PIX</h3>
                    <p><strong>Nome:</strong> Bruna Raquel Carvalho Campos</p>
                    <p><strong>Chave PIX (Celular):</strong> (98) 985016035</p>
                    <p><small>Por favor, envie o comprovante ap√≥s finalizar o pedido no WhatsApp.</small></p>
                </div>

            </form>
        </div>

        <div class="card" id="ordersSection" style="display:none;">
            <h2>Seus Pedidos:</h2>
            <ul id="ordersList"></ul>
            <div id="orderPageTotal">
                Total Geral (com frete): R$ <span id="orderPageTotalValue">0,00</span>
            </div>
        </div>

        <div id="summary" style="display: none;"></div>
    </main>

    <script>
        // --- SELETORES ---
        const fs = {
            produtoPrincipal: document.getElementById('fsProdutoPrincipal'), // Novo fieldset
            copoFelicidadeFlavors: document.getElementById('fsCopoFelicidadeFlavors'), // Novo fieldset
            frutas: document.getElementById('fsFrutas'),
            cremes: document.getElementById('fsCremes'),
            accomp: document.getElementById('fsAccomp'),
            cover: document.getElementById('fsCoverage'),
            askAdd: document.getElementById('fsAskAdd'),
            add: document.getElementById('fsAdd'),
            payment: document.getElementById('fsPayment'),
            delivery: document.getElementById('fsDelivery')
        };
        const cnt = {
            frutas: document.getElementById('cntFrutas'), cremes: document.getElementById('cntCremes'),
            accomp: document.getElementById('cntAccomp'), cover: document.getElementById('cntCover'),
            add: document.getElementById('cntAdd')
        };
        const boxProdutosPrincipais = document.getElementById('boxProdutosPrincipais'); // Nova div container
        const boxCopoFelicidadeFlavors = document.getElementById('boxCopoFelicidadeFlavors'); // Nova div container
        const btnAdd = document.getElementById('btnAdd');
        const btnFinish = document.getElementById('btnFinish');
        const btnCancel = document.getElementById('btnCancel');
        const ordersSec = document.getElementById('ordersSection');
        const ordersList = document.getElementById('ordersList');
        const summaryEl = document.getElementById("summary");
        const form = document.getElementById('formPedido');
        const pixInfoDiv = document.getElementById('pixInfo');
        const orderPageTotalValueEl = document.getElementById('orderPageTotalValue');

        let state = {};
        let orders = [];
        let allItemsData = {};
        let copoFelicidadeData = null; // Para armazenar os dados do Copo da Felicidade

        // --- FUN√á√ïES AUXILIARES ---
        const enable = el => {
            if (el) {
                el.removeAttribute('disabled'); // Remove o atributo disabled do fieldset
                el.querySelectorAll('label').forEach(lbl => {
                     // Se o input dentro do label N√ÉO estiver desabilitado (pela disponibilidade), reativa pointer-events
                     const input = lbl.querySelector('input');
                     if (input && !input.disabled) {
                         lbl.style.pointerEvents = 'auto';
                     }
                });
            }
        };
        const disable = el => {
            if (el) {
                el.setAttribute('disabled', ''); // Adiciona o atributo disabled ao fieldset
                el.querySelectorAll('label').forEach(lbl => lbl.style.pointerEvents = 'none'); // Desabilita clique nos labels
            }
        };

        function clearCheckboxes(fieldset) {
             if (fieldset) {
                 // Limpa apenas os checkboxes que N√ÉO est√£o desabilitados
                 fieldset.querySelectorAll('input[type="checkbox"]:checked:not([disabled])').forEach(chk => chk.checked = false);
                 // Se a op√ß√£o "Nenhuma" existe e n√£o est√° desabilitada, garante que ela n√£o fique marcada se outros itens foram desmarcados
                 const noneChk = fieldset.querySelector('input[value="Nenhuma"]:not([disabled])');
                 if (noneChk && noneChk.checked) noneChk.checked = false; // Desmarca "Nenhuma" ao limpar outros
             }
         }


        function clearRadios(name) {
            document.querySelectorAll(`input[name="${name}"]:checked`).forEach(r => r.checked = false);
             document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.closest('label')?.classList.remove('selected-radio')); // Limpa classe visual
        }

        function disableAllDependentFieldsets() {
             // Desabilita todos os fieldsets relacionados a a√ßa√≠ e adicionais
             [fs.frutas, fs.cremes, fs.accomp, fs.cover, fs.askAdd, fs.add].forEach(disable);

             // Limpa as sele√ß√µes nesses fieldsets
             clearCheckboxes(fs.frutas);
             clearCheckboxes(fs.cremes);
             clearCheckboxes(fs.accomp);
             clearCheckboxes(fs.cover);
             clearCheckboxes(fs.add); // Limpa adicionais
             clearRadios('wantAdd'); // Limpa Sim/N√£o adicionais

             // Reseta contadores para 0/?
             updateCounter(cnt.frutas, 0, '?');
             updateCounter(cnt.cremes, 0, '?');
             updateCounter(cnt.accomp, 0, '?');
             updateCounter(cnt.cover, 0, '?');
             updateCounter(cnt.add, 0, 14); // Reseta contador de adicionais

             // Oculta informa√ß√µes PIX se a forma de pagamento n√£o foi selecionada AINDA
             // Decidimos manter payment/delivery selecionado entre itens de um mesmo pedido
             // Ent√£o n√£o vamos resetar nem ocultar PIX aqui se j√° tiver sido selecionado
             // if (!state.payment) { if(pixInfoDiv) pixInfoDiv.classList.add('hidden'); }
        }


        // --- L√ìGICA DE DISPONIBILIDADE E CARREGAMENTO DE ITENS ---
        async function fetchAndApplyItemAvailability() {
            try {
                const response = await fetch('/api/items');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allItemsData = await response.json();

                // Encontra os dados do Copo da Felicidade
                const produtosEspeciais = allItemsData.produtos_especiais || [];
                copoFelicidadeData = produtosEspeciais.find(item => item.id === 'copo_felicidade');

                // Renderiza as op√ß√µes de produtos principais (Tamanhos de A√ßa√≠ + Copo da Felicidade)
                renderProdutosPrincipais();

                // Aplica a disponibilidade aos checkboxes existentes (frutas, cremes, etc.)
                const updateCheckboxDisplay = (categoryKey, containerElement) => {
                    if (!allItemsData[categoryKey] || !containerElement) return;
                    allItemsData[categoryKey].forEach(item => {
                        const checkbox = containerElement.querySelector(`input[data-item-id="${item.id}"]`);
                        if (checkbox) {
                            const label = checkbox.closest('label');
                            if (!item.available) {
                                checkbox.disabled = true;
                                checkbox.checked = false; // Garante que n√£o est√° checado se indispon√≠vel
                                if (label) { label.classList.add('disabled-item'); label.title = 'Item indispon√≠vel'; }
                            } else {
                                checkbox.disabled = false;
                                if (label) {
                                    label.classList.remove('disabled-item');
                                    label.title = '';
                                    // Restaura pointer-events APENAS se o fieldset pai n√£o estiver desabilitado
                                     if (!checkbox.closest('fieldset[disabled]')) {
                                        label.style.pointerEvents = 'auto';
                                     }
                                }
                            }
                        }
                    });
                };

                updateCheckboxDisplay('frutas', fs.frutas);
                updateCheckboxDisplay('cremes', fs.cremes);
                updateCheckboxDisplay('acompanhamentos', fs.accomp);
                updateCheckboxDisplay('coberturas', fs.cover);
                updateCheckboxDisplay('adicionais', fs.add);

                 // Adiciona event listeners para os inputs de produto principal (tamanho/copo felicidade)
                setupProdutoPrincipalListeners();

                 // Configura listeners para r√°dios de pagamento e entrega (eles s√£o globais por pedido)
                 setupRadioListener('payment', 'paymentSelected'); // Novo est√°gio 'paymentSelected'
                 setupRadioListener('delivery', 'deliverySelected'); // Novo est√°gio 'deliverySelected'


            } catch (error) {
                console.error("Erro ao carregar disponibilidade:", error);
                alert("Erro ao carregar o card√°pio. Por favor, recarregue a p√°gina.");
                // Desabilitar tudo se o card√°pio n√£o carregar
                disableAll();
            }
        }

         // Nova fun√ß√£o para renderizar as op√ß√µes de produto principal (tamanho/copo felicidade)
         function renderProdutosPrincipais() {
             if (!boxProdutosPrincipais) return;

             boxProdutosPrincipais.innerHTML = ''; // Limpa o container

             // Adiciona as op√ß√µes de tamanho de a√ßa√≠ (hardcoded como antes, mas usando a nova classe)
             // Voc√™ pode tornar isso din√¢mico buscando de allItemsData se os tamanhos estiverem l√°
             boxProdutosPrincipais.innerHTML += `
                 <label class="produto-card" for="size-300" data-product-type="acai" data-price="10.00">
                     <img src="/images/copo-pequeno.jpg" alt="Copo Pequeno" />
                     <input type="radio" name="produtoPrincipal" value="Copo Pequeno (300ml)" id="size-300" required />
                     <div>
                         <strong>Copo Pequeno (300ml)</strong> - R$ 10.00
                         <span>At√© 1 fruta, at√© 1 creme,<br>at√© 3 acompanhamentos,<br>at√© 1 cobertura</span>
                     </div>
                 </label>
                 <label class="produto-card" for="size-500" data-product-type="acai" data-price="15.00">
                     <img src="/images/copo-grande.jpg" alt="Copo Grande" />
                     <input type="radio" name="produtoPrincipal" value="Copo Grande (500ml)" id="size-500" />
                     <div>
                         <strong>Copo Grande (500ml)</strong> - R$ 15.00
                         <span>At√© 2 frutas, at√© 2 cremes,<br>at√© 3 acompanhamentos,<br>at√© 1 cobertura</span>
                     </div>
                 </label>
                 <label class="produto-card" for="size-1L" data-product-type="acai" data-price="40.00">
                     <img src="/images/pote-felicidade.jpg" alt="Pote da Felicidade" />
                     <input type="radio" name="produtoPrincipal" value="Pote da Felicidade (1L)" id="size-1L" />
                     <div>
                         <strong>Pote da Felicidade (1 litro)</strong> - R$ 40.00
                         <span>At√© 3 frutas, at√© 3 cremes,<br>at√© 4 acompanhamentos,<br>at√© 2 coberturas</span>
                     </div>
                 </label>
             `;

             // Adiciona o Copo da Felicidade se estiver dispon√≠vel
             if (copoFelicidadeData && copoFelicidadeData.available) {
                 boxProdutosPrincipais.innerHTML += `
                     <label class="produto-card" for="prod-${copoFelicidadeData.id}" data-product-type="produto_especial" data-product-id="${copoFelicidadeData.id}" data-price="${copoFelicidadeData.price}">
                         <img src="/images/copo-felicidade.jpg" alt="${copoFelicidadeData.name}" />
                         <input type="radio" name="produtoPrincipal" value="${copoFelicidadeData.name}" id="prod-${copoFelicidadeData.id}" />
                         <div>
                             <strong>${copoFelicidadeData.name}</strong> - R$ ${copoFelicidadeData.price.toFixed(2).replace('.', ',')}
                             <span>${copoFelicidadeData.description}</span>
                         </div>
                     </label>
                 `;

                 // Renderiza as op√ß√µes de sabor do Copo da Felicidade (no fieldset espec√≠fico)
                 renderCopoFelicidadeFlavors();
             } else if (!copoFelicidadeData) {
                 console.warn("Dados do Copo da Felicidade n√£o encontrados em items.json");
             } else if (!copoFelicidadeData.available) {
                 console.log("Copo da Felicidade est√° indispon√≠vel.");
                 // Opcional: Mostrar o card, mas desabilitado visualmente
                 boxProdutosPrincipais.innerHTML += `
                     <label class="produto-card disabled-item" data-product-type="produto_especial" data-product-id="copo_felicidade" title="Indispon√≠vel">
                          <img src="/images/copo-felicidade.jpg" alt="Copo da Felicidade Indispon√≠vel" />
                          <input type="radio" name="produtoPrincipal" value="Copo da Felicidade" disabled />
                          <div>
                             <strong>Copo da Felicidade</strong> - INDISPON√çVEL
                             <span>${copoFelicidadeData.description}</span>
                         </div>
                     </label>
                 `;
             }
         }

         // Nova fun√ß√£o para renderizar os sabores do Copo da Felicidade
         function renderCopoFelicidadeFlavors() {
             if (!boxCopoFelicidadeFlavors || !copoFelicidadeData || !copoFelicidadeData.flavors) return;

             boxCopoFelicidadeFlavors.innerHTML = ''; // Limpa o container

             copoFelicidadeData.flavors.forEach(flavor => {
                 boxCopoFelicidadeFlavors.innerHTML += `
                     <label for="flavor-${flavor.id}">
                         <input type="radio" name="copoFelicidadeFlavor" value="${flavor.name}" id="flavor-${flavor.id}" data-flavor-id="${flavor.id}" required />
                         <span>${flavor.name}</span>
                         <small>(${flavor.internal_description})</small>
                     </label>
                 `;
             });

             // Configura listeners para os r√°dios de sabor do Copo da Felicidade AP√ìS renderiz√°-los
             setupRadioListener('copoFelicidadeFlavor', 'copoFelicidadeFlavorSelected');
         }

         // Nova fun√ß√£o para configurar listeners dos produtos principais (tamanho/copo felicidade)
         function setupProdutoPrincipalListeners() {
             document.querySelectorAll('input[name="produtoPrincipal"]').forEach(radio => {
                 // Remove listeners antigos para evitar duplica√ß√£o ao resetar o formul√°rio
                 if (radio._productListener) {
                     radio.removeEventListener('change', radio._productListener);
                 }

                 const newProductListener = (e) => {
                     // Remove a classe 'selected' de todos os cards de produto
                     document.querySelectorAll('.produto-card').forEach(label => label.classList.remove('selected'));
                     // Adiciona a classe 'selected' ao card clicado
                     e.target.closest('.produto-card')?.classList.add('selected');

                     console.log("Produto Principal selecionado:", e.target.value); // Log para debug

                     // Reseta as op√ß√µes dependentes de a√ßa√≠ e adicionais E o fieldset de sabores do Copo da Felicidade
                     resetDependentOptions();


                     const selectedProductCard = e.target.closest('.produto-card');
                     const productType = selectedProductCard?.dataset.productType; // 'acai' ou 'produto_especial'
                     const productName = e.target.value; // Nome do produto/tamanho
                     const productPrice = parseFloat(selectedProductCard?.dataset.price || 0); // Pre√ßo base

                     state.produtoPrincipal = {
                         type: productType,
                         name: productName,
                         price: productPrice,
                         id: selectedProductCard?.dataset.productId // Adiciona o ID para produtos especiais
                     };
                     // Manter compatibilidade com a estrutura antiga de 'state' para tamanho, embora agora redundante
                     state.size = (productType === 'acai' && selectedProductCard?.dataset.price) ? `${productName} - R$ ${productPrice.toFixed(2).replace('.', ',')}` : undefined;


                     if (productType === 'acai') {
                         console.log("Tipo de produto: A√ßa√≠. Habilitando op√ß√µes de a√ßa√≠.");
                         // Habilita fieldsets de a√ßa√≠ e configura limites baseados no tamanho
                         let frutasMax = 0, cremesMax = 0, accompMax = 0, coberturaMax = 0;
                         if (productName.startsWith('Copo Pequeno')) { frutasMax = 1; cremesMax = 1; accompMax = 3; coberturaMax = 1; }
                         else if (productName.startsWith('Copo Grande')) { frutasMax = 2; cremesMax = 2; accompMax = 3; coberturaMax = 1; }
                         else if (productName.startsWith('Pote da Felicidade')) { frutasMax = 3; cremesMax = 3; accompMax = 4; coberturaMax = 2; }

                         state.fMax = frutasMax; state.cMax = cremesMax; state.aMax = accompMax; state.coMax = coberturaMax; state.addMax = 14; // Adicionais sempre 14 para a√ßa√≠

                         enable(fs.frutas); enable(fs.cremes); enable(fs.accomp); enable(fs.cover); enable(fs.askAdd);

                         // Desabilita explicitamente o fieldset de sabores do Copo da Felicidade
                         disable(fs.copoFelicidadeFlavors);
                         clearRadios('copoFelicidadeFlavor'); // Limpa sele√ß√£o de sabor do copo felicidade
                         state.selectedCopoFelicidadeFlavor = undefined; // Limpa o estado de sabor


                         // Configura e reseta checkboxes e contadores para a√ßa√≠
                         setupChecks('boxFrutas', frutasMax, 'frutas');
                         setupChecks('boxCremes', cremesMax, 'cremes');
                         setupChecks('boxAccomp', accompMax, 'accomp');
                         setupChecks('boxCoverage', coberturaMax, 'cover');
                         setupChecks('boxAdd', 14, 'add'); // Sempre 14 para adicionais de a√ßa√≠

                         updateCounter(cnt.frutas, state.frutas ? state.frutas.filter(item => item !== 'Nenhuma').length : 0, frutasMax);
                         updateCounter(cnt.cremes, state.cremes ? state.cremes.filter(item => item !== 'Nenhuma').length : 0, cremesMax);
                         updateCounter(cnt.accomp, state.accomp ? state.accomp.filter(item => item !== 'Nenhuma').length : 0, accompMax);
                         updateCounter(cnt.cover, state.cover ? state.cover.filter(item => item !== 'Nenhuma').length : 0, coberturaMax);
                         updateCounter(cnt.add, state.add ? state.add.filter(item => item !== 'Nenhum Adicional').length : 0, 14); // Reseta contador de adicionais

                         // Configura listener para r√°dios de a√ßa√≠ (wantAdd)
                         setupRadioListener('wantAdd', 'askAdd');


                     } else if (productType === 'produto_especial' && state.produtoPrincipal.id === 'copo_felicidade') {
                          console.log("Tipo de produto: Copo da Felicidade. Habilitando sele√ß√£o de sabor.");
                         // Desabilita fieldsets de a√ßa√≠ e adicionais
                         disableAllDependentFieldsets(); // J√° limpa e desabilita tudo de a√ßa√≠/adicionais

                         // Habilita o fieldset de sele√ß√£o de sabor do Copo da Felicidade
                         enable(fs.copoFelicidadeFlavors); // <--- ESTA LINHA HABILITA O FIELDSET

                         // As op√ß√µes de sabor s√£o radios e j√° tiveram seus listeners configurados em renderCopoFelicidadeFlavors
                         // Nada mais a configurar aqui, apenas garantir que o fieldset foi habilitado.

                         // Habilita os fieldsets de pagamento e entrega (obrigat√≥rios para qualquer pedido)
                         enable(fs.payment);
                         enable(fs.delivery);

                         // Listeners para pagamento e entrega j√° configurados em fetchAndApplyItemAvailability

                     }

                     checkIfCanFinish(); // Verifica se os bot√µes de a√ß√£o podem ser habilitados ap√≥s a mudan√ßa
                 };

                 radio.addEventListener('change', newProductListener);
                 radio._productListener = newProductListener; // Armazena o listener para remo√ß√£o futura
             });
         }


        // Adapta a fun√ß√£o setupRadioListener para lidar com o novo nome 'produtoPrincipal'
        // e os novos est√°gios ('paymentSelected', 'deliverySelected', 'copoFelicidadeFlavorSelected')
        function setupRadioListener(name, stageToAdvance) {
             document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                 // Remove listeners antigos para evitar duplica√ß√£o
                 if (r._currentListener) {
                      r.removeEventListener('change', r._currentListener);
                 }

                 // Adiciona novo listener
                 const new_listener = ev => {
                     state[name] = ev.target.value;
                     console.log(`R√°dio "${name}" alterado. Valor: ${ev.target.value}. Estado:`, state); // Log para debug

                     // L√≥gica visual de sele√ß√£o para R√°dios (geral)
                     document.querySelectorAll(`input[name="${name}"]`).forEach(radioEl => {
                         radioEl.closest('label')?.classList.remove('selected-radio');
                     });
                     ev.target.closest('label')?.classList.add('selected-radio');

                     // L√≥gica espec√≠fica para o Copo da Felicidade (sabor)
                     if (name === 'copoFelicidadeFlavor') {
                         state.selectedCopoFelicidadeFlavor = ev.target.value; // Salva o sabor selecionado
                         console.log("Sabor Copo da Felicidade selecionado:", state.selectedCopoFelicidadeFlavor); // Log para debug
                         // N√£o h√° um est√°gio "pr√≥ximo" after selecionar sabor, apenas verifica se pode finalizar
                     } else if (name === 'wantAdd') {
                          // L√≥gica para habilitar/desabilitar adicionais j√° est√° em advance('askAdd')
                          advance(stageToAdvance);
                     }
                      // Para payment e delivery, a simples sele√ß√£o j√° √© o suficiente para verificar se pode finalizar
                      // A chamada checkIfCanFinish() abaixo j√° faz isso.


                     // L√≥gica para mostrar/ocultar info PIX (apenas para o r√°dio 'payment')
                     if (name === 'payment') {
                         if (pixInfoDiv) {
                             if (ev.target.value === 'Pix' && ev.target.checked) {
                                 pixInfoDiv.classList.remove('hidden');
                             } else {
                                 pixInfoDiv.classList.add('hidden');
                             }
                         }
                     }


                     checkIfCanFinish(); // Verifica se os bot√µes podem ser habilitados ap√≥s qualquer mudan√ßa de r√°dio
                 };

                 r.addEventListener('change', new_listener);
                 r._currentListener = new_listener; // Armazena o listener para poder remover depois

             });
         }


        function setupChecks(containerId, max, key) {
             const box = document.getElementById(containerId);
             if (!box) return;
             const counterEl = cnt[key];
             const allCheckboxesInBox = box.querySelectorAll('input[type=checkbox]');
             const noneCheckbox = box.querySelector(`input[value="${key === 'add' ? 'Nenhum Adicional' : 'Nenhuma'}"]`); // 'Nenhuma' ou 'Nenhum Adicional'

             // Inicializa ou filtra state[key] removendo itens desabilitados
             if (!state[key]) state[key] = [];
              state[key] = state[key].filter(itemName => {
                  const chk = Array.from(allCheckboxesInBox).find(c => c.value === itemName);
                  return chk && !chk.disabled; // Mant√©m no estado apenas itens selecionados que N√ÉO est√£o desabilitados
              });


             // Atualiza contador inicial com base nos itens N√ÉO desabilitados
             const initialCount = state[key].includes(key === 'add' ? 'Nenhum Adicional' : 'Nenhuma') ? 0 : state[key].filter(item => item !== (key === 'add' ? 'Nenhum Adicional' : 'Nenhuma')).length;
             updateCounter(counterEl, initialCount, max);


             allCheckboxesInBox.forEach(chk => {
                 // Remove listeners antigos para evitar duplica√ß√£o
                 if (chk._currentListener) {
                     chk.removeEventListener('change', chk._currentListener);
                 }

                 // Adiciona novo listener
                 const new_listener = () => {
                      console.log(`Checkbox "${chk.value}" (${key}) alterado. Checado: ${chk.checked}. Desabilitado: ${chk.disabled}`); // Log para debug

                     // Se o checkbox estiver desabilitado (por indisponibilidade ou fieldset), n√£o faz nada
                     // A verifica√ß√£o de 'disabled' no listener j√° √© feita pelo browser, mas vamos garantir
                     if (chk.disabled && !chk.value.toLowerCase().includes("nenhuma") && !chk.value.toLowerCase().includes("nenhum adicional")) {
                         console.log(`Checkbox "${chk.value}" (${key}) desabilitado. Ignorando clique.`);
                         return;
                     }


                     const currentSelectedInBox = [...box.querySelectorAll('input[type=checkbox]:checked:not([disabled])')]; // Considera apenas checkboxes checados E N√ÉO desabilitados
                     let isNoneChecked = noneCheckbox && noneCheckbox.checked;
                     const noneValue = key === 'add' ? 'Nenhum Adicional' : 'Nenhuma';

                     if (noneCheckbox) {
                         if (chk === noneCheckbox && chk.checked) {
                             console.log(`Op√ß√£o "${noneValue}" selecionada. Desmarcando outros.`); // Log para debug
                             // Se "Nenhuma" foi marcado, desmarca todos os outros na caixa (se n√£o estiverem desabilitados)
                             allCheckboxesInBox.forEach(otherChk => {
                                 if (otherChk !== noneCheckbox && !otherChk.disabled) otherChk.checked = false;
                             });
                             state[key] = [noneValue];
                             isNoneChecked = true;
                         } else if (chk !== noneCheckbox && chk.checked && isNoneChecked) {
                              console.log(`Outro item selecionado (${chk.value}) enquanto "${noneValue}" estava checado. Desmarcando "${noneValue}".`); // Log para debug
                             // Se outro item foi marcado enquanto "Nenhuma" estava marcado, desmarca "Nenhuma" (se n√£o estiver desabilitado)
                              if (!noneCheckbox.disabled) noneCheckbox.checked = false;
                             isNoneChecked = false;
                             // Atualiza o estado com os itens selecionados (excluindo "Nenhuma")
                             state[key] = currentSelectedInBox.filter(c => c !== noneCheckbox).map(i => i.value);
                         } else {
                              console.log(`Atualizando sele√ß√£o para "${key}".`); // Log para debug
                              // Atualiza o estado com os itens selecionados (excluindo 'Nenhuma' se outros estiverem marcados)
                              state[key] = currentSelectedInBox.filter(c => c !== noneCheckbox || !(noneCheckbox && noneCheckbox.checked)).map(i => i.value);

                              // Se nada ficou selecionado E a op√ß√£o "Nenhuma" existe E n√£o est√° desabilitada, marca "Nenhuma"
                              if (state[key].length === 0 && noneCheckbox && !noneCheckbox.disabled) {
                                   console.log(`Nenhum item selecionado, marcando "${noneValue}".`); // Log para debug
                                   noneCheckbox.checked = true;
                                   state[key] = [noneValue];
                              } else if (state[key].length > 0 && noneCheckbox && !noneCheckbox.disabled) {
                                   // Se algo foi selecionado, desmarca "Nenhuma" (caso n√£o tenha sido desmarcado antes e n√£o esteja desabilitado)
                                    if (noneCheckbox.checked) {
                                         console.log(`Itens selecionados, desmarcando "${noneValue}".`); // Log para debug
                                         noneCheckbox.checked = false;
                                     }
                              }
                         }
                     } else { // N√£o h√° op√ß√£o "Nenhuma" nesta caixa
                          console.log(`Atualizando sele√ß√£o para "${key}" (sem op√ß√£o "Nenhuma").`); // Log para debug
                         state[key] = currentSelectedInBox.map(i => i.value);
                     }


                     const actualSelectedCount = state[key].includes(noneValue) ? 0 : state[key].filter(item => item !== noneValue).length;
                      console.log(`Sele√ß√£o atualizada para "${key}":`, state[key], `Contagem: ${actualSelectedCount}`); // Log para debug


                     // Verifica o limite m√°ximo (apenas para categorias que t√™m limite)
                     if (max !== undefined && actualSelectedCount > max) {
                         console.log(`Limite de ${max} para "${key}" excedido (${actualSelectedCount}). Desmarcando √∫ltimo.`); // Log para debug
                         chk.checked = false; // Desmarca o √∫ltimo item clicado se exceder o limite
                          // Re-calcula o estado ap√≥s desmarcar
                          state[key] = [...box.querySelectorAll('input[type=checkbox]:checked:not([disabled])')].filter(c => c !== noneCheckbox || !(noneCheckbox && noneCheckbox.checked)).map(i => i.value);
                           if (state[key].length === 0 && noneCheckbox && noneCheckbox.checked) state[key] = [noneValue];

                         const finalCountAfterLimit = state[key].includes(noneValue) ? 0 : state[key].filter(item => item !== noneValue).length;
                         updateCounter(counterEl, finalCountAfterLimit, max);
                         alert(`M√°ximo ${max} ${key === 'add' ? 'adicionais' : key}.`);
                         return; // Sai da fun√ß√£o onchange ap√≥s o alerta
                     }

                     updateCounter(counterEl, actualSelectedCount, max);
                     checkIfCanFinish(); // Verifica se os bot√µes podem ser habilitados
                 };

                 chk.addEventListener('change', new_listener);
                 chk._currentListener = new_listener; // Armazena o listener
             });
         }

         // Adapta updateCounter para lidar com "Nenhum Adicional" nos adicionais
        function updateCounter(element, count, max) {
             if (element) {
                 const categoryKey = element.id.replace('cnt', '').toLowerCase();
                 let displayCount = count;
                 // A contagem real para exibi√ß√£o √© a quantidade de itens marcados que N√ÉO s√£o a op√ß√£o "Nenhuma"/"Nenhum Adicional"
                 // A l√≥gica na fun√ß√£o setupChecks j√° calcula isso e passa a 'actualSelectedCount'.
                 // Aqui apenas exibimos o valor passado.
                 const displayMax = max !== undefined ? max : '?';
                 element.textContent = `( ${displayCount} / ${displayMax} )`;
                 element.style.display = 'inline';
             }
         }


        // Adapta a fun√ß√£o advance para lidar com novos est√°gios (paymentSelected, deliverySelected)
         function advance(stage) {
              console.log("Avan√ßando est√°gio:", stage, "State:", state); // Log para debug
             switch (stage) {
                 case 'askAdd':
                     // L√≥gica original para habilitar/desabilitar adicionais baseada na escolha Sim/N√£o
                     if (state.wantAdd === 'Sim') {
                         enable(fs.add);
                         // Limpa e configura checks para adicionais APENAS se habilitando
                         setupChecks('boxAdd', state.addMax, 'add');
                          // Garante que o contador de adicionais est√° correto ap√≥s (re)habilitar
                          const currentAddCount = state.add ? state.add.filter(item => item !== 'Nenhum Adicional').length : 0;
                         updateCounter(cnt.add, currentAddCount, state.addMax);
                     } else if (state.wantAdd === 'N√£o') {
                         state.add = ['Nenhum Adicional']; // Define o estado como "Nenhum Adicional"
                         disable(fs.add); // Desabilita o fieldset de adicionais
                         clearCheckboxes(fs.add); // Limpa os checkboxes (visualmente)
                          updateCounter(cnt.add, 0, state.addMax); // Zera o contador visualmente
                     }
                      // Payment e Delivery s√£o habilitados independentemente da escolha Sim/N√£o Adicionais,
                      // desde que o produto principal seja A√ßa√≠.
                      // Se for Copo Felicidade, Payment/Delivery j√° s√£o habilitados na sele√ß√£o do produto.
                      if (state.produtoPrincipal?.type === 'acai') {
                           enable(fs.payment);
                           // O pixInfoDiv √© mostrado/ocultado pelo listener direto no input[name="payment"]
                           enable(fs.delivery);
                      }
                     break;
                 // N√£o h√° a√ß√µes adicionais espec√≠ficas para 'paymentSelected' ou 'deliverySelected' na l√≥gica de advance.
                 // Apenas a sele√ß√£o j√° permite que checkIfCanFinish habilite os bot√µes.
                 case 'paymentSelected':
                     // checkIfCanFinish() ser√° chamada ap√≥s este switch
                     break;
                 case 'deliverySelected':
                     // checkIfCanFinish() ser√° chamada ap√≥s este switch
                     break;
                 case 'copoFelicidadeFlavorSelected':
                      // checkIfCanFinish() ser√° chamada ap√≥s este switch
                      break;
             }
         }


        // Adapta a fun√ß√£o checkIfCanFinish para lidar com o Copo da Felicidade
         function checkIfCanFinish() {
             console.log("Verificando se pode finalizar/adicionar. State:", state); // Log para debug

             // Verifica se um produto principal foi selecionado
             const isProdutoPrincipalSelected = state.produtoPrincipal && state.produtoPrincipal.type;
             if (!isProdutoPrincipalSelected) {
                 console.log("Produto principal n√£o selecionado."); // Log para debug
                 btnAdd.disabled = true;
                 btnFinish.disabled = true;
                 return;
             }

             let itemSpecificValidity = false; // Valida√ß√£o espec√≠fica para o tipo de item

             if (state.produtoPrincipal.type === 'acai') {
                  console.log("Validando A√ßa√≠."); // Log para debug
                 // L√≥gica de valida√ß√£o para A√ßa√≠ (requer sele√ß√£o de frutas, cremes, etc. se fieldset habilitado)
                 // As fun√ß√µes setupChecks j√° garantem os limites m√°ximos, aqui apenas verificamos se *alguma* op√ß√£o foi escolhida
                 // dentro dos fieldsets habilitados (incluindo a op√ß√£o 'Nenhuma').
                 const checkSectionValidity = (fieldset, categoryKey) => {
                     // Se o fieldset est√° desabilitado (ex: pelo tamanho selecionado), ele √© v√°lido por padr√£o
                     if (!fieldset || fieldset.hasAttribute('disabled')) {
                          console.log(`Fieldset "${fieldset?.id}" desabilitado. V√°lido.`); // Log para debug
                          return true;
                     }

                     const items = state[categoryKey];
                     // Deve haver itens selecionados (mesmo que seja 'Nenhuma' ou 'Nenhum Adicional')
                      const isValid = items && items.length > 0;
                      console.log(`Fieldset "${fieldset.id}" habilitado. Sele√ß√£o (${categoryKey}):`, items, `V√°lido: ${isValid}`); // Log para debug
                      return isValid;
                 };

                  // Verifica a validade dos fieldsets de a√ßa√≠ SE eles estiverem habilitados
                 const frutasOk = checkSectionValidity(fs.frutas, 'frutas');
                 const cremesOk = checkSectionValidity(fs.cremes, 'cremes');
                 const accompOk = checkSectionValidity(fs.accomp, 'accomp');
                 const coverOk = checkSectionValidity(fs.cover, 'cover');


                 let addOk = true;
                 // Verifica adicionais APENAS se o fieldset 'Deseja adicionais?' est√° habilitado
                 if (!fs.askAdd.hasAttribute('disabled')) {
                     console.log(`Fieldset "Deseja adicionais?" habilitado. State.wantAdd:`, state.wantAdd); // Log para debug
                      // Se "Deseja adicionais?" est√° habilitado, √© obrigat√≥rio escolher Sim ou N√£o
                     if (state.wantAdd === undefined) {
                          console.log("Escolha de adicionais pendente."); // Log para debug
                          addOk = false; // Nada selecionado ainda
                     } else if (state.wantAdd === 'Sim') {
                          // Se "Sim" foi escolhido, valida o fieldset de adicionais (que deve estar habilitado)
                         addOk = checkSectionValidity(fs.add, 'add');
                     } else if (state.wantAdd === 'N√£o') {
                         // Se "N√£o" foi escolhido, adicionais est√£o ok
                          console.log("Escolheu 'N√£o' para adicionais. V√°lido."); // Log para debug
                         addOk = true;
                     }
                 } else {
                      // Se "Deseja adicionais?" est√° desabilitado (porque o produto n√£o permite), √© v√°lido
                       console.log("Fieldset 'Deseja adicionais?' desabilitado. V√°lido por padr√£o."); // Log para debug
                      addOk = true;
                 }


                 itemSpecificValidity = frutasOk && cremesOk && accompOk && coverOk && addOk;
                 console.log("Validade espec√≠fica do item (A√ßa√≠):", itemSpecificValidity); // Log para debug

             } else if (state.produtoPrincipal.type === 'produto_especial' && state.produtoPrincipal.id === 'copo_felicidade') {
                  console.log("Validando Copo da Felicidade."); // Log para debug
                 // L√≥gica de valida√ß√£o para Copo da Felicidade (requer sele√ß√£o de sabor)
                 // E garantimos que os fieldsets de a√ßa√≠/adicionais est√£o desabilitados.
                 const isFlavorSelected = state.selectedCopoFelicidadeFlavor !== undefined; // Verifica se o sabor foi selecionado
                  console.log("Sabor Copo da Felicidade selecionado?", isFlavorSelected, "Sabor:", state.selectedCopoFelicidadeFlavor); // Log para debug

                 // Os fieldsets de a√ßa√≠ e adicionais devem estar desabilitados.
                 // A fun√ß√£o de sele√ß√£o do produto principal (`setupProdutoPrincipalListeners`) j√° cuida de desabilit√°-los
                 // ao selecionar o Copo da Felicidade. Podemos verificar se eles est√£o de fato desabilitados
                 // como uma camada extra de seguran√ßa, mas a valida√ß√£o principal √© a sele√ß√£o do sabor.
                 const acaiFieldsetsDisabled = fs.frutas.hasAttribute('disabled') &&
                                                fs.cremes.hasAttribute('disabled') &&
                                                fs.accomp.hasAttribute('disabled') &&
                                                fs.cover.hasAttribute('disabled') &&
                                                fs.askAdd.hasAttribute('disabled') &&
                                                fs.add.hasAttribute('disabled');

                 itemSpecificValidity = isFlavorSelected; // A valida√ß√£o principal √© apenas a sele√ß√£o do sabor
                  console.log("Validade espec√≠fica do item (Copo Felicidade):", itemSpecificValidity); // Log para debug
             } else {
                 console.warn("Tipo de produto desconhecido no state:", state.produtoPrincipal); // Log para debug
                 itemSpecificValidity = false;
             }


             // Verifica se pagamento e entrega foram selecionados (obrigat√≥rios para qualquer pedido)
             const isPaymentAndDeliverySelected = state.payment !== undefined && state.delivery !== undefined;
              console.log("Pagamento selecionado?", state.payment !== undefined, "Entrega selecionada?", state.delivery !== undefined, "Pagamento/Entrega Ok:", isPaymentAndDeliverySelected); // Log para debug


             // Habilita os bot√µes APENAS se a valida√ß√£o espec√≠fica do item atual E as op√ß√µes de pagamento/entrega estiverem ok
             if (isProdutoPrincipalSelected && itemSpecificValidity && isPaymentAndDeliverySelected) {
                  console.log("Tudo ok. Habilitando bot√µes Adicionar e Finalizar."); // Log para debug
                 btnAdd.disabled = false;
                 btnFinish.disabled = false;
             } else {
                  console.log("N√£o pronto. Desabilitando bot√µes."); // Log para debug
                 btnAdd.disabled = true;
                 btnFinish.disabled = true;
             }
         }


        // Adapta renderOrders para exibir Copo da Felicidade
        function renderOrders() {
             console.log("Renderizando pedidos:", orders); // Log para debug
            ordersSec.style.display = orders.length > 0 ? 'block' : 'none';
            ordersList.innerHTML = '';
            let totalGeralPedidosPagina = 0;
            let taxaEntregaPagina = 0;
            let localEntregaPagina = "Retirada"; // Valor padr√£o antes de processar pedidos

            orders.forEach((o, i) => {
                const li = document.createElement('li');
                let itemDetailsHtml = ''; // HTML para os detalhes do item (frutas, cremes OU sabor)
                let subTotalPedidoItem = 0; // Subtotal deste item espec√≠fico (produto base + adicionais extras)

                // Verifica o tipo de item para renderizar os detalhes corretamente
                if (o.produtoPrincipal && o.produtoPrincipal.type === 'produto_especial' && o.produtoPrincipal.id === 'copo_felicidade') {
                     // √â um Copo da Felicidade
                     itemDetailsHtml += `Sabor: ${o.selectedCopoFelicidadeFlavor || 'N√£o especificado'}`;
                     subTotalPedidoItem = o.produtoPrincipal.price; // Pre√ßo base fixo

                     // Adicionais (se aplicam como extras para Copo da Felicidade)
                     // Note: No Copo da Felicidade, adicionais s√£o extras e somam ao pre√ßo fixo.
                     // Na√ßa√≠, adicionais somam ao pre√ßo do tamanho.
                     if (o.add && o.add.length > 0 && !(o.add.length === 1 && (o.add[0] === 'Nenhuma' || o.add[0] === 'Nenhum Adicional'))) {
                          const adicionaisLista = o.add.map(item => {
                               // Assumimos que adicionais aqui s√£o os de R$ 1.00 (conforme items.json)
                               const parts = item.split(' - R$ ');
                               if (parts.length === 2) subTotalPedidoItem += parseFloat(parts[1].replace(',', '.')); // Adiciona o pre√ßo do adicional
                               return parts[0]; // Pega apenas o nome para exibir
                          }).join(', ');
                          itemDetailsHtml += `<br> Adicionais (Extras): ${adicionaisLista}`;
                     } else {
                         itemDetailsHtml += `<br> Adicionais (Extras): Nenhum Adicional`;
                     }


                     li.innerHTML = `
                         <strong>Pedido ${i + 1}:</strong><br>
                         Item: ${o.produtoPrincipal.name}<br>
                         ${itemDetailsHtml}<br>
                         Pagamento: ${o.payment || 'N/A'}<br>
                         Entrega/Retirada: ${o.delivery ? o.delivery.split(' - R$ ')[0] : 'N/A'}<br>
                         <strong>Total do Item: R$ ${subTotalPedidoItem.toFixed(2).replace('.', ',')}</strong>`;

                } else {
                     // √â um item de A√ßa√≠ tradicional (Copo Pequeno, Grande, Pote)
                    const displayFrutas = o.frutas?.length > 0 && !o.frutas.includes('Nenhuma') ? o.frutas.join(', ') : 'Nenhuma';
                    const displayCremes = o.cremes?.length > 0 && !o.cremes.includes('Nenhuma') ? o.cremes.join(', ') : 'Nenhum';
                    const displayAccomp = o.accomp?.length > 0 && !o.accomp.includes('Nenhuma') ? o.accomp.join(', ') : 'Nenhum';
                    const displayCover = o.cover?.length > 0 && !o.cover.includes('Nenhuma') ? o.cover.join(', ') : 'Nenhuma';

                     itemDetailsHtml += `Frutas: ${displayFrutas}<br>`;
                     itemDetailsHtml += `Cremes: ${displayCremes}<br>`;
                     itemDetailsHtml += `Acompanhamentos: ${displayAccomp}<br>`;
                     itemDetailsHtml += `Coberturas: ${displayCover}<br>`;

                     let displayAdd = 'Nenhum Adicional';
                     if (o.add && o.add.length > 0 && !(o.add.length === 1 && (o.add[0] === 'Nenhuma' || o.add[0] === 'Nenhum Adicional'))) {
                         displayAdd = o.add.map(item => item.split(' - R$ ')[0]).join(', ');
                         itemDetailsHtml += `Adicionais: ${displayAdd}<br>`;
                     } else {
                         itemDetailsHtml += `Adicionais: Nenhum Adicional<br>`;
                     }

                     // Calcula o subtotal do a√ßa√≠ (pre√ßo do tamanho + adicionais)
                     const priceMatch = o.size?.match(/R\$ (\d+[,.]\d{2})/);
                     subTotalPedidoItem = priceMatch ? parseFloat(priceMatch[1].replace(',', '.')) : 0;

                     // Adiciona o custo dos adicionais ao subtotal do a√ßa√≠
                     if (o.add && !(o.add.length === 1 && (o.add[0] === 'Nenhuma' || o.add[0] === 'Nenhum Adicional'))) {
                         o.add.forEach(addon => {
                             if (addon.includes('R$')) {
                                 const addonPriceMatch = addon.match(/R\$ (\d+[,.]\d{2})/);
                                 if (addonPriceMatch) subTotalPedidoItem += parseFloat(addonPriceMatch[1].replace(',', '.'));
                             }
                         });
                     }


                    li.innerHTML = `
                        <strong>Pedido ${i + 1}:</strong><br>
                        Tamanho: ${o.size ? o.size.split(' - R$ ')[0] : 'N/A'}<br>
                        ${itemDetailsHtml}
                        Pagamento: ${o.payment || 'N/A'}<br>
                        Entrega/Retirada: ${o.delivery ? o.delivery.split(' - R$ ')[0] : 'N/A'}<br>
                        <strong>Total do A√ßa√≠: R$ ${subTotalPedidoItem.toFixed(2).replace('.', ',')}</strong>`;
                }

                 totalGeralPedidosPagina += subTotalPedidoItem;

                // A taxa de entrega e o local s√£o baseados no PRIMEIRO pedido na lista (se houver delivery)
                if (i === 0 && o.delivery) {
                    localEntregaPagina = o.delivery.split(' - R$ ')[0];
                    if (o.delivery.includes('R$')) {
                        const deliveryPriceMatch = o.delivery.match(/R\$ (\d+[,.]\d{2})/);
                        if (deliveryPriceMatch) taxaEntregaPagina = parseFloat(deliveryPriceMatch[1].replace(',', '.'));
                    } else {
                         taxaEntregaPagina = 0; // Garante que a taxa √© 0 se n√£o contiver R$
                    }
                }
                ordersList.appendChild(li);
            });

            // Adiciona a taxa de entrega ao total geral APENAS UMA VEZ (baseado no primeiro pedido)
            if (orders.length > 0 && localEntregaPagina !== "Retirada" && taxaEntregaPagina > 0) {
                 console.log("Adicionando taxa de entrega ao total da p√°gina:", taxaEntregaPagina); // Log para debug
                totalGeralPedidosPagina += taxaEntregaPagina;
            } else if (orders.length > 0 && localEntregaPagina !== "Retirada" && taxaEntregaPagina === 0) {
                 console.log("Entrega selecionada, mas taxa 0. N√£o adicionando ao total da p√°gina."); // Log para debug
                 // Se for entrega mas a taxa for 0, n√£o soma.
             }


            if (orderPageTotalValueEl) orderPageTotalValueEl.textContent = totalGeralPedidosPagidosPagina.toFixed(2).replace('.', ',');
            console.log("Total geral na p√°gina atualizado:", totalGeralPedidosPagina); // Log para debug
        }

        // Adapta showSummary para incluir o Copo da Felicidade
         function showSummary() {
              console.log("Gerando resumo. Pedidos:", orders); // Log para debug
             let summaryText = "Novo Pedido Blue A√ßa√≠!\n\n";
             let totalGeral = 0;
             let deliveryFee = 0;
             let deliveryLocation = "Retirada";
             let metodoPagamento = "N√£o especificado"; // Para pegar o pagamento do primeiro item

             orders.forEach((o, i) => {
                 let totalPricePedido = 0; // Total deste item espec√≠fico

                 summaryText += `*Pedido ${i + 1}:*\n`;

                 // Verifica o tipo de item para formatar o resumo
                 if (o.produtoPrincipal && o.produtoPrincipal.type === 'produto_especial' && o.produtoPrincipal.id === 'copo_felicidade') {
                      // √â um Copo da Felicidade
                      summaryText += `Item: ${o.produtoPrincipal.name}\n`;
                      summaryText += `Sabor: ${o.selectedCopoFelicidadeFlavor || 'N√£o especificado'}\n`;
                      totalPricePedido = o.produtoPrincipal.price; // Pre√ßo base

                      // Adicionais (se aplicam como extras)
                      if (o.add && o.add.length > 0 && !(o.add.length === 1 && (o.add[0] === 'Nenhuma' || o.add[0] === 'Nenhum Adicional'))) {
                           const adicionaisLista = o.add.map(item => {
                                // Assumimos que adicionais aqui s√£o os de R$ 1.00
                                const parts = item.split(' - R$ ');
                                if (parts.length === 2) totalPricePedido += parseFloat(parts[1].replace(',', '.')); // Adiciona o pre√ßo
                                return parts[0]; // Pega apenas o nome
                           }).join(', ');
                           summaryText += `Adicionais (Extras): ${adicionaisLista}\n`;
                      } else {
                           summaryText += `Adicionais: Nenhum Adicional\n`;
                      }


                 } else {
                      // √â um item de A√ßa√≠ tradicional
                      summaryText += `Tamanho: ${o.size ? o.size.split(' - R$ ')[0] : 'N/A'}\n`;

                      const displayFrutas = o.frutas?.length > 0 && !o.frutas.includes('Nenhuma') ? o.frutas.join(', ') : 'Nenhuma';
                      const displayCremes = o.cremes?.length > 0 && !o.cremes.includes('Nenhuma') ? o.cremes.join(', ') : 'Nenhum';
                      const displayAccomp = o.accomp?.length > 0 && !o.accomp.includes('Nenhuma') ? o.accomp.join(', ') : 'Nenhum';
                      const displayCover = o.cover?.length > 0 && !o.cover.includes('Nenhuma') ? o.cover.join(', ') : 'Nenhuma';
                      let displayAdd = 'Nenhum Adicional';

                      summaryText += `Frutas: ${displayFrutas}\n`;
                      summaryText += `Cremes: ${displayCremes}\n`;
                      summaryText += `Acompanhamentos: ${displayAccomp}\n`;
                      summaryText += `Coberturas: ${displayCover}\n`;

                      if (o.add && o.add.length > 0 && !(o.add.length === 1 && (o.add[0] === 'Nenhuma' || o.add[0] === 'Nenhum Adicional'))) {
                          displayAdd = o.add.map(item => item.split(' - R$ ')[0]).join(', ');
                          summaryText += `Adicionais: ${displayAdd}\n`;
                      } else {
                           summaryText += `Adicionais: Nenhum Adicional\n`;
                      }

                      const priceMatch = o.size?.match(/R\$ (\d+[,.]\d{2})/);
                      totalPricePedido = priceMatch ? parseFloat(priceMatch[1].replace(',', '.')) : 0;

                      // Adiciona o custo dos adicionais
                     if (o.add && !(o.add.length === 1 && (o.add[0] === 'Nenhuma' || o.add[0] === 'Nenhum Adicional'))) {
                          o.add.forEach(addon => {
                              if (addon.includes('R$')) {
                                  const addonPriceMatch = addon.match(/R\$ (\d+[,.]\d{2})/);
                                  if (addonPriceMatch) totalPricePedido += parseFloat(addonPriceMatch[1].replace(',', '.'));
                              }
                          });
                      }
                 }

                 totalGeral += totalPricePedido; // Adiciona o total do item ao total geral

                  // Pagamento e Entrega/Retirada s√£o do pedido GERAL, pegamos do primeiro item
                  if(i === 0) {
                      metodoPagamento = o.payment || 'N/A';
                      deliveryLocation = o.delivery ? o.delivery.split(' - R$ ')[0] : 'N/A';
                       if (o.delivery && o.delivery.includes('R$')) {
                           const deliveryPriceMatch = o.delivery.match(/R\$ (\d+[,.]\d{2})/);
                           if (deliveryPriceMatch) deliveryFee = parseFloat(deliveryPriceMatch[1].replace(',', '.'));
                       } else {
                           deliveryFee = 0; // Garante que a taxa √© 0 se n√£o contiver R$
                       }
                  }

                 summaryText += `Pagamento: ${o.payment || 'N/A'}\n`; // Inclui pagamento por item no resumo detalhado
                 summaryText += `Entrega/Retirada: ${o.delivery ? o.delivery.split(' - R$ ')[0] : 'N/A'}\n`; // Inclui entrega por item
                 summaryText += `*Total do Item: R$ ${totalPricePedido.toFixed(2).replace('.', ',')}*\n\n`;

             });

             // Adiciona a taxa de entrega ao total geral APENAS UMA VEZ (se aplic√°vel e se houver pedidos)
             if (orders.length > 0 && deliveryLocation !== "Retirada" && deliveryFee > 0) {
                 totalGeral += deliveryFee;
                 summaryText += `*Taxa de Entrega (${deliveryLocation}): R$ ${deliveryFee.toFixed(2).replace('.', ',')}*\n\n`;
             } else if (orders.length > 0 && deliveryLocation !== "Retirada" && deliveryFee === 0) {
                  summaryText += `*Forma de Recebimento: ${deliveryLocation} (Taxa a combinar ou inclusa)*\n\n`; // Melhorar a mensagem se a taxa for 0 mas for entrega
             } else if (orders.length > 0) {
                 summaryText += `*Forma de Recebimento: Retirada*\n\n`;
             }


             summaryText += `*Total Geral do Pedido: R$ ${totalGeral.toFixed(2).replace('.', ',')}*\n\n`;
             summaryEl.textContent = summaryText;
              console.log("Resumo gerado:", summaryText); // Log para debug
         }


         // Adapta√ß√£o da fun√ß√£o de envio do pedido para o servidor
         // Esta fun√ß√£o agora lida com a adi√ß√£o do item atual SE n√£o foi adicionado ainda
        btnAdd.onclick = () => {
             console.log("Clicou em Adicionar Outro Pedido. State atual:", state); // Log para debug
            if (isOrderReadyToAdd()) {
                 console.log("Pedido atual pronto para adicionar."); // Log para debug
                 // Adiciona o pedido atual ao array de pedidos
                 orders.push({ ...state }); // Copia o estado atual para o array de pedidos
                 console.log("Pedido adicionado. Pedidos:", orders); // Log para debug

                 renderOrders(); // Atualiza a lista visual de pedidos na p√°gina

                 // Reseta o formul√°rio para o pr√≥ximo pedido, mas mant√©m payment/delivery selecionados
                 resetPartial();
                 document.querySelectorAll('.produto-card').forEach(label => label.classList.remove('selected')); // Limpa a sele√ß√£o visual do card

             } else {
                 console.log("Pedido atual n√£o pronto para adicionar."); // Log para debug
                 alert("Por favor, preencha todas as etapas obrigat√≥rias para o item atual.");
             }
         };

         // Esta fun√ß√£o agora lida com a adi√ß√£o do √∫ltimo item (se n√£o adicionado) e o envio final
        btnFinish.onclick = async () => {
             console.log("Clicou em Finalizar e Enviar. State atual:", state, "Pedidos:", orders); // Log para debug
            // Verifica se o pedido atual est√° pronto para adicionar e se ele n√£o foi adicionado ainda
            // Isso lida com o cen√°rio onde o cliente preenche um item e clica direto em Finalizar
            if (isOrderReadyToAdd()) {
                 // Verifica se o pedido atual j√° √© o √∫ltimo na lista 'orders' para evitar duplica√ß√£o
                 const lastOrder = orders.length > 0 ? orders[orders.length - 1] : null;
                 // Criar uma c√≥pia limpa do estado para compara√ß√£o, excluindo propriedades n√£o essenciais para identifica√ß√£o √∫nica do item
                 const cleanState = (s) => {
                      if (!s) return null;
                      const clean = { ...s };
                      // Remover propriedades que n√£o definem unicamente o item (limites, estado de inputs, etc.)
                      delete clean.fMax; delete clean.cMax; delete clean.aMax; delete clean.coMax; delete clean.addMax;
                      // Remover payment e delivery pois se aplicam ao pedido geral, n√£o ao item individual para compara√ß√£o
                      delete clean.payment; delete clean.delivery;
                       // Se for a√ßa√≠, comparar por tamanho e sele√ß√µes. Se for produto especial, comparar por id e sabor.
                       if (clean.produtoPrincipal?.type === 'acai') {
                            delete clean.produtoPrincipal; // Usar o 'size' antigo para compatibilidade na compara√ß√£o se for a√ßa√≠
                       } else if (clean.produtoPrincipal?.type === 'produto_especial') {
                             // Comparar por productPrincipal.id e selectedFlavor
                             // Manter essas propriedades no clean object
                       }
                      return clean;
                 };
                 const currentStateClean = cleanState(state);
                 const lastOrderClean = cleanState(lastOrder);

                 // Comparar a vers√£o limpa do estado atual com a vers√£o limpa do √∫ltimo pedido adicionado
                 if (!lastOrderClean || JSON.stringify(currentStateClean) !== JSON.stringify(lastOrderClean)) {
                     console.log("Pedido atual pronto e diferente do √∫ltimo adicionado. Adicionando antes de finalizar."); // Log para debug
                      orders.push({ ...state }); // Adiciona o pedido atual
                 } else {
                     console.log("Pedido atual pronto, mas duplicado do √∫ltimo adicionado. N√£o adicionando novamente."); // Log para debug
                 }
             } else if (orders.length === 0) {
                  console.log("Nenhum pedido na lista e o formul√°rio atual n√£o est√° completo."); // Log para debug
                  alert("Por favor, preencha pelo menos um pedido antes de finalizar.");
                  return; // Sai se n√£o houver pedidos e o formul√°rio atual n√£o estiver completo
             } else {
                  console.log("H√° pedidos na lista, mas o formul√°rio atual N√ÉO est√° completo. Finalizando com os pedidos existentes."); // Log para debug
                  // Permite finalizar com os pedidos que J√Å foram adicionados, mesmo que o formul√°rio atual esteja incompleto.
                  // Se voc√™ quiser OBRIGAR que o formul√°rio atual esteja completo antes de finalizar, remova este 'else'.
             }


            // Se chegamos aqui, significa que h√° pelo menos um pedido no array 'orders'.
            if (orders.length > 0) {
                 console.log("Iniciando processo de envio. Pedidos a enviar:", orders); // Log para debug
                renderOrders(); // Garante que a lista final na p√°gina est√° atualizada
                showSummary(); // Gera o resumo final para WhatsApp e Admin

                const phoneNumber = '5598985016035'; // Seu n√∫mero de telefone
                const encodedText = encodeURIComponent(summaryEl.textContent);
                const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedText}`;

                try {
                    let pedidoCompletoParaServidor = [];
                    let valorTotalGeralServidor = 0;
                    // As informa√ß√µes de pagamento e entrega s√£o do √∫ltimo item preenchido,
                    // mas idealmente deveriam ser selecionadas UMA VEZ para o pedido GERAL.
                    // Como a UI permite selecionar por item, vamos pegar do PRIMEIRO item adicionado
                    // para enviar ao servidor, pois √© o comportamento mais coerente com a estrutura do servidor.
                    const infoEntregaPrimeiroPedido = orders[0]?.delivery; // Pega a entrega do primeiro pedido
                    const metodoPagamentoPrimeiroPedido = orders[0]?.payment; // Pega o pagamento do primeiro pedido

                    let taxaEntregaServidor = 0;
                     if (infoEntregaPrimeiroPedido && infoEntregaPrimeiroPedido.includes('R$')) {
                         const matchTaxa = infoEntregaPrimeiroPedido.match(/R\$ (\d+[,.]\d{2})/);
                         if (matchTaxa) taxaEntregaServidor = parseFloat(matchTaxa[1].replace(',', '.'));
                     }


                    orders.forEach(order => {
                         let subtotalPedidoItem = 0; // Subtotal deste item espec√≠fico

                         // Monta o objeto do item para enviar ao servidor
                         let itemParaServidor = {};

                         if (order.produtoPrincipal && order.produtoPrincipal.type === 'produto_especial' && order.produtoPrincipal.id === 'copo_felicidade') {
                             // Item √© um Copo da Felicidade
                             itemParaServidor.itemType = 'produto_especial'; // Novo campo para identificar
                             itemParaServidor.productId = order.produtoPrincipal.id;
                             itemParaServidor.name = order.produtoPrincipal.name;
                             itemParaServidor.selectedFlavor = order.selectedCopoFelicidadeFlavor || 'N√£o especificado'; // Inclui o sabor selecionado
                             subtotalPedidoItem = order.produtoPrincipal.price; // Pre√ßo base

                             // Processa adicionais (se adicionados acidentalmente ou como extras)
                              if (order.add && order.add.length > 0 && !(order.add.length === 1 && (order.add[0] === 'Nenhuma' || order.add[0] === 'Nenhum Adicional'))) {
                                   let adicionaisExtras = [];
                                  order.add.forEach(addon => {
                                      if (addon.includes('R$')) {
                                          const addonPriceMatch = addon.match(/R\$ (\d+[,.]\d{2})/);
                                          if (addonPriceMatch) subtotalPedidoItem += parseFloat(addonPriceMatch[1].replace(',', '.'));
                                      }
                                      adicionaisExtras.push(addon.split(' - R$ ')[0]); // Pega apenas o nome
                                  });
                                   // Adiciona os adicionais extras como um campo separado ou junto ao nome/sabor se preferir
                                   itemParaServidor.adicionaisExtras = adicionaisExtras.join(', ');
                              } else {
                                  itemParaServidor.adicionaisExtras = 'Nenhum Adicional';
                              }


                         } else {
                             // Item √© um A√ßa√≠ tradicional
                              // Usar o state.produtoPrincipal para pegar o nome do tamanho, se existir
                             itemParaServidor.tamanho = order.produtoPrincipal?.name || (order.size ? order.size.split(' - R$ ')[0] : 'A√ßa√≠ (Tamanho n√£o especificado)');

                             itemParaServidor.frutas = order.frutas?.includes('Nenhuma') ? 'Nenhuma' : (order.frutas?.join(', ') || 'Nenhuma');
                             itemParaServidor.cremes = order.cremes?.includes('Nenhuma') ? 'Nenhuma' : (order.cremes?.join(', ') || 'Nenhum');
                             itemParaServamentos = order.accomp?.includes('Nenhuma') ? 'Nenhuma' : (order.accomp?.join(', ') || 'Nenhum'); // Corrigido typo 'acompanhamentos'
                             itemParaServidor.coberturas = order.cover?.includes('Nenhuma') ? 'Nenhuma' : (order.cover?.join(', ') || 'Nenhuma');

                             let adicionaisFormatados = 'Nenhum Adicional';
                             if (order.add && order.add.length > 0 && !(order.add.length === 1 && (order.add[0] === 'Nenhuma' || order.add[0] === 'Nenhum Adicional'))) {
                                adicionaisFormatados = order.add.map(item => {
                                     const parts = item.split(' - R$ ');
                                     // Calcula o subtotal do item (tamanho + adicionais)
                                     if (parts.length === 2) subtotalPedidoItem += parseFloat(parts[1].replace(',', '.'));
                                     return parts[0]; // Pega apenas o nome do adicional
                                 }).join(', ');
                             }
                              itemParaServidor.adicionais = adicionaisFormatados;

                              // Pega o pre√ßo base do tamanho
                             const matchPrecoTamanho = order.size?.match(/R\$ (\d+[,.]\d{2})/); // Usa order.size antigo para pegar pre√ßo
                              if (matchPrecoTamanho) subtotalPedidoItem += parseFloat(matchPrecoTamanho[1].replace(',', '.')); // Adiciona o pre√ßo base do tamanho
                              else if (order.produtoPrincipal?.price) subtotalPedidoItem = order.produtoPrincipal.price; // Tenta pegar do novo state se size n√£o tiver pre√ßo
                         }

                         itemParaServidor.totalPedido = subtotalPedidoItem.toFixed(2); // Total deste item

                         // Adiciona campos comuns ao objeto do item para o servidor (pode ser redundante, mas garante info)
                         // Embora Payment/Delivery/Resumo sejam do pedido GERAL, inclu√≠mos aqui para cada item no payload
                         // ao servidor, o que pode facilitar o processamento no backend se ele iterar sobre pedidoCompleto.
                         // itemParaServidor.pagamento = order.payment; // J√° est√° no payload geral
                         // itemParaServidor.entrega = order.delivery?.split(' - R$ ')[0]; // J√° est√° no payload geral


                         pedidoCompletoParaServidor.push(itemParaServidor);
                         valorTotalGeralServidor += subtotalPedidoItem; // Soma o subtotal deste item ao total geral
                     });

                    // Adiciona a taxa de entrega ao valor total geral (se aplic√°vel, baseado no primeiro pedido)
                     if (orders.length > 0 && infoEntregaPrimeiroPedido?.split(' - R$ ')[0] !== "Retirada" && taxaEntregaServidor > 0) {
                         valorTotalGeralServidor += taxaEntregaServidor;
                     }


                    const payloadParaServidor = {
                        pedidoCompleto: pedidoCompletoParaServidor, // Array com os detalhes de cada item
                        valorTotal: parseFloat(valorTotalGeralServidor.toFixed(2)), // Valor total do pedido (itens + frete)
                        metodoPagamento: metodoPagamentoPrimeiroPedido, // Pagamento do primeiro pedido
                        tipoEntrega: infoEntregaPrimeiroPedido, // Entrega/Retirada do primeiro pedido (com pre√ßo)
                        resumoParaAdmin: summaryEl.textContent // Resumo completo para o admin/WhatsApp
                    };

                    console.log("Payload para o servidor:", payloadParaServidor); // Log para debug

                    // Envia para o servidor
                    const response = await fetch('/api/orders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payloadParaServidor),
                    });

                    if (response.ok) {
                        console.log('Pedido enviado para o servidor com sucesso!'); // Log para debug
                         // Limpa os pedidos da p√°gina e reseta o formul√°rio AP√ìS enviar para o servidor
                         orders = []; // Limpa o array de pedidos locais
                         resetForm(); // Reseta o formul√°rio e a exibi√ß√£o dos pedidos na p√°gina
                         // Redireciona para o WhatsApp APENAS SE o envio para o servidor foi bem-sucedido
                          console.log("Redirecionando para WhatsApp..."); // Log para debug
                          window.location.href = whatsappURL; // Redireciona a aba atual

                    } else {
                         const errorText = await response.text();
                        console.error('Falha ao enviar pedido para o servidor:', response.status, errorText); // Log para debug
                         alert(`Houve um erro ao enviar seu pedido para o servidor (Status: ${response.status}). Por favor, tente novamente.`);
                         // N√£o limpa o formul√°rio ou pedidos locais em caso de erro para que o cliente possa tentar novamente
                         // O cliente ainda pode enviar o resumo pelo WhatsApp manualmente.
                    }
                } catch (error) {
                    console.error('Erro ao processar envio do pedido:', error); // Log para debug
                     alert("Ocorreu um erro ao processar seu pedido. Por favor, verifique sua conex√£o ou tente novamente.");
                     // N√£o limpa o formul√°rio ou pedidos locais em caso de erro
                }

                 // Desabilita os bot√µes ap√≥s tentar finalizar (independentemente do sucesso do envio ao servidor para evitar cliques m√∫ltiplos)
                 // Eles ser√£o reabilitados pelo resetForm() se o envio for ok.
                 disableAll(); // Desabilita todos os fieldsets
                 btnAdd.disabled = true;
                 btnFinish.disabled = true;

            } else {
                 console.log("Nenhum pedido para finalizar ap√≥s verifica√ß√µes."); // Log para debug
                 alert("Nenhum pedido pronto ou adicionado para finalizar.");
            }
        };


        btnCancel.onclick = () => {
             console.log("Clicou em Cancelar Pedido Atual."); // Log para debug
            if (confirm("Tem certeza que deseja cancelar todos os pedidos e recome√ßar?")) {
                orders = []; // Limpa os pedidos
                 console.log("Pedidos locais limpos."); // Log para debug
                resetForm(); // Reseta o formul√°rio e a exibi√ß√£o
                 console.log("Formul√°rio resetado completamente."); // Log para debug
            }
        };

        // Adapta√ß√£o da fun√ß√£o isOrderReadyToAdd para o Copo da Felicidade
         function isOrderReadyToAdd() {
              console.log("Verificando se o item atual est√° pronto para adicionar. State:", state); // Log para debug
             // Verifica se um produto principal (A√ßa√≠ ou Copo da Felicidade) foi selecionado
             if (!state.produtoPrincipal || !state.produtoPrincipal.type) {
                  console.log("  -> Produto principal n√£o selecionado."); // Log para debug
                 return false;
             }

             let itemSpecificValidity = false; // Valida√ß√£o espec√≠fica para o tipo de item

             if (state.produtoPrincipal.type === 'acai') {
                  console.log("  -> Validando item A√ßa√≠."); // Log para debug
                 // L√≥gica de valida√ß√£o para A√ßa√≠
                 state.frutas = state.frutas || []; state.cremes = state.cremes || []; state.accomp = state.accomp || [];
                 state.cover = state.cover || []; state.add = state.add || [];

                 const checkSectionValidity = (fieldset, categoryKey, categoryMax) => {
                      // Se o fieldset est√° desabilitado (ex: pelo tamanho selecionado ou por ser copo felicidade), ele √© v√°lido por padr√£o
                     if (!fieldset || fieldset.hasAttribute('disabled')) {
                          console.log(`    -> Fieldset "${fieldset?.id}" desabilitado. V√°lido por padr√£o.`); // Log para debug
                          return true;
                     }

                      const itemsSelected = state[categoryKey];
                      // console.log(`    -> Validando fieldset "${fieldset.id}" (${categoryKey}). Items no state:`, itemsSelected); // Log para debug


                      // Deve haver pelo menos um item selecionado (incluindo 'Nenhuma'/'Nenhum Adicional') se o fieldset est√° habilitado
                     if (!itemsSelected || itemsSelected.length === 0) {
                          console.log(`    -> Fieldset "${fieldset.id}" habilitado, mas nenhum item selecionado.`); // Log para debug
                         return false;
                     }

                      const noneValue = categoryKey === 'add' ? 'Nenhum Adicional' : 'Nenhuma';

                      // Se a op√ß√£o "Nenhuma" ou "Nenhum Adicional" est√° selecionada, deve ser o √öNICO item
                     if (itemsSelected.includes(noneValue) && itemsSelected.length > 1) {
                          console.log(`    -> Fieldset "${fieldset.id}" habilitado, "${noneValue}" selecionado junto com outros.`); // Log para debug
                         return false;
                     }

                      // Verifica limite m√°ximo se n√£o for a op√ß√£o "Nenhuma" e tiver limite definido
                      // A l√≥gica em setupChecks j√° impede que mais do que o m√°ximo seja marcado,
                      // mas esta verifica√ß√£o aqui garante que o estado √© v√°lido.
                     if (!itemsSelected.includes(noneValue) && categoryMax !== undefined && itemsSelected.length > categoryMax) {
                         console.log(`    -> Fieldset "${fieldset.id}" habilitado, contagem (${itemsSelected.length}) excede o limite (${categoryMax}).`); // Log para debug
                         return false;
                     }

                      console.log(`    -> Fieldset "${fieldset.id}" habilitado e sele√ß√£o v√°lida.`); // Log para debug
                      return true; // Sele√ß√£o v√°lida para este fieldset habilitado
                  };

                 const frutasOk = checkSectionValidity(fs.frutas, 'frutas', state.fMax);
                 const cremesOk = checkSectionValidity(fs.cremes, 'cremes', state.cMax);
                 const accompOk = checkSectionValidity(fs.accomp, 'accomp', state.aMax);
                 const coverOk = checkSectionValidity(fs.cover, 'cover', state.coMax);

                 let addOk = true;
                  // Verifica adicionais APENAS se o fieldset 'Deseja adicionais?' est√° habilitado
                 if (!fs.askAdd.hasAttribute('disabled')) {
                      console.log("  -> Validando adicionais (fieldset Deseja adicionais? habilitado)."); // Log para debug
                      // Se "Deseja adicionais?" est√° habilitado, √© obrigat√≥rio escolher Sim ou N√£o
                     if (state.wantAdd === undefined) {
                         console.log("    -> Escolha Sim/N√£o adicionais pendente."); // Log para debug
                         return false; // Nada selecionado
                     }
                      // Se "Sim" foi escolhido, valida o fieldset de adicionais (que deve estar habilitado)
                     if (state.wantAdd === 'Sim') {
                          console.log("    -> Escolheu 'Sim', validando fieldset Adicionais."); // Log para debug
                         addOk = checkSectionValidity(fs.add, 'add', state.addMax);
                     }
                      // Se "N√£o" foi escolhido, addOk j√° √© true.
                 } else {
                      console.log("  -> Fieldset Deseja adicionais? desabilitado. Adicionais v√°lidos por padr√£o."); // Log para debug
                      addOk = true; // Adicionais s√£o v√°lidos por padr√£o se a se√ß√£o est√° desabilitada
                 }


                 itemSpecificValidity = frutasOk && cremesOk && accompOk && coverOk && addOk;
                  console.log("  -> Validade espec√≠fica do item A√ßa√≠:", itemSpecificValidity); // Log para debug


             } else if (state.produtoPrincipal.type === 'produto_especial' && state.produtoPrincipal.id === 'copo_felicidade') {
                  console.log("  -> Validando item Copo da Felicidade."); // Log para debug
                 // L√≥gica de valida√ß√£o para Copo da Felicidade
                 // Requer que um sabor tenha sido selecionado no fieldset de sabores do Copo da Felicidade.
                 // O fieldset de sabores DEVE estar habilitado para que a sele√ß√£o seja poss√≠vel.
                 const isFlavorSelected = state.selectedCopoFelicidadeFlavor !== undefined && state.selectedCopoFelicidadeFlavor !== null && state.selectedCopoFelicidadeFlavor !== ''; // Verifica se o sabor foi selecionado e n√£o √© vazio
                  console.log("  -> Sabor Copo da Felicidade selecionado?", isFlavorSelected, "Sabor:", state.selectedCopoFelicidadeFlavor); // Log para debug

                 // O fieldset de sabores do Copo da Felicidade DEVE estar habilitado
                 const isFlavorFieldsetEnabled = fs.copoFelicidadeFlavors && !fs.copoFelicidadeFlavors.hasAttribute('disabled');
                  console.log("  -> Fieldset de sabores Copo Felicidade habilitado?", isFlavorFieldsetEnabled); // Log para debug

                  // Adicionalmente, os fieldsets de a√ßa√≠ e adicionais DEVEM estar desabilitados.
                  // Isso √© uma valida√ß√£o extra para garantir que a UI est√° no estado correto para Copo Felicidade.
                  const acaiFieldsetsDisabled = fs.frutas.hasAttribute('disabled') &&
                                                 fs.cremes.hasAttribute('disabled') &&
                                                 fs.accomp.hasAttribute('disabled') &&
                                                 fs.cover.hasAttribute('disabled') &&
                                                 fs.askAdd.hasAttribute('disabled') &&
                                                 fs.add.hasAttribute('disabled');
                   console.log("  -> Fieldsets de a√ßa√≠/adicionais desabilitados?", acaiFieldsetsDisabled); // Log para debug


                 // O item Copo da Felicidade √© v√°lido SE um sabor foi selecionado E o fieldset de sabores est√° habilitado
                 itemSpecificValidity = isFlavorSelected && isFlavorFieldsetEnabled && acaiFieldsetsDisabled; // Verifica se sabor selecionado E fieldsets corretos habilitados/desabilitados
                  console.log("  -> Validade espec√≠fica do item Copo da Felicidade:", itemSpecificValidity); // Log para debug

             } else {
                 console.warn("  -> Tipo de produto desconhecido no state:", state.produtoPrincipal); // Log para debug
                 itemSpecificValidity = false;
             }

             // A valida√ß√£o de pagamento e entrega √© feita em checkIfCanFinish(),
             // pois elas se aplicam ao pedido GERAL, n√£o a cada item individualmente.
             // Esta fun√ß√£o isOrderReadyToAdd √© apenas para saber se o item ATUAL est√° pronto para ser adicionado √† lista.

             return itemSpecificValidity; // Retorna apenas a validade espec√≠fica do item atual
         }


         // Adapta√ß√£o da fun√ß√£o resetPartial para limpar o estado do item atual e preparar para o pr√≥ximo
        function resetPartial() {
             console.log("Resetando formul√°rio parcial para o pr√≥ximo item."); // Log para debug
             // Limpa APENAS as op√ß√µes e estado relacionados ao ITEM ATUAL
             state.produtoPrincipal = undefined; // Limpa a sele√ß√£o do produto principal
             state.size = undefined; // Limpa o tamanho antigo (compatibilidade)
             state.fMax = state.cMax = state.aMax = state.coMax = state.addMax = undefined; // Limpa limites

             state.frutas = []; state.cremes = []; state.accomp = []; state.cover = []; state.add = []; // Limpa sele√ß√µes de componentes/adicionais
             state.wantAdd = undefined; // Limpa escolha Sim/N√£o adicionais
             state.selectedCopoFelicidadeFlavor = undefined; // Limpa sabor Copo Felicidade

             // N√ÉO reseta payment e delivery aqui, pois eles se aplicam ao pedido geral e podem j√° ter sido selecionados para o primeiro item.
             // clearRadios('payment'); // N√£o limpar aqui
             // clearRadios('delivery'); // N√£o limpar aqui
             // document.querySelectorAll('input[name="payment"]').forEach(r => r.closest('label')?.classList.remove('selected-radio')); // N√£o limpar aqui
             // document.querySelectorAll('input[name="delivery"]').forEach(r => r.closest('label')?.classList.remove('selected-radio')); // N√£o limpar aqui


             // Desabilita todos os fieldsets dependentes de produto principal
             [fs.frutas, fs.cremes, fs.accomp, fs.cover, fs.askAdd, fs.add, fs.copoFelicidadeFlavors].forEach(disable);

             // Limpa checkboxes e radios e reseta contadores nos fieldsets desabilitados
             clearCheckboxes(fs.frutas); updateCounter(cnt.frutas, 0, '?');
             clearCheckboxes(fs.cremes); updateCounter(cnt.cremes, 0, '?');
             clearCheckboxes(fs.accomp); updateCounter(cnt.accomp, 0, '?');
             clearCheckboxes(fs.cover); updateCounter(cnt.cover, 0, '?');
             clearCheckboxes(fs.add); updateCounter(cnt.add, 0, 14);
             clearRadios('wantAdd'); // Limpa r√°dios Sim/N√£o adicionais
             clearRadios('copoFelicidadeFlavor'); // Limpa r√°dios de sabor do Copo Felicidade

             // Limpa a sele√ß√£o de r√°dio e visual dos produtos principais (tamanho/copo felicidade)
             clearRadios('produtoPrincipal');
             document.querySelectorAll('.produto-card').forEach(label => label.classList.remove('selected')); // Limpa a sele√ß√£o visual dos cards


             // Garante que o fieldset de produto principal esteja habilitado para o pr√≥ximo item
             enable(fs.produtoPrincipal);

             // Oculta informa√ß√µes PIX se a forma de pagamento n√£o foi selecionada para este pedido (n√£o acontece em resetPartial)
             // if(pixInfoDiv) pixInfoDiv.classList.add('hidden'); // N√£o ocultar aqui

             // Desabilita bot√µes Adicionar/Finalizar at√© que o pr√≥ximo item esteja pronto
             btnAdd.disabled = true;
             btnFinish.disabled = true;

             // N√£o mexe na se√ß√£o de pedidos 'ordersSec' nem em 'orderPageTotal', pois eles mostram os itens J√Å adicionados.
             // renderOrders() √© chamada por btnAdd para atualizar esta se√ß√£o.
         }


        // Adapta√ß√£o da fun√ß√£o resetForm (reseta TUDO, para iniciar um NOVO pedido geral)
         async function resetForm() {
             console.log("Resetando formul√°rio completo para um novo pedido geral."); // Log para debug
             state = {}; // Limpa TODO o estado
             orders = []; // Limpa a lista de pedidos salvos

             renderOrders(); // Com orders vazio, vai esconder ordersSec e zerar o total na p√°gina

              // Oculta informa√ß√µes PIX (aplica-se ao pedido geral)
              if(pixInfoDiv) pixInfoDiv.classList.add('hidden');

             // Re-busca e aplica a disponibilidade dos itens (renderiza produtos principais e configura listeners)
             await fetchAndApplyItemAvailability(); // Esta fun√ß√£o tamb√©m renderiza produtos principais e configura listeners

             // Limpa todos os checkboxes e radios em todo o formul√°rio (incluindo payment/delivery)
             form.querySelectorAll('input[type="checkbox"]').forEach(chk => { chk.checked = false; }); // Limpa todos checkboxes
             form.querySelectorAll('input[type="radio"]').forEach(r => { r.checked = false; }); // Limpa todos radios
             document.querySelectorAll('.selected-radio').forEach(label => label.classList.remove('selected-radio')); // Limpa visual radios
             document.querySelectorAll('.produto-card').forEach(label => label.classList.remove('selected')); // Limpa visual cards

             // Reseta contadores para 0/?
             updateCounter(cnt.frutas, 0, '?');
             updateCounter(cnt.cremes, 0, '?');
             updateCounter(cnt.accomp, 0, '?');
             updateCounter(cnt.cover, 0, '?');
             updateCounter(cnt.add, 0, 14);

             // Desabilita todos os fieldsets, exceto o de produto principal (in√≠cio do fluxo)
             const allFieldsets = form.querySelectorAll('fieldset');
             allFieldsets.forEach(f => {
                 if (f.id !== 'fsProdutoPrincipal') disable(f);
                 else enable(f); // Garante que o primeiro fieldset est√° habilitado
             });
              // Garante que o fieldset de sabores do Copo Felicidade tamb√©m est√° desabilitado inicialmente
             disable(fs.copoFelicidadeFlavors);


             // Desabilita bot√µes de a√ß√£o no in√≠cio
             btnAdd.disabled = true;
             btnFinish.disabled = true;

             // Os listeners principais (produtoPrincipal, copoFelicidadeFlavor, wantAdd, payment, delivery)
             // j√° s√£o configurados pela chamada fetchAndApplyItemAvailability() que renderiza os elementos
             // e chama os setupListeners.

             console.log("Formul√°rio resetado e pronto para um novo pedido."); // Log para debug
         }

        // Adiciona um listener gen√©rico para os r√°dios de pagamento para mostrar/ocultar info PIX
        // Este listener √© configurado em fetchAndApplyItemAvailability()
         // document.querySelectorAll('input[name="payment"]').forEach(radio => {
         //      radio.addEventListener('change', (event) => {
         //          if (pixInfoDiv) {
         //              if (event.target.value === 'Pix' && event.target.checked) {
         //                  pixInfoDiv.classList.remove('hidden');
         //              } else {
         //                  pixInfoDiv.classList.add('hidden');
         //              }
         //          }
         //      });
         // });


         // Fun√ß√£o auxiliar para desabilitar todos os fieldsets no formul√°rio
         function disableAll() {
              console.log("Desabilitando todos os fieldsets."); // Log para debug
             const allFieldsets = form.querySelectorAll('fieldset');
             allFieldsets.forEach(disable); // Usa a fun√ß√£o disable para aplicar o atributo e remover pointer-events
         }


        // --- CHAMADA INICIAL ---
        // Ao carregar a p√°gina, resetamos o formul√°rio e buscamos a disponibilidade
        resetForm(); // Inicia o formul√°rio e busca os dados
    </script>
</body>
</html>
