<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blue A√ßa√≠ ‚Äì Card√°pio Interativo</title>
    <style>
        :root {
            --purple: #5A0F8D;
            --light-purple: #F3E5FF;
            --dark-text: #333;
            --card-bg: #fff;
            --danger-red: #dc3545;
            --danger-red-hover: #c82333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--light-purple);
            color: var(--dark-text);
        }

        header {
            background: var(--purple);
            color: #fff;
            text-align: center;
            padding: 1rem;
        }

        header img {
            max-width: 120px;
            margin-bottom: .5rem;
        }

        main {
            max-width: 800px;
            margin: 1rem auto;
            padding: 0 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        fieldset {
            border: none;
            margin: 1rem 0;
            transition: opacity .3s;
        }

        fieldset[disabled] {
            opacity: .6;
        }

        fieldset[disabled] label {
             pointer-events: none; /* Impede clique nos labels quando o fieldset est√° desabilitado */
        }


        legend {
            font-weight: bold;
            margin-bottom: .5rem;
            color: var(--purple);
        }

        legend .section-status {
            font-weight: normal;
            font-size: 0.85em;
            color: #666;
            margin-left: 5px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: .75rem;
        }

        label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: .95rem;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        label:hover:not(.disabled-item) {
            background-color: #f0f0f0;
        }

        label.disabled-item {
            text-decoration: line-through;
            color: #aaa !important;
            cursor: not-allowed;
            pointer-events: none; /* Desabilita clique em itens individuais indispon√≠veis */
        }

        label input[type="checkbox"],
        label input[type="radio"] {
            margin-right: .5rem;
            cursor: pointer;
        }

        label input[type="checkbox"]:disabled,
        label input[type="radio"]:disabled {
            cursor: not-allowed;
        }

        .counter {
            margin-left: .5rem;
            color: var(--purple);
            font-weight: normal;
            font-size: .9rem;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: .75rem;
            margin-top: 1.5rem;
        }

        .buttons button {
            padding: .75rem;
            border: none;
            border-radius: 4px;
            background: var(--purple);
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .buttons button#btnCancel {
            background-color: var(--danger-red);
        }
        .buttons button#btnCancel:hover:not(:disabled) {
            background-color: var(--danger-red-hover);
        }

        .buttons button:hover:not(:disabled) {
            background-color: #4a0c74;
        }

        .buttons button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #summary {
            display: none;
            white-space: pre-wrap;
        }

        #ordersSection {
            border-top: 2px solid var(--purple);
            margin-top: 1.5rem;
            padding-top: 1rem;
        }

        #ordersList li {
            margin-bottom: .75rem;
            list-style: none;
            padding-left: 1.5rem;
            position: relative;
            border-bottom: 1px dashed #eee;
            padding-bottom: 0.5rem;
        }

        #ordersList li::before {
            content: 'üç¶';
            position: absolute;
            left: 0;
            top: 0;
            font-size: 0.9em;
        }

        /* Estilos adaptados para incluir Copo da Felicidade na se√ß√£o de produtos/tamanhos */
        .produtos-opcoes { display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin-top: 1rem; }
        .produto-card { background: var(--card-bg); border: 2px solid #ccc; border-radius: 10px; padding: 1rem; width: 210px; text-align: center; transition: 0.3s; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; position: relative; }
        .produto-card input[type="radio"] {
            position: absolute;
            top: 10px;
            right: 10px;
            transform: scale(1.3);
            cursor: pointer;
            accent-color: var(--purple); /* Cor de destaque para o radio button selecionado */
        }
        .produto-card:hover { border-color: var(--purple); transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12); }
        label.produto-card.selected { border-color: var(--purple); box-shadow: 0 5px 10px rgba(90, 15, 141, 0.2); background-color: #faf5ff; }
        .produto-card img { width: 100%; max-height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 0.75rem; }
        .produto-card strong { font-size: 1rem; color: #333; display: block; margin-top: 0.5rem; }
        .produto-card span { font-size: 0.85rem; color: #555; margin-top: 0.25rem; display: block; line-height: 1.3; }
        /* Remover estilos espec√≠ficos de .tamanho-card para usar .produto-card */
        .tamanhos-opcoes, .tamanho-card { /* Estes seletores n√£o ser√£o mais usados diretamente para o layout principal */ }


        .pix-info-container {
            background-color: #fdf1ff;
            border: 1px solid var(--purple);
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        .pix-info-container.hidden {
            display: none;
        }
        .pix-info-container h3 { color: var(--purple); margin-bottom: 0.75rem; }
        .pix-info-container p { margin-bottom: 0.5rem; line-height: 1.4; }
        .pix-info-container small { color: #555; font-style: italic; }

        #orderPageTotal {
            text-align: right; margin-top: 1rem; font-weight: bold;
            font-size: 1.1em; padding: 0.75rem; background-color: #f0f0f0;
            border-top: 1px solid #ddd; border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        /* Estilo espec√≠fico para a sele√ß√£o de sabor do Copo da Felicidade */
        #fsCopoFelicidadeFlavors .grid-2 label { /* Adapte conforme necess√°rio */
             border: 1px solid #ccc; /* Adiciona uma borda para diferenciar os sabores */
             padding: 10px;
             border-radius: 5px;
             background-color: #f9f9f9;
             display: flex; /* Garante que label use flexbox para align-items: center */
             align-items: center;
        }
         #fsCopoFelicidadeFlavors .grid-2 label.selected-radio {
             border-color: var(--purple);
             background-color: #e9d8f3; /* Cor de fundo mais clara ao selecionar */
             font-weight: bold;
         }
         #fsCopoFelicidadeFlavors .grid-2 label input[type="radio"] {
             margin-right: 0.5rem;
             cursor: pointer;
             accent-color: var(--purple); /* Adicionado aqui tamb√©m para consist√™ncia, se necess√°rio */
         }
          #fsCopoFelicidadeFlavors .grid-2 label small {
             display: block; /* Quebra linha para a descri√ß√£o interna */
             font-size: 0.8em;
             color: #555;
             margin-left: 1.5rem; /* Ajuste para alinhar com o texto do sabor */
             margin-top: 0.2em; /* Espa√ßo entre sabor e descri√ß√£o */
             font-weight: normal;
          }
           #fsCopoFelicidadeFlavors .grid-2 label span { /* Usar span para o nome do sabor */
             display: inline; /* Mant√©m o nome do sabor na mesma linha do r√°dio */
             font-weight: bold;
           }

    </style>
</head>
<body>
    <header>
        <img src="/images/logo.png" alt="Logomarca Blue A√ßa√≠" />
        <h1>Blue A√ßa√≠</h1>
        <p>Monte seu a√ßa√≠ como quiser!</p>
    </header>
    <main>
        <div class="card">
            <form id="formPedido">
                <fieldset id="fsProdutoPrincipal">
                     <legend>1. Escolha o Produto <span class="section-status">(Obrigat√≥rio)</span></legend>
                     <div class="produtos-opcoes" id="boxProdutosPrincipais">
                         </div>
                </fieldset>

                <fieldset id="fsCopoFelicidadeFlavors" disabled>
                     <legend>2. Escolha o Sabor <span class="section-status">(Obrigat√≥rio para Copo da Felicidade)</span></legend>
                     <div class="grid-2" id="boxCopoFelicidadeFlavors">
                         </div>
                 </fieldset>

                <fieldset id="fsFrutas" disabled><legend>2. Frutas <span id="cntFrutas" class="counter">(0/?)</span></legend><div class="grid-2" id="boxFrutas"><label for="chk-morango"><input type="checkbox" value="Morango" id="chk-morango" data-item-id="morango" />Morango</label><label for="chk-banana"><input type="checkbox" value="Banana" id="chk-banana" data-item-id="banana" />Banana</label><label for="chk-kiwi"><input type="checkbox" value="Kiwi" id="chk-kiwi" data-item-id="kiwi" />Kiwi</label><label for="chk-maca"><input type="checkbox" value="Ma√ß√£" id="chk-maca" data-item-id="maca" />Ma√ß√£</label><label for="chk-uva"><input type="checkbox" value="Uva" id="chk-uva" data-item-id="uva" />Uva</label><label for="chk-frutas-nenhuma"><input type="checkbox" value="Nenhuma" id="chk-frutas-nenhuma" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsCremes" disabled><legend>3. Cremes <span id="cntCremes" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCremes"><label for="chk-ninho"><input type="checkbox" value="Ninho" id="chk-ninho" data-item-id="ninho" />Ninho</label><label for="chk-maracuja"><input type="checkbox" value="Maracuj√°" id="chk-maracuja" data-item-id="maracuja" />Maracuj√°</label><label for="chk-morango-creme"><input type="checkbox" value="Morango" id="chk-morango-creme" data-item-id="morango_creme" />Morango</label><label for="chk-tutti-frutti-creme"><input type="checkbox" value="Tutti Frutti" id="chk-tutti-frutti-creme" data-item-id="tutti_frutti_creme" />Tutti Frutti</label><label for="chk-chocolate-avela"><input type="checkbox" value="Chocolate com Avel√£" id="chk-chocolate-avela" data-item-id="chocolate_avela" />Chocolate c/Avel√£</label><label for="chk-cremes-nenhum"><input type="checkbox" value="Nenhuma" id="chk-cremes-nenhum"/>Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsAccomp" disabled><legend>4. Acompanhamentos <span id="cntAccomp" class="counter">(0/?)</span></legend><div class="grid-2" id="boxAccomp"><label for="chk-amendoim-acomp"><input type="checkbox" value="Amendoim" id="chk-amendoim-acomp" data-item-id="amendoim_acomp" />Amendoim</label><label for="chk-pacoca-acomp"><input type="checkbox" value="Pa√ßoca" id="chk-pacoca-acomp" data-item-id="pacoca_acomp" />Pa√ßoca</label><label for="chk-granola-acomp"><input type="checkbox" value="Granola" id="chk-granola-acomp" data-item-id="granola_acomp" />Granola</label><label for="chk-farinha-lactea-acomp"><input type="checkbox" value="Farinha L√°ctea" id="chk-farinha-lactea-acomp" data-item-id="farinha_lactea_acomp" />Farinha L√°ctea</label><label for="chk-leite-po-acomp"><input type="checkbox" value="Leite em P√≥" id="chk-leite-po-acomp" data-item-id="leite_po_acomp" />Leite em P√≥</label><label for="chk-confetes-acomp"><input type="checkbox" value="Confetes" id="chk-confetes-acomp" data-item-id="confetes_acomp" />Confetes</label><label for="chk-tapioca-acomp"><input type="checkbox" value="Tapioca" id="chk-tapioca-acomp" data-item-id="tapioca_acomp" />Tapioca</label><label for="chk-uva-passa-acomp"><input type="checkbox" value="Uva Passa" id="chk-uva-passa-acomp" data-item-id="uva_passa_acomp" />Uva Passa</label><label for="chk-accomp-nenhum"><input type="checkbox" value="Nenhuma" id="chk-accomp-nenhum" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsCoverage" disabled><legend>5. Cobertura(s) <span id="cntCover" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCoverage"><label for="chk-chocolate-cob"><input type="checkbox" value="Chocolate" id="chk-chocolate-cob" data-item-id="chocolate_cob" />Chocolate</label><label for="chk-morango-cob"><input type="checkbox" value="Morango" id="chk-morango-cob" data-item-id="morango_cob" />Morango</label><label for="chk-leite-condensado-cob"><input type="checkbox" value="Leite Condensado" id="chk-leite-condensado-cob" data-item-id="leite_condensado_cob" />Leite Condensado</label><label for="chk-tutti-frutti-cob"><input type="checkbox" value="Tutti Frutti" id="chk-tutti-frutti-cob" data-item-id="tutti_frutti_cob" />Tutti Frutti</label><label for="chk-ice-blue-cob"><input type="checkbox" value="Ice Blue" id="chk-ice-blue-cob" data-item-id="ice_blue_cob" />Ice Blue</label><label for="chk-kiwi-cob"><input type="checkbox" value="Kiwi" id="chk-kiwi-cob" data-item-id="kiwi_cob" />Kiwi</label><label for="chk-cover-nenhuma"><input type="checkbox" value="Nenhuma" id="chk-cover-nenhuma" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsAskAdd" disabled><legend>6. Deseja adicionais? <span class="section-status">(Obrigat√≥rio para A√ßa√≠)</span></legend><div class="grid-2"><label><input type="radio" name="wantAdd" value="Sim" required />Sim</label><label><input type="radio" name="wantAdd" value="N√£o" />N√£o</label></div></fieldset>
                <fieldset id="fsAdd" disabled><legend>7. Adicionais <span id="cntAdd" class="counter">(0/14)</span></legend><div class="grid-2" id="boxAdd"><label for="chk-ovomaltine-add"><input type="checkbox" value="Ovomaltine - R$ 1.00" id="chk-ovomaltine-add" data-item-id="ovomaltine_add" />Ovomaltine R$ 1.00</label><label for="chk-escureto-add"><input type="checkbox" value="Escureto - R$ 1.00" id="chk-escureto-add" data-item-id="escureto_add" />Escureto R$ 1.00</label><label for="chk-chocoball-add"><input type="checkbox" value="Chocoball - R$ 1.00" id="chk-chocoball-add" data-item-id="chocoball_add" />Chocoball R$ 1.00</label><label for="chk-amendoim-add"><input type="checkbox" value="Amendoim - R$ 1.00" id="chk-amendoim-add" data-item-id="amendoim_add" />Amendoim R$ 1.00</label><label for="chk-pacoca-add"><input type="checkbox" value="Pa√ßoca - R$ 1.00" id="chk-pacoca-add" data-item-id="pacoca_add" />Pa√ßoca R$ 1.00</label><label for="chk-granola-add"><input type="checkbox" value="Granola - R$ 1.00" id="chk-granola-add" data-item-id="granola_add" />Granola R$ 1.00</label><label for="chk-farinha-lactea-add"><input type="checkbox" value="Farinha L√°ctea - R$ 1.00" id="chk-farinha-lactea-add" data-item-id="farinha_lactea_add" />Farinha L√°ctea R$ 1.00</label><label for="chk-leite-po-add"><input type="checkbox" value="Leite em p√≥ - R$ 1.00" id="chk-leite-po-add" data-item-id="leite_po_add" />Leite em p√≥ R$ 1.00</label><label for="chk-confetes-add"><input type="checkbox" value="Confetes - R$ 1.00" id="chk-confetes-add" data-item-id="confetes_add" />Confetes R$ 1.00</label><label for="chk-tapioca-add"><input type="checkbox" value="Tapioca - R$ 1.00" id="chk-tapioca-add" data-item-id="tapioca_add" />Tapioca R$ 1.00</label><label for="chk-uva-passa-add"><input type="checkbox" value="Uva Passa - R$ 1.00" id="chk-uva-passa-add" data-item-id="uva_passa_add" />Uva Passa R$ 1.00</label><label for="chk-mms-add"><input type="checkbox" value="M&MS - R$ 1.00" id="chk-mms-add" data-item-id="mms_add" />M&MS R$ 1.00</label><label for="chk-marshmallow-add"><input type="checkbox" value="Marshmallow - R$ 1.00" id="chk-marshmallow-add" data-item-id="marshmallow_add" />Marshmallow R$ 1.00</label><label for="chk-doce-leite-add"><input type="checkbox" value="Doce de leite - R$ 1.00" id="chk-doce-leite-add" data-item-id="doce_leite_add" />Doce de leite R$ 1.00</label><label for="chk-add-nenhum"><input type="checkbox" value="Nenhum Adicional" id="chk-add-nenhum" />Nenhum Adicional</label></div></fieldset>

                <fieldset id="fsPayment" disabled>
                    <legend>8. Forma de Pagamento <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="payment" value="Pix" required />Pix</label>
                        <label><input type="radio" name="payment" value="Dinheiro" />Dinheiro</label>
                        <label><input type="radio" name="payment" value="Cart√£o" />Cart√£o</label>
                    </div>
                </fieldset>

                <fieldset id="fsDelivery" disabled>
                    <legend>9. Entrega ou Retirada <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="delivery" value="Retirada" required />Retirada</label>
                        <label><input type="radio" name="delivery" value="Outeiro - R$ 3.00" />Entrega - Outeiro (R$ 3.00)</label>
                        <label><input type="radio" name="delivery" value="Cedral - R$ 5.00" />Entrega - Cedral (R$ 5.00)</label>
                    </div>
                </fieldset>

                <div class="buttons">
                    <button type="button" id="btnCancel">‚ùå Cancelar Pedido Atual</button>
                    <button type="button" id="btnAdd" disabled>‚ûï Adicionar Item ao Pedido</button>
                    <button type="button" id="btnFinish" disabled>‚úÖ Finalizar e Enviar Pedido</button>
                </div>

                <div id="pixInfo" class="pix-info-container hidden">
                    <h3>Pagamento via PIX</h3>
                    <p><strong>Nome:</strong> Bruna Raquel Carvalho Campos</p>
                    <p><strong>Chave PIX (Celular):</strong> (98) 985016035</p>
                    <p><small>Por favor, envie o comprovante ap√≥s finalizar o pedido no WhatsApp.</small></p>
                </div>

            </form>
        </div>

        <div class="card" id="ordersSection" style="display:none;">
            <h2>Seus Itens no Pedido:</h2>
            <ul id="ordersList"></ul>
            <div id="orderPageTotal">
                Total Geral (com frete): R$ <span id="orderPageTotalValue">0,00</span>
            </div>
        </div>

        <div id="summary" style="display: none;"></div>
    </main>

    <script>
        // --- SELETORES ---
        const fs = {
            produtoPrincipal: document.getElementById('fsProdutoPrincipal'),
            copoFelicidadeFlavors: document.getElementById('fsCopoFelicidadeFlavors'),
            frutas: document.getElementById('fsFrutas'),
            cremes: document.getElementById('fsCremes'),
            accomp: document.getElementById('fsAccomp'),
            cover: document.getElementById('fsCoverage'),
            askAdd: document.getElementById('fsAskAdd'),
            add: document.getElementById('fsAdd'),
            payment: document.getElementById('fsPayment'),
            delivery: document.getElementById('fsDelivery')
        };
        const cnt = {
            frutas: document.getElementById('cntFrutas'), cremes: document.getElementById('cntCremes'),
            accomp: document.getElementById('cntAccomp'), cover: document.getElementById('cntCover'),
            add: document.getElementById('cntAdd')
        };
        const boxProdutosPrincipais = document.getElementById('boxProdutosPrincipais');
        const boxCopoFelicidadeFlavors = document.getElementById('boxCopoFelicidadeFlavors');
        const btnAdd = document.getElementById('btnAdd');
        const btnFinish = document.getElementById('btnFinish');
        const btnCancel = document.getElementById('btnCancel');
        const ordersSec = document.getElementById('ordersSection');
        const ordersList = document.getElementById('ordersList');
        const summaryEl = document.getElementById("summary");
        const form = document.getElementById('formPedido');
        const pixInfoDiv = document.getElementById('pixInfo');
        const orderPageTotalValueEl = document.getElementById('orderPageTotalValue');

        let state = {}; // Armazena a sele√ß√£o do item ATUAL
        let orders = []; // Armazena a lista de itens ADICIONADOS ao pedido
        let allItemsData = {}; // Armazena todos os dados de itens do items.json
        let copoFelicidadeData = null; // Armazena os dados espec√≠ficos do Copo da Felicidade

        // --- FUN√á√ïES AUXILIARES ---
        const enable = el => {
            if (el) {
                el.removeAttribute('disabled');
                el.querySelectorAll('label').forEach(lbl => {
                     const input = lbl.querySelector('input');
                     if (input && !input.disabled) { // Check if input itself is not disabled (by availability)
                         lbl.style.pointerEvents = 'auto';
                     } else if (!input) {
                         lbl.style.pointerEvents = 'auto';
                     }
                });
            }
        };
        const disable = el => {
            if (el) {
                el.setAttribute('disabled', '');
                el.querySelectorAll('label').forEach(lbl => lbl.style.pointerEvents = 'none');
            }
        };

        function clearCheckboxes(fieldset) {
             if (fieldset) {
                 fieldset.querySelectorAll('input[type="checkbox"]:checked:not([disabled])').forEach(chk => chk.checked = false);
                 const noneValues = ['Nenhuma', 'Nenhum Adicional'];
                 noneValues.forEach(noneVal => {
                     const noneChk = fieldset.querySelector(`input[value="${noneVal}"]:not([disabled])`);
                      if (noneChk && noneChk.checked) noneChk.checked = false;
                 });
             }
         }

        function clearRadios(name) {
            document.querySelectorAll(`input[name="${name}"]:checked`).forEach(r => r.checked = false);
             document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.closest('label')?.classList.remove('selected-radio'));
        }

        function disableAllAcaiAndAddonFieldsets() {
             console.log("Desabilitando fieldsets de a√ßa√≠ e adicionais.");
             [fs.frutas, fs.cremes, fs.accomp, fs.cover, fs.askAdd, fs.add].forEach(f => {
                disable(f);
                clearCheckboxes(f); // Limpa visualmente
             });
             // Limpa estado interno
             state.frutas = []; updateCounter(cnt.frutas, 0, '?');
             state.cremes = []; updateCounter(cnt.cremes, 0, '?');
             state.accomp = []; updateCounter(cnt.accomp, 0, '?');
             state.cover = []; updateCounter(cnt.cover, 0, '?');
             state.add = []; updateCounter(cnt.add, 0, 14);
             state.wantAdd = undefined; clearRadios('wantAdd');
        }

        // Reseta as op√ß√µes para a sele√ß√£o de um novo ITEM, mantendo payment/delivery
        function resetPartialForItemSelection() {
             console.log("resetPartialForItemSelection: Resetando para novo item.");
             state.produtoPrincipal = undefined;
             state.size = undefined; // Legado, mas pode ser √∫til limpar
             state.fMax = state.cMax = state.aMax = state.coMax = state.addMax = undefined;

             state.frutas = []; state.cremes = []; state.accomp = []; state.cover = []; state.add = [];
             state.wantAdd = undefined;
             state.selectedCopoFelicidadeFlavor = undefined;

             [fs.frutas, fs.cremes, fs.accomp, fs.cover, fs.askAdd, fs.add, fs.copoFelicidadeFlavors].forEach(f => {
                disable(f);
                if (f.querySelectorAll('input[type="checkbox"]').length > 0) clearCheckboxes(f);
                if (f.querySelectorAll('input[type="radio"]').length > 0) {
                    const radioName = f.querySelector('input[type="radio"]')?.name;
                    if (radioName) clearRadios(radioName);
                }
             });

             updateCounter(cnt.frutas, 0, '?');
             updateCounter(cnt.cremes, 0, '?');
             updateCounter(cnt.accomp, 0, '?');
             updateCounter(cnt.cover, 0, '?');
             updateCounter(cnt.add, 0, 14); // Adicionais sempre at√© 14

             clearRadios('produtoPrincipal');
             document.querySelectorAll('.produto-card').forEach(label => label.classList.remove('selected'));

             enable(fs.produtoPrincipal); // Sempre reabilita a escolha do produto

             // Pagamento e Entrega j√° devem estar habilitados e com listeners configurados, n√£o mexer aqui.
             // A informa√ß√£o de PIX tamb√©m n√£o √© resetada aqui.

             btnAdd.disabled = true;
             btnFinish.disabled = true; // Desabilita at√© que o novo item + payment/delivery estejam v√°lidos
             console.log("resetPartialForItemSelection: Conclu√≠do.");
         }

        // --- VALIDA√á√ÉO CENTRALIZADA ---
        function validateCurrentOrderItem() {
            console.log("validateCurrentOrderItem: Verificando item atual. State:", JSON.parse(JSON.stringify(state)));
            if (!state.produtoPrincipal || !state.produtoPrincipal.type) {
                console.log("  -> Produto principal n√£o selecionado.");
                return false;
            }

            const noneAddValue = 'Nenhum Adicional';
            const noneValue = 'Nenhuma';

            if (state.produtoPrincipal.type === 'acai') {
                console.log("  -> Validando A√ßa√≠.");
                state.frutas = state.frutas || []; state.cremes = state.cremes || []; state.accomp = state.accomp || [];
                state.cover = state.cover || []; state.add = state.add || [];

                const checkSectionValidity = (fieldset, stateKey, sectionName) => {
                    if (!fieldset || fieldset.hasAttribute('disabled')) {
                        console.log(`    -> Fieldset "${sectionName}" desabilitado ou n√£o existe. V√°lido por padr√£o.`);
                        return true;
                    }
                    const itemsSelected = state[stateKey];
                    if (!itemsSelected || itemsSelected.length === 0) {
                        console.log(`    -> Fieldset "${sectionName}" habilitado, mas nenhum item selecionado.`);
                        return false;
                    }
                    const noneOption = stateKey === 'add' ? noneAddValue : noneValue;
                    if (itemsSelected.includes(noneOption) && itemsSelected.length > 1) {
                        console.log(`    -> Fieldset "${sectionName}" habilitado, "${noneOption}" selecionado com outros.`);
                        return false;
                    }
                    console.log(`    -> Fieldset "${sectionName}" OK.`);
                    return true;
                };

                const frutasOk = checkSectionValidity(fs.frutas, 'frutas', 'Frutas');
                const cremesOk = checkSectionValidity(fs.cremes, 'cremes', 'Cremes');
                const accompOk = checkSectionValidity(fs.accomp, 'accomp', 'Acompanhamentos');
                const coverOk = checkSectionValidity(fs.cover, 'cover', 'Coberturas');

                let addOk = true;
                if (!fs.askAdd.hasAttribute('disabled')) { // Se a pergunta sobre adicionais est√° habilitada
                    if (state.wantAdd === undefined) {
                        console.log("    -> Escolha Sim/N√£o para adicionais pendente.");
                        return false;
                    }
                    if (state.wantAdd === 'Sim') {
                        addOk = checkSectionValidity(fs.add, 'add', 'Adicionais');
                    }
                    // Se 'N√£o', addOk permanece true.
                }
                const isValid = frutasOk && cremesOk && accompOk && coverOk && addOk;
                console.log("  -> Validade do A√ßa√≠:", isValid);
                return isValid;

            } else if (state.produtoPrincipal.type === 'produto_especial' && state.produtoPrincipal.id === 'copo_felicidade') {
                console.log("  -> Validando Copo da Felicidade.");
                const isFlavorSelected = state.selectedCopoFelicidadeFlavor !== undefined &&
                                         state.selectedCopoFelicidadeFlavor !== null &&
                                         state.selectedCopoFelicidadeFlavor !== '';
                console.log("  -> Sabor selecionado?", isFlavorSelected, "Sabor:", state.selectedCopoFelicidadeFlavor);
                // Para o Copo da Felicidade, apenas o sabor √© mandat√≥rio (as outras se√ß√µes de a√ßa√≠ s√£o desabilitadas)
                return isFlavorSelected;
            } else {
                console.warn("  -> Tipo de produto desconhecido:", state.produtoPrincipal);
                return false;
            }
        }

        // Verifica se o ITEM ATUAL est√° pronto para ser adicionado √† lista 'orders'
        function isOrderReadyToAdd() {
            // Esta fun√ß√£o agora s√≥ chama a valida√ß√£o do item.
            // A valida√ß√£o de payment/delivery √© para finalizar o pedido GERAL.
            return validateCurrentOrderItem();
        }


        // --- L√ìGICA DE DISPONIBILIDADE E CARREGAMENTO DE ITENS ---
        async function fetchAndApplyItemAvailability() {
            console.log("fetchAndApplyItemAvailability: Buscando dados de itens...");
            try {
                const response = await fetch('/api/items'); // Certifique-se que esta rota existe e retorna o JSON esperado
                if (!response.ok) {
                     const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                allItemsData = await response.json();
                 console.log("fetchAndApplyItemAvailability: Dados recebidos:", allItemsData);

                const produtosEspeciais = allItemsData.produtos_especiais || [];
                copoFelicidadeData = produtosEspeciais.find(item => item.id === 'copo_felicidade');
                 console.log("fetchAndApplyItemAvailability: Dados do Copo da Felicidade:", copoFelicidadeData);

                renderProdutosPrincipais(); // Renderiza A√ßa√≠s e Copo da Felicidade

                const updateCheckboxDisplay = (categoryKey, containerElement) => {
                    if (!allItemsData[categoryKey] || !containerElement) return;
                    allItemsData[categoryKey].forEach(item => {
                        const checkbox = containerElement.querySelector(`input[data-item-id="${item.id}"]`);
                        if (checkbox) {
                            const label = checkbox.closest('label');
                            if (!item.available) {
                                checkbox.disabled = true;
                                checkbox.checked = false;
                                if (label) { label.classList.add('disabled-item'); label.title = 'Item indispon√≠vel'; }
                            } else {
                                checkbox.disabled = false;
                                if (label) {
                                    label.classList.remove('disabled-item');
                                    label.title = '';
                                     if (!checkbox.closest('fieldset[disabled]')) {
                                        label.style.pointerEvents = 'auto';
                                     }
                                }
                            }
                        }
                    });
                };

                updateCheckboxDisplay('frutas', fs.frutas);
                updateCheckboxDisplay('cremes', fs.cremes);
                updateCheckboxDisplay('acompanhamentos', fs.accomp);
                updateCheckboxDisplay('coberturas', fs.cover);
                updateCheckboxDisplay('adicionais', fs.add);

                setupProdutoPrincipalListeners(); // Configura listeners para os cards de produto
                setupRadioListener('payment'); // N√£o precisa de 'stageToAdvance' aqui
                setupRadioListener('delivery'); // N√£o precisa de 'stageToAdvance' aqui

                // Habilita Pagamento e Entrega, pois s√£o necess√°rios para qualquer pedido
                enable(fs.payment);
                enable(fs.delivery);


            } catch (error) {
                console.error("fetchAndApplyItemAvailability: Erro ao carregar:", error);
                alert("Erro ao carregar o card√°pio. Por favor, recarregue a p√°gina.");
                disableAllFieldsetsInForm();
            }
        }

         function renderProdutosPrincipais() {
             console.log("renderProdutosPrincipais: Renderizando...");
             if (!boxProdutosPrincipais) return;
             boxProdutosPrincipais.innerHTML = '';

             // A√ßa√≠ (hardcoded, mas poderia vir de allItemsData.acai_sizes)
             boxProdutosPrincipais.innerHTML += `
                 <label class="produto-card" for="size-300" data-product-type="acai" data-price="10.00">
                     <img src="/images/copo-pequeno.jpg" alt="Copo Pequeno" />
                     <input type="radio" name="produtoPrincipal" value="Copo Pequeno (300ml)" id="size-300" required />
                     <div>
                         <strong>Copo Pequeno (300ml)</strong> - R$ 10.00
                         <span>At√© 1 fruta, at√© 1 creme,<br>at√© 3 acompanhamentos,<br>at√© 1 cobertura</span>
                     </div>
                 </label>
                 <label class="produto-card" for="size-500" data-product-type="acai" data-price="15.00">
                     <img src="/images/copo-grande.jpg" alt="Copo Grande" />
                     <input type="radio" name="produtoPrincipal" value="Copo Grande (500ml)" id="size-500" />
                     <div>
                         <strong>Copo Grande (500ml)</strong> - R$ 15.00
                         <span>At√© 2 frutas, at√© 2 cremes,<br>at√© 3 acompanhamentos,<br>at√© 1 cobertura</span>
                     </div>
                 </label>
                 <label class="produto-card" for="size-1L" data-product-type="acai" data-price="40.00">
                     <img src="/images/pote-felicidade.jpg" alt="Pote da Felicidade" />
                     <input type="radio" name="produtoPrincipal" value="Pote da Felicidade (1L)" id="size-1L" />
                     <div>
                         <strong>Pote da Felicidade (1 litro)</strong> - R$ 40.00
                         <span>At√© 3 frutas, at√© 3 cremes,<br>at√© 4 acompanhamentos,<br>at√© 2 coberturas</span>
                     </div>
                 </label>
             `;

             if (copoFelicidadeData) {
                 if (copoFelicidadeData.available) {
                     boxProdutosPrincipais.innerHTML += `
                         <label class="produto-card" for="prod-${copoFelicidadeData.id}" data-product-type="produto_especial" data-product-id="${copoFelicidadeData.id}" data-price="${copoFelicidadeData.price}">
                             <img src="/images/copo-felicidade.jpg" alt="${copoFelicidadeData.name}" />
                             <input type="radio" name="produtoPrincipal" value="${copoFelicidadeData.name}" id="prod-${copoFelicidadeData.id}" />
                             <div>
                                 <strong>${copoFelicidadeData.name}</strong> - R$ ${copoFelicidadeData.price.toFixed(2).replace('.', ',')}
                                 <span>${copoFelicidadeData.description}</span>
                             </div>
                         </label>
                     `;
                     renderCopoFelicidadeFlavors(); // Renderiza sabores se o copo est√° dispon√≠vel
                 } else {
                     boxProdutosPrincipais.innerHTML += `
                         <label class="produto-card disabled-item" title="Indispon√≠vel">
                              <img src="/images/copo-felicidade.jpg" alt="Copo da Felicidade Indispon√≠vel" />
                              <input type="radio" name="produtoPrincipal" value="Copo da Felicidade" disabled />
                              <div>
                                 <strong>Copo da Felicidade</strong> - INDISPON√çVEL
                                 <span>${copoFelicidadeData.description || 'Produto especial temporariamente indispon√≠vel.'}</span>
                             </div>
                         </label>
                     `;
                 }
             } else {
                 console.warn("renderProdutosPrincipais: Dados do Copo da Felicidade n√£o encontrados.");
             }
             console.log("renderProdutosPrincipais: Conclu√≠do.");
         }

         function renderCopoFelicidadeFlavors() {
             console.log("renderCopoFelicidadeFlavors: Renderizando sabores...");
             if (!boxCopoFelicidadeFlavors || !copoFelicidadeData || !copoFelicidadeData.flavors || copoFelicidadeData.flavors.length === 0) {
                 console.warn("renderCopoFelicidadeFlavors: Sem sabores ou container n√£o encontrado.");
                 boxCopoFelicidadeFlavors.innerHTML = '<p>Nenhuma op√ß√£o de sabor dispon√≠vel no momento.</p>';
                 return;
             }
             boxCopoFelicidadeFlavors.innerHTML = '';
             copoFelicidadeData.flavors.forEach(flavor => {
                 // Verifica a disponibilidade do sabor individualmente
                 const flavorDisabled = flavor.available === false ? 'disabled' : '';
                 const labelClass = flavor.available === false ? 'disabled-item' : '';
                 const title = flavor.available === false ? 'Sabor indispon√≠vel' : '';

                 boxCopoFelicidadeFlavors.innerHTML += `
                     <label for="flavor-${flavor.id}" class="${labelClass}" title="${title}">
                         <input type="radio" name="copoFelicidadeFlavor" value="${flavor.name}" id="flavor-${flavor.id}" data-flavor-id="${flavor.id}" required ${flavorDisabled} />
                         <span>${flavor.name}</span>
                         ${flavor.internal_description ? `<small>(${flavor.internal_description})</small>` : ''}
                     </label>
                 `;
             });
             setupRadioListener('copoFelicidadeFlavor'); // Configura listener para os sabores
             console.log("renderCopoFelicidadeFlavors: Conclu√≠do.");
         }

         function setupProdutoPrincipalListeners() {
              console.log("setupProdutoPrincipalListeners: Configurando...");
             document.querySelectorAll('input[name="produtoPrincipal"]').forEach(radio => {
                 if (radio._productListener) {
                     radio.removeEventListener('change', radio._productListener);
                 }
                 const newProductListener = (e) => {
                    console.log("Listener Produto Principal: 'change' em", e.target.value);
                    document.querySelectorAll('.produto-card').forEach(label => label.classList.remove('selected'));
                    e.target.closest('.produto-card:not(.disabled-item)')?.classList.add('selected');

                    resetPartialForItemSelection(); // Limpa sele√ß√µes de item anterior

                    const selectedCard = e.target.closest('.produto-card');
                    const productType = selectedCard?.dataset.productType;
                    const productName = e.target.value;
                    const productPrice = parseFloat(selectedCard?.dataset.price || 0);

                    state.produtoPrincipal = { type: productType, name: productName, price: productPrice, id: selectedCard?.dataset.productId };
                    state.size = (productType === 'acai') ? `${productName} - R$ ${productPrice.toFixed(2).replace('.', ',')}` : undefined;
                    console.log(" -> State ap√≥s sele√ß√£o:", JSON.parse(JSON.stringify(state)));

                    if (productType === 'acai') {
                        console.log(" -> Tipo: A√ßa√≠. Configurando op√ß√µes de a√ßa√≠.");
                        let fMax = 0, cMax = 0, aMax = 0, coMax = 0;
                        if (productName.startsWith('Copo Pequeno')) { fMax = 1; cMax = 1; aMax = 3; coMax = 1; }
                        else if (productName.startsWith('Copo Grande')) { fMax = 2; cMax = 2; aMax = 3; coMax = 1; }
                        else if (productName.startsWith('Pote da Felicidade')) { fMax = 3; cMax = 3; aMax = 4; coMax = 2; }
                        state.fMax = fMax; state.cMax = cMax; state.aMax = aMax; state.coMax = coMax; state.addMax = 14;

                        [fs.frutas, fs.cremes, fs.accomp, fs.cover, fs.askAdd].forEach(enable);
                        disable(fs.copoFelicidadeFlavors); // Garante que sabores do copo est√£o desabilitados

                        setupChecks('boxFrutas', fMax, 'frutas');
                        setupChecks('boxCremes', cMax, 'cremes');
                        setupChecks('boxAccomp', aMax, 'accomp');
                        setupChecks('boxCoverage', coMax, 'cover');
                        // setupChecks para 'add' ser√° chamado por advanceStage('askAdd') se 'Sim' for escolhido
                        setupRadioListener('wantAdd', 'askAdd'); // Configura Sim/N√£o para adicionais

                    } else if (productType === 'produto_especial' && state.produtoPrincipal.id === 'copo_felicidade') {
                        console.log(" -> Tipo: Copo da Felicidade. Configurando sabores.");
                        disableAllAcaiAndAddonFieldsets(); // Desabilita e limpa tudo de a√ßa√≠
                        enable(fs.copoFelicidadeFlavors); // Habilita APENAS sabores
                        // Listeners de sabores j√° configurados por renderCopoFelicidadeFlavors -> setupRadioListener
                    } else {
                        console.warn(" -> Tipo de produto desconhecido:", productType);
                        disableAllAcaiAndAddonFieldsets();
                        disable(fs.copoFelicidadeFlavors);
                    }
                    checkIfCanFinish();
                 };
                 radio.addEventListener('change', newProductListener);
                 radio._productListener = newProductListener;
             });
             console.log("setupProdutoPrincipalListeners: Conclu√≠do.");
         }

        function setupRadioListener(name, stageToAdvanceOnClick) {
            // stageToAdvanceOnClick √© opcional, usado apenas por 'wantAdd'
            console.log(`setupRadioListener: Configurando para "${name}"`);
            document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                 if (r._currentListener) {
                      r.removeEventListener('change', r._currentListener);
                 }
                 const new_listener = ev => {
                     console.log(` -> Listener R√°dio "${name}": 'change'. Valor: ${ev.target.value}`);
                     state[name] = ev.target.value;

                     document.querySelectorAll(`input[name="${name}"]`).forEach(radioEl => {
                         radioEl.closest('label')?.classList.remove('selected-radio');
                     });
                     ev.target.closest('label:not(.disabled-item)')?.classList.add('selected-radio');

                     if (name === 'copoFelicidadeFlavor') {
                         state.selectedCopoFelicidadeFlavor = ev.target.value;
                         console.log("    -> Sabor Copo Felicidade selecionado:", state.selectedCopoFelicidadeFlavor);
                     } else if (name === 'wantAdd' && stageToAdvanceOnClick) {
                         console.log("    -> wantAdd selecionado, avan√ßando para:", stageToAdvanceOnClick);
                         advanceStage(stageToAdvanceOnClick); // S√≥ avan√ßa se for 'wantAdd'
                     }

                     if (name === 'payment') {
                         if (pixInfoDiv) {
                             pixInfoDiv.classList.toggle('hidden', ev.target.value !== 'Pix');
                         }
                     }
                     checkIfCanFinish();
                 };
                 r.addEventListener('change', new_listener);
                 r._currentListener = new_listener;
             });
              console.log(`setupRadioListener: Conclu√≠do para "${name}".`);
         }

        function setupChecks(containerId, max, key) {
             console.log(`setupChecks: Configurando para "${key}" (max: ${max}) em #${containerId}`);
             const box = document.getElementById(containerId);
             if (!box) return;
             const counterEl = cnt[key];
             const allCheckboxesInBox = box.querySelectorAll('input[type=checkbox]');
             const noneValue = key === 'add' ? 'Nenhum Adicional' : 'Nenhuma';
             const noneCheckbox = box.querySelector(`input[value="${noneValue}"]`);

             state[key] = state[key] || [];
             state[key] = state[key].filter(itemName => { // Filtra itens que podem ter sido desabilitados
                 const chk = Array.from(allCheckboxesInBox).find(c => c.value === itemName);
                 return chk && !chk.disabled;
             });

             const initialCount = state[key].includes(noneValue) ? 0 : state[key].filter(item => item !== noneValue).length;
             updateCounter(counterEl, initialCount, max);

             if (state[key].length === 0 && noneCheckbox && noneCheckbox.checked && !noneCheckbox.disabled) {
                 state[key] = [noneValue];
             }

             allCheckboxesInBox.forEach(chk => {
                 if (chk._currentListener) {
                     chk.removeEventListener('change', chk._currentListener);
                 }
                 const new_listener = () => {
                    console.log(` -> Listener Checkbox "${chk.value}" (${key}): 'change'. Checado: ${chk.checked}`);
                    if (chk.disabled && !chk.value.toLowerCase().includes("nenhum")) { // Ignora clique em desabilitados (exceto "Nenhum")
                        return;
                    }

                    const currentSelectedInBox = [...box.querySelectorAll('input[type=checkbox]:checked:not([disabled])')];
                    const isNoneChecked = noneCheckbox && noneCheckbox.checked;

                    if (noneCheckbox) {
                        if (chk === noneCheckbox && chk.checked) { // "Nenhuma" foi marcado
                            allCheckboxesInBox.forEach(otherChk => {
                                if (otherChk !== noneCheckbox && !otherChk.disabled) otherChk.checked = false;
                            });
                            state[key] = [noneValue];
                        } else if (chk !== noneCheckbox && chk.checked && isNoneChecked) { // Outro item marcado enquanto "Nenhuma" estava
                            if (!noneCheckbox.disabled) noneCheckbox.checked = false;
                            state[key] = currentSelectedInBox.filter(c => c !== noneCheckbox).map(i => i.value);
                        } else { // Caso geral ou "Nenhuma" foi desmarcado
                            state[key] = currentSelectedInBox.map(i => i.value);
                            // Se ap√≥s a sele√ß√£o, nada est√° marcado e "Nenhuma" existe e n√£o est√° desabilitado, marca "Nenhuma"
                            if (state[key].length === 0 && noneCheckbox && !noneCheckbox.disabled) {
                                noneCheckbox.checked = true;
                                state[key] = [noneValue];
                            } else if (state[key].length > 0 && noneCheckbox && noneCheckbox.checked && !noneCheckbox.disabled) {
                                // Se algo foi selecionado e "Nenhuma" ainda est√° checado, desmarca "Nenhuma"
                                noneCheckbox.checked = false;
                                state[key] = state[key].filter(item => item !== noneValue);
                            }
                        }
                    } else { // Sem op√ß√£o "Nenhuma"
                        state[key] = currentSelectedInBox.map(i => i.value);
                    }

                    const actualSelectedCount = state[key].includes(noneValue) ? 0 : state[key].filter(item => item !== noneValue).length;
                    console.log(`    -> Sele√ß√£o atual para "${key}":`, state[key], `Contagem: ${actualSelectedCount}`);

                    if (max !== undefined && actualSelectedCount > max) {
                        chk.checked = false; // Desmarca o √∫ltimo
                        // Recalcula o estado ap√≥s desmarcar
                        const finalSelectedAfterLimit = [...box.querySelectorAll('input[type=checkbox]:checked:not([disabled])')];
                        state[key] = finalSelectedAfterLimit.map(c => c.value);
                        if (state[key].length === 0 && noneCheckbox && !noneCheckbox.disabled) { // Se "Nenhuma" deveria ser marcado
                             noneCheckbox.checked = true; state[key] = [noneValue];
                        }
                        const finalCountAfterLimit = state[key].includes(noneValue) ? 0 : state[key].filter(item => item !== noneValue).length;
                        updateCounter(counterEl, finalCountAfterLimit, max);
                        alert(`M√°ximo ${max} ${key === 'add' ? 'adicionais' : key}.`);
                        return;
                    }

                    updateCounter(counterEl, actualSelectedCount, max);
                    checkIfCanFinish();
                 };
                 chk.addEventListener('change', new_listener);
                 chk._currentListener = new_listener;
             });
             console.log(`setupChecks: Conclu√≠do para "${key}".`);
         }

        function updateCounter(element, count, max) {
             if (element) {
                 element.textContent = `( ${count} / ${max !== undefined ? max : '?'} )`;
                 element.style.display = 'inline';
             }
         }

        function advanceStage(stage) { // Usado principalmente por 'wantAdd'
             console.log("advanceStage: Avan√ßando para", stage, "State:", JSON.parse(JSON.stringify(state)));
             switch (stage) {
                 case 'askAdd': // Chamado quando 'wantAdd' √© selecionado
                     if (state.wantAdd === 'Sim') {
                         enable(fs.add);
                         setupChecks('boxAdd', state.addMax, 'add'); // Configura e limpa checkboxes de adicionais
                         const currentAddCount = state.add ? state.add.filter(item => item !== 'Nenhum Adicional').length : 0;
                         updateCounter(cnt.add, currentAddCount, state.addMax);
                     } else if (state.wantAdd === 'N√£o') {
                         state.add = ['Nenhum Adicional']; // Define estado
                         disable(fs.add);
                         clearCheckboxes(fs.add); // Limpa visualmente
                         updateCounter(cnt.add, 0, state.addMax);
                     }
                     break;
             }
             checkIfCanFinish(); // Sempre verifica ap√≥s uma mudan√ßa de est√°gio
         }

        function checkIfCanFinish() {
            console.log("checkIfCanFinish: Verificando...");
            const itemValid = validateCurrentOrderItem();
            const paymentSelected = state.payment && !fs.payment.hasAttribute('disabled');
            const deliverySelected = state.delivery && !fs.delivery.hasAttribute('disabled');

            console.log(`  -> Item v√°lido: ${itemValid}, Pagamento: ${paymentSelected} (${state.payment}), Entrega: ${deliverySelected} (${state.delivery})`);

            const canProceed = itemValid && paymentSelected && deliverySelected;

            btnAdd.disabled = !canProceed;
            // O bot√£o Finalizar √© habilitado se:
            // 1. O item atual √© v√°lido E pagamento/entrega est√£o selecionados (canProceed √© true)
            // OU
            // 2. J√° existem itens no pedido (orders.length > 0) E pagamento/entrega est√£o selecionados (mesmo que o item ATUAL n√£o esteja completo)
            btnFinish.disabled = !(canProceed || (orders.length > 0 && paymentSelected && deliverySelected));

            console.log(`  -> btnAdd.disabled: ${btnAdd.disabled}, btnFinish.disabled: ${btnFinish.disabled}`);
        }

        function renderOrders() {
            console.log("renderOrders: Renderizando. Pedidos:", orders);
            ordersSec.style.display = orders.length > 0 ? 'block' : 'none';
            ordersList.innerHTML = '';
            let totalGeralItensPagina = 0;
            let taxaEntregaPagina = 0;
            let localEntregaPagina = "Retirada";

            orders.forEach((orderItem, i) => {
                const li = document.createElement('li');
                let itemDetailsHtml = '';
                let subTotalItem = 0;

                if (orderItem.produtoPrincipal?.type === 'produto_especial' && orderItem.produtoPrincipal?.id === 'copo_felicidade') {
                    itemDetailsHtml += `Sabor: ${orderItem.selectedCopoFelicidadeFlavor || 'N√£o especificado'}`;
                    subTotalItem = orderItem.produtoPrincipal.price || 0;
                    // Adicionais podem ser extras para o Copo da Felicidade
                    if (orderItem.add && orderItem.add.length > 0 && !orderItem.add.includes('Nenhum Adicional')) {
                        const adicionaisLista = orderItem.add.map(item => {
                            const parts = item.split(' - R$ ');
                            if (parts.length === 2) subTotalItem += parseFloat(parts[1].replace(',', '.'));
                            return parts[0];
                        }).join(', ');
                        itemDetailsHtml += `<br> Adicionais (Extras): ${adicionaisLista}`;
                    } else {
                        itemDetailsHtml += `<br> Adicionais (Extras): Nenhum`;
                    }
                    li.innerHTML = `<strong>Item ${i + 1}:</strong> ${orderItem.produtoPrincipal?.name || 'Produto Especial'}<br>${itemDetailsHtml}<br><strong>Subtotal do Item: R$ ${subTotalItem.toFixed(2).replace('.', ',')}</strong>`;
                } else { // A√ßa√≠
                    const displayFrutas = orderItem.frutas?.length > 0 && !orderItem.frutas.includes('Nenhuma') ? orderItem.frutas.join(', ') : 'Nenhuma';
                    const displayCremes = orderItem.cremes?.length > 0 && !orderItem.cremes.includes('Nenhuma') ? orderItem.cremes.join(', ') : 'Nenhum';
                    const displayAccomp = orderItem.accomp?.length > 0 && !orderItem.accomp.includes('Nenhuma') ? orderItem.accomp.join(', ') : 'Nenhum';
                    const displayCover = orderItem.cover?.length > 0 && !orderItem.cover.includes('Nenhuma') ? orderItem.cover.join(', ') : 'Nenhuma';
                    itemDetailsHtml += `Frutas: ${displayFrutas}<br>Cremes: ${displayCremes}<br>Acompanhamentos: ${displayAccomp}<br>Coberturas: ${displayCover}<br>`;

                    let displayAdd = 'Nenhum Adicional';
                    if (orderItem.add && orderItem.add.length > 0 && !orderItem.add.includes('Nenhum Adicional')) {
                        displayAdd = orderItem.add.map(item => item.split(' - R$ ')[0]).join(', ');
                    }
                    itemDetailsHtml += `Adicionais: ${displayAdd}`;

                    const priceMatch = orderItem.size?.match(/R\$ (\d+[,.]\d{2})/);
                    subTotalItem = priceMatch ? parseFloat(priceMatch[1].replace(',', '.')) : (orderItem.produtoPrincipal?.price || 0) ;

                    if (orderItem.add && !orderItem.add.includes('Nenhum Adicional')) {
                        orderItem.add.forEach(addon => {
                            if (addon.includes('R$')) {
                                const addonPriceMatch = addon.match(/R\$ (\d+[,.]\d{2})/);
                                if (addonPriceMatch) subTotalItem += parseFloat(addonPriceMatch[1].replace(',', '.'));
                            }
                        });
                    }
                    const displaySizeName = orderItem.produtoPrincipal?.name || (orderItem.size ? orderItem.size.split(' - R$ ')[0] : 'A√ßa√≠');
                    li.innerHTML = `<strong>Item ${i + 1}:</strong> ${displaySizeName}<br>${itemDetailsHtml}<br><strong>Subtotal do Item: R$ ${subTotalItem.toFixed(2).replace('.', ',')}</strong>`;
                }
                totalGeralItensPagina += subTotalItem;

                // Pega informa√ß√µes de entrega do PRIMEIRO item para o total da p√°gina
                if (i === 0 && orderItem.delivery) {
                    localEntregaPagina = orderItem.delivery.split(' - R$ ')[0];
                    if (orderItem.delivery.includes('R$')) {
                        const deliveryPriceMatch = orderItem.delivery.match(/R\$ (\d+[,.]\d{2})/);
                        if (deliveryPriceMatch) taxaEntregaPagina = parseFloat(deliveryPriceMatch[1].replace(',', '.'));
                    }
                }
                ordersList.appendChild(li);
            });

            let totalFinalPagina = totalGeralItensPagina;
            if (localEntregaPagina !== "Retirada" && taxaEntregaPagina > 0) {
                totalFinalPagina += taxaEntregaPagina;
            }

            if (orderPageTotalValueEl) orderPageTotalValueEl.textContent = totalFinalPagina.toFixed(2).replace('.', ',');
            console.log("renderOrders: Total na p√°gina atualizado:", totalFinalPagina);
        }

        function generateSummaryText() {
            console.log("generateSummaryText: Gerando. Pedidos:", orders);
            if (orders.length === 0) return "Nenhum item no pedido.";

            let summaryText = "Blue A√ßa√≠ - Novo Pedido!\n\n";
            let totalGeralPedido = 0;
            let deliveryFee = 0;
            let deliveryLocation = "Retirada";
            let paymentMethod = orders[0].payment || "N√£o especificado"; // Pega do primeiro item

            orders.forEach((orderItem, i) => {
                let subTotalItem = 0;
                summaryText += `*Item ${i + 1}:*\n`;

                if (orderItem.produtoPrincipal?.type === 'produto_especial' && orderItem.produtoPrincipal?.id === 'copo_felicidade') {
                    summaryText += `Produto: ${orderItem.produtoPrincipal.name}\n`;
                    summaryText += `Sabor: ${orderItem.selectedCopoFelicidadeFlavor || 'N/A'}\n`;
                    subTotalItem = orderItem.produtoPrincipal.price || 0;
                    if (orderItem.add && orderItem.add.length > 0 && !orderItem.add.includes('Nenhum Adicional')) {
                        const adicionaisNomes = orderItem.add.map(a => a.split(' - R$ ')[0]).join(', ');
                        summaryText += `Adicionais (Extras): ${adicionaisNomes}\n`;
                        orderItem.add.forEach(addon => {
                             const pricePart = addon.split(' - R$ ')[1];
                             if(pricePart) subTotalItem += parseFloat(pricePart.replace(',', '.'));
                        });
                    } else {
                         summaryText += `Adicionais (Extras): Nenhum\n`;
                    }
                } else { // A√ßa√≠
                    summaryText += `Produto: ${orderItem.produtoPrincipal?.name || orderItem.size?.split(' - R$ ')[0]}\n`;
                    summaryText += `Frutas: ${orderItem.frutas?.includes('Nenhuma') ? 'Nenhuma' : (orderItem.frutas?.join(', ') || 'Nenhuma')}\n`;
                    summaryText += `Cremes: ${orderItem.cremes?.includes('Nenhuma') ? 'Nenhuma' : (orderItem.cremes?.join(', ') || 'Nenhum')}\n`;
                    summaryText += `Acompanhamentos: ${orderItem.accomp?.includes('Nenhuma') ? 'Nenhuma' : (orderItem.accomp?.join(', ') || 'Nenhum')}\n`;
                    summaryText += `Coberturas: ${orderItem.cover?.includes('Nenhuma') ? 'Nenhuma' : (orderItem.cover?.join(', ') || 'Nenhuma')}\n`;

                    const priceMatch = orderItem.size?.match(/R\$ (\d+[,.]\d{2})/);
                    subTotalItem = priceMatch ? parseFloat(priceMatch[1].replace(',', '.')) : (orderItem.produtoPrincipal?.price || 0);

                    if (orderItem.add && !orderItem.add.includes('Nenhum Adicional')) {
                        const adicionaisNomes = orderItem.add.map(a => a.split(' - R$ ')[0]).join(', ');
                        summaryText += `Adicionais: ${adicionaisNomes}\n`;
                        orderItem.add.forEach(addon => {
                            const pricePart = addon.split(' - R$ ')[1];
                            if(pricePart) subTotalItem += parseFloat(pricePart.replace(',', '.'));
                        });
                    } else {
                        summaryText += `Adicionais: Nenhum Adicional\n`;
                    }
                }
                summaryText += `Subtotal do Item: R$ ${subTotalItem.toFixed(2).replace('.', ',')}\n\n`;
                totalGeralPedido += subTotalItem;

                if (i === 0) { // Pega entrega do primeiro item para o resumo geral
                    deliveryLocation = orderItem.delivery ? orderItem.delivery.split(' - R$ ')[0] : "Retirada";
                    if (orderItem.delivery && orderItem.delivery.includes('R$')) {
                        const deliveryPriceMatch = orderItem.delivery.match(/R\$ (\d+[,.]\d{2})/);
                        if (deliveryPriceMatch) deliveryFee = parseFloat(deliveryPriceMatch[1].replace(',', '.'));
                    }
                }
            });

            summaryText += `------------------------------\n`;
            summaryText += `*Forma de Pagamento:* ${paymentMethod}\n`;
            summaryText += `*Entrega/Retirada:* ${deliveryLocation}\n`;
            if (deliveryLocation !== "Retirada" && deliveryFee > 0) {
                summaryText += `*Taxa de Entrega:* R$ ${deliveryFee.toFixed(2).replace('.', ',')}\n`;
                totalGeralPedido += deliveryFee;
            } else if (deliveryLocation !== "Retirada" && deliveryFee === 0) {
                 summaryText += `*Taxa de Entrega:* (A combinar ou inclusa)\n`;
            }

            summaryText += `*TOTAL GERAL DO PEDIDO: R$ ${totalGeralPedido.toFixed(2).replace('.', ',')}*\n`;
            summaryEl.textContent = summaryText;
            console.log("generateSummaryText: Resumo gerado:", summaryText);
            return summaryText;
        }


        btnAdd.onclick = () => {
            console.log("btnAdd: Clicado. State:", JSON.parse(JSON.stringify(state)));
            if (isOrderReadyToAdd() && state.payment && state.delivery) { // Adiciona o item se ele E payment/delivery estiverem OK
                // Deep copy do state para o array orders
                // Importante: payment e delivery s√£o definidos no 'state' atual.
                // Cada item em 'orders' vai ter seu pr√≥prio payment/delivery,
                // mas para o resumo final, vamos usar o do PRIMEIRO item da lista.
                orders.push(JSON.parse(JSON.stringify(state)));
                console.log(" -> Item adicionado. Pedidos:", orders);

                renderOrders(); // Atualiza a lista visual de itens na p√°gina

                // Prepara para o pr√≥ximo item, mantendo payment e delivery
                const savedPayment = state.payment;
                const savedDelivery = state.delivery;
                resetPartialForItemSelection(); // Limpa produto, a√ßa√≠, sabores
                state.payment = savedPayment; // Restaura payment
                state.delivery = savedDelivery; // Restaura delivery

                // Re-seleciona visualmente payment e delivery
                if (savedPayment) document.querySelector(`input[name="payment"][value="${savedPayment}"]`)?.closest('label')?.classList.add('selected-radio');
                if (savedDelivery) document.querySelector(`input[name="delivery"][value="${savedDelivery}"]`)?.closest('label')?.classList.add('selected-radio');

                document.querySelectorAll('.produto-card').forEach(label => label.classList.remove('selected'));
                checkIfCanFinish(); // Reavalia bot√µes (btnAdd deve ficar desabilitado, btnFinish pode continuar habilitado)
            } else {
                console.log(" -> Item n√£o pronto ou pagamento/entrega pendente.");
                alert("Por favor, complete todas as sele√ß√µes obrigat√≥rias do item atual, incluindo forma de pagamento e entrega/retirada, antes de adicionar.");
            }
        };

        btnFinish.onclick = async () => {
            console.log("btnFinish: Clicado. State:", JSON.parse(JSON.stringify(state)), "Pedidos:", orders);

            // Verifica se o item ATUAL est√° completo e se pagamento/entrega est√£o selecionados
            const currentItemCompletelyValid = validateCurrentOrderItem() && state.payment && state.delivery;

            if (currentItemCompletelyValid) {
                const lastOrderClean = orders.length > 0 ? JSON.stringify(cleanOrderForComparison(orders[orders.length - 1])) : null;
                const currentStateClean = JSON.stringify(cleanOrderForComparison(state));

                if (!lastOrderClean || currentStateClean !== lastOrderClean) {
                    console.log(" -> Item atual v√°lido e diferente do √∫ltimo, adicionando...");
                    orders.push(JSON.parse(JSON.stringify(state)));
                } else {
                    console.log(" -> Item atual v√°lido, mas √© um duplicado do √∫ltimo. N√£o adicionando novamente.");
                }
            } else if (orders.length === 0) {
                console.log(" -> Nenhum item na lista e item atual incompleto.");
                alert("Seu pedido est√° vazio ou o item atual n√£o foi completamente preenchido (incluindo pagamento e entrega).");
                return;
            }
            // Se chegou aqui, ou o item atual foi adicionado, ou j√° havia itens em 'orders'.

            if (orders.length > 0) {
                console.log(" -> Processando envio. Pedidos a enviar:", orders);
                renderOrders(); // Garante que a lista visual est√° atualizada
                const summaryTextContent = generateSummaryText();

                const phoneNumber = '5598985016035'; // Seu n√∫mero de WhatsApp
                const encodedText = encodeURIComponent(summaryTextContent);
                const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedText}`;

                // Monta o payload para o servidor
                let payloadTotalGeral = 0;
                const payloadItems = orders.map(order => {
                    let itemSubTotal = 0;
                    const itemDetails = {
                        produto: order.produtoPrincipal.name,
                        tipo: order.produtoPrincipal.type,
                        // Adicione outros campos conforme necess√°rio para o backend
                    };
                    if (order.produtoPrincipal.type === 'acai') {
                        itemDetails.tamanho = order.produtoPrincipal.name;
                        itemDetails.frutas = order.frutas?.join(', ') || 'Nenhuma';
                        itemDetails.cremes = order.cremes?.join(', ') || 'Nenhum';
                        itemDetails.acompanhamentos = order.accomp?.join(', ') || 'Nenhum';
                        itemDetails.coberturas = order.cover?.join(', ') || 'Nenhuma';
                        itemDetails.adicionais = (order.add && !order.add.includes('Nenhum Adicional')) ? order.add.map(a => a.split(' - R$')[0]).join(', ') : 'Nenhum';
                        
                        itemSubTotal = order.produtoPrincipal.price;
                         if (order.add && !order.add.includes('Nenhum Adicional')) {
                            order.add.forEach(addon => {
                                const pricePart = addon.split(' - R$ ')[1];
                                if (pricePart) itemSubTotal += parseFloat(pricePart.replace(',', '.'));
                            });
                        }
                    } else if (order.produtoPrincipal.type === 'produto_especial' && order.produtoPrincipal.id === 'copo_felicidade') {
                        itemDetails.sabor = order.selectedCopoFelicidadeFlavor;
                         itemDetails.adicionaisExtras = (order.add && !order.add.includes('Nenhum Adicional')) ? order.add.map(a => a.split(' - R$')[0]).join(', ') : 'Nenhum';
                        itemSubTotal = order.produtoPrincipal.price;
                        if (order.add && !order.add.includes('Nenhum Adicional')) {
                             order.add.forEach(addon => {
                                const pricePart = addon.split(' - R$ ')[1];
                                if (pricePart) itemSubTotal += parseFloat(pricePart.replace(',', '.'));
                            });
                        }
                    }
                    itemDetails.subTotalItem = parseFloat(itemSubTotal.toFixed(2));
                    payloadTotalGeral += itemSubTotal;
                    return itemDetails;
                });

                let taxaEntregaServidor = 0;
                if (orders[0].delivery && orders[0].delivery.includes('R$')) {
                    const matchTaxa = orders[0].delivery.match(/R\$ (\d+[,.]\d{2})/);
                    if (matchTaxa) taxaEntregaServidor = parseFloat(matchTaxa[1].replace(',', '.'));
                }
                if (orders[0].delivery.split(' - R$ ')[0] !== "Retirada") {
                     payloadTotalGeral += taxaEntregaServidor;
                }

                const payloadParaServidor = {
                    itensDoPedido: payloadItems,
                    valorTotalPedido: parseFloat(payloadTotalGeral.toFixed(2)),
                    metodoPagamento: orders[0].payment,
                    tipoEntrega: orders[0].delivery.split(' - R$')[0], // Apenas o nome da entrega
                    taxaEntrega: taxaEntregaServidor,
                    resumoCompleto: summaryTextContent
                };
                console.log(" -> Payload para servidor:", JSON.stringify(payloadParaServidor, null, 2));

                try {
                    const response = await fetch('/api/orders', { // Certifique-se que esta rota existe
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payloadParaServidor),
                    });

                    if (response.ok) {
                        console.log(' -> Pedido enviado ao servidor com sucesso!');
                        orders = []; // Limpa pedidos locais
                        await resetForm(); // Reseta tudo
                        console.log(" -> Redirecionando para WhatsApp...");
                        window.location.href = whatsappURL;
                    } else {
                        const errorText = await response.text();
                        console.error(' -> Falha ao enviar pedido ao servidor:', response.status, errorText);
                        alert(`Houve um erro ao registrar seu pedido (Status: ${response.status}). Por favor, tente novamente ou envie seu pedido manualmente pelo WhatsApp.`);
                        // N√£o reseta se falhar, permite que o usu√°rio tente enviar o resumo manualmente
                        // Os bot√µes de a√ß√£o j√° estar√£o desabilitados por checkIfCanFinish se o estado n√£o for v√°lido
                    }
                } catch (error) {
                    console.error(' -> Erro na chamada fetch:', error);
                    alert("Ocorreu um erro de conex√£o ao enviar seu pedido. Por favor, verifique sua internet ou envie seu pedido manualmente pelo WhatsApp.");
                }
                // Ap√≥s a tentativa de envio, desabilitar os bot√µes para evitar m√∫ltiplos envios
                // Se o envio for bem-sucedido, resetForm() j√° cuidar√° disso.
                // Se falhar, o usu√°rio pode precisar interagir novamente.
                // A chamada checkIfCanFinish() no final de outras intera√ß√µes cuidar√° de reabilit√°-los se apropriado.
                // Para garantir, podemos desabilit√°-los aqui se a l√≥gica de reset n√£o for chamada.
                 if (!response || !response.ok) { // Se a resposta n√£o foi OK
                     btnAdd.disabled = true;
                     btnFinish.disabled = true;
                 }

            } else {
                console.log(" -> Nenhum item v√°lido no pedido para finalizar.");
                alert("Adicione pelo menos um item completo ao seu pedido antes de finalizar.");
            }
        };

        // Fun√ß√£o para limpar um objeto de pedido para compara√ß√£o (remove chaves din√¢micas/irrelevantes para unicidade do item)
        function cleanOrderForComparison(orderState) {
            if (!orderState) return null;
            const clean = { ...orderState };
            delete clean.fMax; delete clean.cMax; delete clean.aMax; delete clean.coMax; delete clean.addMax;
            // Payment e Delivery s√£o do pedido geral, n√£o do item espec√≠fico para compara√ß√£o de duplicidade de item
            // No entanto, se voc√™ os armazena POR ITEM no array 'orders', pode querer mant√™-los
            // para a l√≥gica de "o item atual √© diferente do √∫ltimo adicionado".
            // Para simplificar a detec√ß√£o de "item duplicado", vou remover.
            delete clean.payment;
            delete clean.delivery;
            return clean;
        }


        btnCancel.onclick = async () => {
            console.log("btnCancel: Clicado.");
            if (confirm("Tem certeza que deseja cancelar o pedido atual e limpar todas as sele√ß√µes?")) {
                orders = [];
                await resetForm(); // resetForm agora √© async por causa do fetch
                console.log(" -> Pedido cancelado e formul√°rio resetado.");
            }
        };

        // Reseta completamente o formul√°rio e a lista de pedidos
         async function resetForm() {
             console.log("resetForm: Resetando formul√°rio completo...");
             state = {};
             orders = []; // Limpa a lista de itens do pedido

             renderOrders(); // Esconde se√ß√£o de pedidos e zera total

             if(pixInfoDiv) pixInfoDiv.classList.add('hidden');

             // Limpa todos os inputs visuais ANTES de buscar novos dados
             form.querySelectorAll('input[type="checkbox"]:not([disabled])').forEach(chk => chk.checked = false);
             form.querySelectorAll('input[type="radio"]:not([disabled])').forEach(r => r.checked = false);
             document.querySelectorAll('.selected-radio').forEach(label => label.classList.remove('selected-radio'));
             document.querySelectorAll('.produto-card').forEach(label => label.classList.remove('selected'));

             // Desabilita todos os fieldsets inicialmente, exceto o de produto principal
             // fetchAndApplyItemAvailability vai reabilitar payment e delivery
             const allFieldsets = form.querySelectorAll('fieldset');
             allFieldsets.forEach(fset => {
                 if (fset.id !== 'fsProdutoPrincipal') disable(fset);
                 else enable(fset);
             });
             disable(fs.copoFelicidadeFlavors); // Garante que sabores do copo come√ßam desabilitados


             // Re-busca e aplica disponibilidade (isso tamb√©m configura listeners principais)
             await fetchAndApplyItemAvailability();


             // Reseta contadores
             updateCounter(cnt.frutas, 0, '?'); updateCounter(cnt.cremes, 0, '?');
             updateCounter(cnt.accomp, 0, '?'); updateCounter(cnt.cover, 0, '?');
             updateCounter(cnt.add, 0, 14);

             btnAdd.disabled = true;
             btnFinish.disabled = true;
             console.log("resetForm: Conclu√≠do.");
         }

        // Fun√ß√£o para desabilitar todos os fieldsets no formul√°rio
         function disableAllFieldsetsInForm() {
              console.log("disableAllFieldsetsInForm: Desabilitando todos os fieldsets.");
             form.querySelectorAll('fieldset').forEach(disable);
         }


        // --- CHAMADA INICIAL ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM completamente carregado e parseado.");
            resetForm(); // Inicia o formul√°rio e busca os dados de itens
        });
    </script>
</body>
</html>
