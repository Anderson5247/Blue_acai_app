<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blue A√ßa√≠ ‚Äì Card√°pio Interativo</title>
    <style>
        :root {
            --purple: #5A0F8D;
            --light-purple: #F3E5FF;
            --dark-text: #333;
            --card-bg: #fff;
            --danger-red: #dc3545;
            --danger-red-hover: #c82333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--light-purple);
            color: var(--dark-text);
        }

        header {
            background: var(--purple);
            color: #fff;
            text-align: center;
            padding: 1rem;
        }

        header img {
            max-width: 120px;
            margin-bottom: .5rem;
        }

        main {
            max-width: 800px;
            margin: 1rem auto;
            padding: 0 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        fieldset {
            border: none;
            margin: 1rem 0;
            transition: opacity .3s;
        }

        fieldset[disabled] {
            opacity: .6;
        }

        fieldset[disabled] label {
             pointer-events: none;
        }


        legend {
            font-weight: bold;
            margin-bottom: .5rem;
            color: var(--purple);
        }

        legend .section-status {
            font-weight: normal;
            font-size: 0.85em;
            color: #666;
            margin-left: 5px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: .75rem;
        }

        label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: .95rem;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        label:hover:not(.disabled-item) {
            background-color: #f0f0f0;
        }

        label.disabled-item {
            text-decoration: line-through;
            color: #aaa !important;
            cursor: not-allowed;
            pointer-events: none;
        }

        label input[type="checkbox"],
        label input[type="radio"] {
            margin-right: .5rem;
            cursor: pointer;
        }

        label input[type="checkbox"]:disabled,
        label input[type="radio"]:disabled {
            cursor: not-allowed;
        }

        .counter {
            margin-left: .5rem;
            color: var(--purple);
            font-weight: normal;
            font-size: .9rem;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: .75rem;
            margin-top: 1.5rem;
        }

        .buttons button {
            padding: .75rem;
            border: none;
            border-radius: 4px;
            background: var(--purple);
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .buttons button#btnCancel {
            background-color: var(--danger-red);
        }
        .buttons button#btnCancel:hover:not(:disabled) {
            background-color: var(--danger-red-hover);
        }

        .buttons button:hover:not(:disabled) {
            background-color: #4a0c74;
        }

        .buttons button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #summary {
            display: none;
            white-space: pre-wrap;
        }

        #ordersSection {
            border-top: 2px solid var(--purple);
            margin-top: 1.5rem;
            padding-top: 1rem;
        }

        #ordersList li {
            margin-bottom: .75rem;
            list-style: none;
            padding-left: 1.5rem;
            position: relative;
            border-bottom: 1px dashed #eee;
            padding-bottom: 0.5rem;
        }

        #ordersList li::before {
            content: 'üç¶';
            position: absolute;
            left: 0;
            top: 0;
            font-size: 0.9em;
        }
        
        .order-item-actions {
            margin-top: 8px;
        }
        
        .btn-repeat {
            background: #f0f0f0;
            border: 1px solid #ddd;
            color: #333;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .btn-repeat:hover {
            background-color: #e0e0e0;
        }


        .produtos-opcoes { display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin-top: 1rem; }
        .produto-card { background: var(--card-bg); border: 2px solid #ccc; border-radius: 10px; padding: 1rem; width: 210px; text-align: center; transition: 0.3s; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; position: relative; }
        .produto-card input[type="radio"] {
            position: absolute;
            top: 10px;
            right: 10px;
            transform: scale(1.3);
            cursor: pointer;
            accent-color: var(--purple);
            z-index: 2;
        }
        .produto-card:hover { border-color: var(--purple); transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12); }
        label.produto-card.selected { border-color: var(--purple); box-shadow: 0 5px 10px rgba(90, 15, 141, 0.2); background-color: #faf5ff; }
        .produto-card img { width: 100%; max-height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 0.75rem; }
        .produto-card strong { font-size: 1rem; color: #333; display: block; margin-top: 0.5rem; }
        .produto-card span { font-size: 0.85rem; color: #555; margin-top: 0.25rem; display: block; line-height: 1.3; }
        
        .pix-info-container {
            background-color: #fdf1ff;
            border: 1px solid var(--purple);
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        .pix-info-container.hidden {
            display: none;
        }
        .pix-info-container h3 { color: var(--purple); margin-bottom: 0.75rem; }
        .pix-info-container p { margin-bottom: 0.5rem; line-height: 1.4; }
        .pix-info-container small { color: #555; font-style: italic; }

        #orderPageTotal {
            text-align: right; margin-top: 1rem; font-weight: bold;
            font-size: 1.1em; padding: 0.75rem; background-color: #f0f0f0;
            border-top: 1px solid #ddd; border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .special-flavors-fs {
             display: none; /* Hide by default */
        }
        .special-flavors-fs.active {
             display: block; /* Show when active */
        }
         .special-flavors-fs .grid-2 label {
             border: 1px solid #ccc;
             padding: 10px;
             border-radius: 5px;
             background-color: #f9f9f9;
             display: flex;
             align-items: center;
        }
         .special-flavors-fs .grid-2 label.selected-radio {
             border-color: var(--purple);
             background-color: #e9d8f3;
             font-weight: bold;
         }
         .special-flavors-fs .grid-2 label input[type="radio"] {
             margin-right: 0.5rem;
             cursor: pointer;
             accent-color: var(--purple);
         }
          .special-flavors-fs .grid-2 label small {
             display: block;
             font-size: 0.8em;
             color: #555;
             margin-left: 1.5rem;
             margin-top: 0.2em;
             font-weight: normal;
          }
           .special-flavors-fs .grid-2 label span {
             display: inline;
             font-weight: bold;
           }
    </style>
</head>
<body>
    <header>
        <img src="/images/logo.png" alt="Logomarca Blue A√ßa√≠" />
        <h1>Blue A√ßa√≠</h1>
        <p>Monte seu a√ßa√≠ como quiser!</p>
    </header>
    <main>
        <div class="card">
            <form id="formPedido">
                <fieldset id="fsProdutoPrincipal">
                     <legend>1. Escolha o Produto <span class="section-status">(Obrigat√≥rio)</span></legend>
                     <div class="produtos-opcoes" id="boxProdutosPrincipais"></div>
                </fieldset>

                <div id="specialFlavorsContainer"></div>

                <fieldset id="fsFrutas" disabled><legend>2. Frutas <span id="cntFrutas" class="counter">(0/?)</span></legend><div class="grid-2" id="boxFrutas"><label for="chk-morango"><input type="checkbox" value="Morango" id="chk-morango" data-item-id="morango" />Morango</label><label for="chk-banana"><input type="checkbox" value="Banana" id="chk-banana" data-item-id="banana" />Banana</label><label for="chk-kiwi"><input type="checkbox" value="Kiwi" id="chk-kiwi" data-item-id="kiwi" />Kiwi</label><label for="chk-maca"><input type="checkbox" value="Ma√ß√£" id="chk-maca" data-item-id="maca" />Ma√ß√£</label><label for="chk-uva"><input type="checkbox" value="Uva" id="chk-uva" data-item-id="uva" />Uva</label><label for="chk-frutas-nenhuma"><input type="checkbox" value="Nenhuma" id="chk-frutas-nenhuma" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsCremes" disabled><legend>3. Cremes <span id="cntCremes" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCremes"><label for="chk-ninho"><input type="checkbox" value="Ninho" id="chk-ninho" data-item-id="ninho" />Ninho</label><label for="chk-maracuja"><input type="checkbox" value="Maracuj√°" id="chk-maracuja" data-item-id="maracuja" />Maracuj√°</label><label for="chk-morango-creme"><input type="checkbox" value="Morango (Creme)" id="chk-morango-creme" data-item-id="morango_creme" />Morango (Creme)</label><label for="chk-tutti-frutti-creme"><input type="checkbox" value="Tutti Frutti (Creme)" id="chk-tutti-frutti-creme" data-item-id="tutti_frutti_creme" />Tutti Frutti (Creme)</label><label for="chk-chocolate-avela"><input type="checkbox" value="Chocolate com Avel√£" id="chk-chocolate-avela" data-item-id="chocolate_avela" />Chocolate c/Avel√£</label><label for="chk-cremes-nenhum"><input type="checkbox" value="Nenhuma" id="chk-cremes-nenhum"/>Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsAccomp" disabled><legend>4. Acompanhamentos <span id="cntAccomp" class="counter">(0/?)</span></legend><div class="grid-2" id="boxAccomp"><label for="chk-amendoim-acomp"><input type="checkbox" value="Amendoim" id="chk-amendoim-acomp" data-item-id="amendoim_acomp" />Amendoim</label><label for="chk-pacoca-acomp"><input type="checkbox" value="Pa√ßoca" id="chk-pacoca-acomp" data-item-id="pacoca_acomp" />Pa√ßoca</label><label for="chk-granola-acomp"><input type="checkbox" value="Granola" id="chk-granola-acomp" data-item-id="granola_acomp" />Granola</label><label for="chk-farinha-lactea-acomp"><input type="checkbox" value="Farinha L√°ctea" id="chk-farinha-lactea-acomp" data-item-id="farinha_lactea_acomp" />Farinha L√°ctea</label><label for="chk-leite-po-acomp"><input type="checkbox" value="Leite em P√≥" id="chk-leite-po-acomp" data-item-id="leite_po_acomp" />Leite em P√≥</label><label for="chk-confetes-acomp"><input type="checkbox" value="Confetes" id="chk-confetes-acomp" data-item-id="confetes_acomp" />Confetes</label><label for="chk-tapioca-acomp"><input type="checkbox" value="Tapioca" id="chk-tapioca-acomp" data-item-id="tapioca_acomp" />Tapioca</label><label for="chk-uva-passa-acomp"><input type="checkbox" value="Uva Passa" id="chk-uva-passa-acomp" data-item-id="uva_passa_acomp" />Uva Passa</label><label for="chk-accomp-nenhum"><input type="checkbox" value="Nenhuma" id="chk-accomp-nenhum" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsCoverage" disabled><legend>5. Cobertura(s) <span id="cntCover" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCoverage"><label for="chk-chocolate-cob"><input type="checkbox" value="Chocolate" id="chk-chocolate-cob" data-item-id="chocolate_cob" />Chocolate</label><label for="chk-morango-cob"><input type="checkbox" value="Morango (Cobertura)" id="chk-morango-cob" data-item-id="morango_cob" />Morango (Cobertura)</label><label for="chk-leite-condensado-cob"><input type="checkbox" value="Leite Condensado" id="chk-leite-condensado-cob" data-item-id="leite_condensado_cob" />Leite Condensado</label><label for="chk-tutti-frutti-cob"><input type="checkbox" value="Tutti Frutti (Cobertura)" id="chk-tutti-frutti-cob" data-item-id="tutti_frutti_cob" />Tutti Frutti (Cobertura)</label><label for="chk-ice-blue-cob"><input type="checkbox" value="Ice Blue" id="chk-ice-blue-cob" data-item-id="ice_blue_cob" />Ice Blue</label><label for="chk-kiwi-cob"><input type="checkbox" value="Kiwi (Cobertura)" id="chk-kiwi-cob" data-item-id="kiwi_cob" />Kiwi (Cobertura)</label><label for="chk-cover-nenhuma"><input type="checkbox" value="Nenhuma" id="chk-cover-nenhuma" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsAskAdd" disabled><legend>6. Deseja adicionais? <span class="section-status">(Obrigat√≥rio para A√ßa√≠)</span></legend><div class="grid-2"><label><input type="radio" name="wantAdd" value="Sim" required />Sim</label><label><input type="radio" name="wantAdd" value="N√£o" />N√£o</label></div></fieldset>
                <fieldset id="fsAdd" disabled><legend>7. Adicionais <span id="cntAdd" class="counter">(0/14)</span></legend><div class="grid-2" id="boxAdd"><label for="chk-ovomaltine-add"><input type="checkbox" value="Ovomaltine - R$ 1.00" id="chk-ovomaltine-add" data-item-id="ovomaltine_add" />Ovomaltine R$ 1.00</label><label for="chk-escureto-add"><input type="checkbox" value="Escureto - R$ 1.00" id="chk-escureto-add" data-item-id="escureto_add" />Escureto R$ 1.00</label><label for="chk-chocoball-add"><input type="checkbox" value="Chocoball - R$ 1.00" id="chk-chocoball-add" data-item-id="chocoball_add" />Chocoball R$ 1.00</label><label for="chk-amendoim-add"><input type="checkbox" value="Amendoim (Adicional) - R$ 1.00" id="chk-amendoim-add" data-item-id="amendoim_add" />Amendoim (Adicional) - R$ 1.00</label><label for="chk-pacoca-add"><input type="checkbox" value="Pa√ßoca (Adicional) - R$ 1.00" id="chk-pacoca-add" data-item-id="pacoca_add" />Pa√ßoca (Adicional) - R$ 1.00</label><label for="chk-granola-add"><input type="checkbox" value="Granola (Adicional) - R$ 1.00" id="chk-granola-add" data-item-id="granola_add" />Granola (Adicional) - R$ 1.00</label><label for="chk-farinha-lactea-add"><input type="checkbox" value="Farinha L√°ctea (Adicional) - R$ 1.00" id="chk-farinha-lactea-add" data-item-id="farinha_lactea_add" />Farinha L√°ctea (Adicional) - R$ 1.00</label><label for="chk-leite-po-add"><input type="checkbox" value="Leite em p√≥ (Adicional) - R$ 1.00" id="chk-leite-po-add" data-item-id="leite_po_add" />Leite em p√≥ (Adicional) - R$ 1.00</label><label for="chk-confetes-add"><input type="checkbox" value="Confetes (Adicional) - R$ 1.00" id="chk-confetes-add" data-item-id="confetes_add" />Confetes (Adicional) - R$ 1.00</label><label for="chk-tapioca-add"><input type="checkbox" value="Tapioca (Adicional) - R$ 1.00" id="chk-tapioca-add" data-item-id="tapioca_add" />Tapioca (Adicional) - R$ 1.00</label><label for="chk-uva-passa-add"><input type="checkbox" value="Uva Passa (Adicional) - R$ 1.00" id="chk-uva-passa-add" data-item-id="uva_passa_add" />Uva Passa (Adicional) - R$ 1.00</label><label for="chk-mms-add"><input type="checkbox" value="M&MS - R$ 1.00" id="chk-mms-add" data-item-id="mms_add" />M&MS - R$ 1.00</label><label for="chk-marshmallow-add"><input type="checkbox" value="Marshmallow - R$ 1.00" id="chk-marshmallow-add" data-item-id="marshmallow_add" />Marshmallow - R$ 1.00</label><label for="chk-doce-leite-add"><input type="checkbox" value="Doce de leite - R$ 1.00" id="chk-doce-leite-add" data-item-id="doce_leite_add" />Doce de leite - R$ 1.00</label><label for="chk-add-nenhum"><input type="checkbox" value="Nenhum Adicional" id="chk-add-nenhum" />Nenhum Adicional</label></div></fieldset>

                <fieldset id="fsPayment" disabled>
                    <legend>8. Forma de Pagamento <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="payment" value="Pix" required />Pix</label>
                        <label><input type="radio" name="payment" value="Dinheiro" />Dinheiro</label>
                        <label><input type="radio" name="payment" value="Cart√£o" />Cart√£o</label>
                    </div>
                </fieldset>

                <fieldset id="fsDelivery" disabled>
                    <legend>9. Entrega ou Retirada <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="delivery" value="Retirada" required />Retirada</label>
                        <label><input type="radio" name="delivery" value="Outeiro - R$ 3.00" />Entrega - Outeiro (R$ 3.00)</label>
                        <label><input type="radio" name="delivery" value="Cedral - R$ 5.00" />Entrega - Cedral (R$ 5.00)</label>
                    </div>
                </fieldset>

                <div class="buttons">
                    <button type="button" id="btnCancel">‚ùå Cancelar Pedido Atual</button>
                    <button type="button" id="btnAdd" disabled>‚ûï Adicionar Item ao Pedido</button>
                    <button type="button" id="btnFinish" disabled>‚úÖ Finalizar e Enviar Pedido</button>
                </div>

                <div id="pixInfo" class="pix-info-container hidden">
                    <h3>Pagamento via PIX</h3>
                    <p><strong>Nome:</strong> Bruna Raquel Carvalho Campos</p>
                    <p><strong>Chave PIX (Celular):</strong> (98) 985016035</p>
                    <p><small>Por favor, envie o comprovante ap√≥s finalizar o pedido no WhatsApp.</small></p>
                </div>

            </form>
        </div>

        <div class="card" id="ordersSection" style="display:none;">
            <h2>Seus Itens no Pedido:</h2>
            <ul id="ordersList"></ul>
            <div id="orderPageTotal">
                Total Geral (com frete): R$ <span id="orderPageTotalValue">0,00</span>
            </div>
        </div>

        <div id="summary" style="display: none;"></div>
    </main>
    
    <div id="shopClosedContainer" class="card" style="display: none; text-align: center; padding: 2rem; margin: 1rem auto; max-width: 800px;">
        <h2>Estamos Fechados no Momento</h2>
        <p id="closedMessageText" style="margin-top: 1rem; font-size: 1.1em; line-height: 1.6;"></p>
    </div>


    <script>
        // --- SELETORES ---
        const fs = {
            produtoPrincipal: document.getElementById('fsProdutoPrincipal'),
            frutas: document.getElementById('fsFrutas'),
            cremes: document.getElementById('fsCremes'),
            accomp: document.getElementById('fsAccomp'),
            cover: document.getElementById('fsCoverage'),
            askAdd: document.getElementById('fsAskAdd'),
            add: document.getElementById('fsAdd'),
            payment: document.getElementById('fsPayment'),
            delivery: document.getElementById('fsDelivery')
        };
        const cnt = {
            frutas: document.getElementById('cntFrutas'),
            cremes: document.getElementById('cntCremes'),
            accomp: document.getElementById('cntAccomp'),
            cover: document.getElementById('cntCover'),
            add: document.getElementById('cntAdd')
        };
        const boxProdutosPrincipais = document.getElementById('boxProdutosPrincipais');
        const specialFlavorsContainer = document.getElementById('specialFlavorsContainer');
        
        const btnAdd = document.getElementById('btnAdd');
        const btnFinish = document.getElementById('btnFinish');
        const btnCancel = document.getElementById('btnCancel');
        const ordersSec = document.getElementById('ordersSection');
        const ordersList = document.getElementById('ordersList');
        const summaryEl = document.getElementById("summary");
        const form = document.getElementById('formPedido');
        const pixInfoDiv = document.getElementById('pixInfo');
        const orderPageTotalValueEl = document.getElementById('orderPageTotalValue');

        const formCard = document.querySelector('#formPedido').closest('.card');
        const shopClosedContainer = document.getElementById('shopClosedContainer');
        const closedMessageEl = document.querySelector('#shopClosedContainer #closedMessageText');

        let state = {};
        let orders = [];
        let allItemsData = {};

        // --- FUN√á√ïES UTILIT√ÅRIAS ---
        const enable = el => {
            if (el) {
                el.removeAttribute('disabled');
                el.classList.add('active'); // Added for special flavors visibility
                el.querySelectorAll('label').forEach(lbl => {
                     const input = lbl.querySelector('input');
                     if (!input || !input.disabled) {
                         lbl.style.pointerEvents = 'auto';
                     }
                });
            }
        };
        const disable = el => {
            if (el) {
                el.setAttribute('disabled', '');
                el.classList.remove('active'); // Added for special flavors visibility
                el.querySelectorAll('label').forEach(lbl => lbl.style.pointerEvents = 'none');
            }
        };
        const clearCheckboxes = fieldset => {
             if (fieldset) fieldset.querySelectorAll('input[type="checkbox"]').forEach(chk => chk.checked = false);
        };
        const clearRadios = name => {
            document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                r.checked = false;
                r.closest('label')?.classList.remove('selected-radio');
            });
        };
        const updateCounter = (element, count, max) => {
             if (element) element.textContent = `( ${count} / ${max !== undefined ? max : '?'} )`;
        };

        // --- L√ìGICA DE ESTADO E FORMUL√ÅRIO ---
        function disableAllAcaiAndAddonFieldsets() {
             [fs.frutas, fs.cremes, fs.accomp, fs.cover, fs.askAdd, fs.add].forEach(f => {
                disable(f);
                clearCheckboxes(f);
             });
             // Hide all special flavor sections
             document.querySelectorAll('.special-flavors-fs').forEach(f => disable(f));

             state.frutas = []; updateCounter(cnt.frutas, 0, '?');
             state.cremes = []; updateCounter(cnt.cremes, 0, '?');
             state.accomp = []; updateCounter(cnt.accomp, 0, '?');
             state.cover = []; updateCounter(cnt.cover, 0, '?');
             state.add = []; updateCounter(cnt.add, 0, 14);
             state.wantAdd = undefined; clearRadios('wantAdd');
             state.selectedFlavor = undefined;
        }

        function resetPartialForItemSelection() {
             state = {
                payment: state.payment,
                delivery: state.delivery
             };
            
            disableAllAcaiAndAddonFieldsets();

            enable(fs.produtoPrincipal);
            btnAdd.disabled = true;
            btnFinish.disabled = orders.length === 0;
        }

        async function resetForm() {
             state = {};
             orders = [];
             renderOrders();
             if(pixInfoDiv) pixInfoDiv.classList.add('hidden');
             form.reset();
             document.querySelectorAll('.selected-radio, .produto-card.selected').forEach(el => el.classList.remove('selected', 'selected-radio'));
             
             await fetchAndApplyItemAvailability();
             
             btnAdd.disabled = true; 
             btnFinish.disabled = true;
        }

        // --- L√ìGICA DE VALIDA√á√ÉO ---
        function validateCurrentOrderItem() {
            if (!state.produtoPrincipal || !state.produtoPrincipal.type) return false;

            if (state.produtoPrincipal.type === 'acai') {
                const checkSection = (fieldset, stateKey, noneValue) => {
                    if (fieldset.hasAttribute('disabled')) return true;
                    const items = state[stateKey];
                    if (!items || items.length === 0) return false;
                    if (items.includes(noneValue) && items.length > 1) return false;
                    return true;
                };

                const frutasOk = checkSection(fs.frutas, 'frutas', 'Nenhuma');
                const cremesOk = checkSection(fs.cremes, 'cremes', 'Nenhuma');
                const accompOk = checkSection(fs.accomp, 'accomp', 'Nenhuma');
                const coverOk = checkSection(fs.cover, 'cover', 'Nenhuma');

                let addOk = true;
                if (!fs.askAdd.hasAttribute('disabled')) {
                    if (state.wantAdd === undefined) return false;
                    if (state.wantAdd === 'Sim') addOk = checkSection(fs.add, 'add', 'Nenhum Adicional');
                }
                return frutasOk && cremesOk && accompOk && coverOk && addOk;
            } 
            
            if (state.produtoPrincipal.type === 'produto_especial') {
                const productData = allItemsData.produtos_especiais.find(p => p.id === state.produtoPrincipal.id);
                if (productData && productData.requires_flavor_selection) {
                    return !!state.selectedFlavor;
                }
                return true; // Special product without flavor selection is always valid
            }
            return false;
        }

        function checkIfCanFinish() {
            const itemValid = validateCurrentOrderItem();
            const paymentSelected = !!state.payment;
            const deliverySelected = !!state.delivery;
            
            btnAdd.disabled = !(itemValid && paymentSelected && deliverySelected);
            btnFinish.disabled = (orders.length === 0 && btnAdd.disabled) || (!paymentSelected || !deliverySelected);
        }

        // --- RENDERIZA√á√ÉO E SETUP DE LISTENERS ---
        async function fetchAndApplyItemAvailability() {
            try {
                // Faking API call for demonstration
                const fakeResponse = {
                    ok: true,
                    json: () => Promise.resolve({
                        "shopInfo": {
                            "isOpen": true,
                            "closedMessage": "Voltamos amanh√£ √†s 14h!\\nObrigado pela prefer√™ncia."
                        },
                        "produtos_especiais": [
                            {
                                "id": "copo_felicidade",
                                "name": "Copo da Felicidade (Especial)",
                                "description": "Escolha um sabor delicioso para seu copo especial.",
                                "price": 18.00,
                                "available": true,
                                "requires_flavor_selection": true,
                                "flavors": [
                                    { "name": "Ninho com Nutella", "available": true, "internal_description": "Creme de Ninho e Nutella" },
                                    { "name": "Sensa√ß√£o", "available": true, "internal_description": "Creme de morango e chocolate" },
                                    { "name": "Oreo", "available": false, "internal_description": "Creme com peda√ßos de Oreo" }
                                ]
                            },
                            {
                                "id": "fatia_bolo_doce_amor",
                                "name": "Fatia de Bolo 'Doce Amor'",
                                "description": "A melhor fatia de bolo da regi√£o, escolha o sabor.",
                                "price": 12.50,
                                "available": true,
                                "requires_flavor_selection": true,
                                "flavors": [
                                    { "name": "Red Velvet", "available": true, "internal_description": null },
                                    { "name": "Chocolate com Brigadeiro", "available": true, "internal_description": null },
                                    { "name": "Cenoura com Chocolate", "available": true, "internal_description": null }
                                ]
                            }
                        ],
                        // other categories...
                        "frutas": [ { "id": "morango", "available": true }, { "id": "banana", "available": true }, { "id": "kiwi", "available": false }, { "id": "maca", "available": true }, { "id": "uva", "available": true } ],
                        "cremes": [ { "id": "ninho", "available": true }, { "id": "maracuja", "available": true }, { "id": "morango_creme", "available": true }, { "id": "tutti_frutti_creme", "available": false }, { "id": "chocolate_avela", "available": true } ],
                        "acompanhamentos": [ { "id": "amendoim_acomp", "available": true }, { "id": "pacoca_acomp", "available": true }, { "id": "granola_acomp", "available": true }, { "id": "farinha_lactea_acomp", "available": true }, { "id": "leite_po_acomp", "available": true }, { "id": "confetes_acomp", "available": true }, { "id": "tapioca_acomp", "available": false }, { "id": "uva_passa_acomp", "available": true } ],
                        "coberturas": [ { "id": "chocolate_cob", "available": true }, { "id": "morango_cob", "available": true }, { "id": "leite_condensado_cob", "available": true }, { "id": "tutti_frutti_cob", "available": true }, { "id": "ice_blue_cob", "available": true }, { "id": "kiwi_cob", "available": false } ],
                        "adicionais": [ { "id": "ovomaltine_add", "available": true }, { "id": "escureto_add", "available": true }, { "id": "chocoball_add", "available": true }, { "id": "amendoim_add", "available": true }, { "id": "pacoca_add", "available": true }, { "id": "granola_add", "available": true }, { "id": "farinha_lactea_add", "available": true }, { "id": "leite_po_add", "available": true }, { "id": "confetes_add", "available": true }, { "id": "tapioca_add", "available": true }, { "id": "uva_passa_add", "available": true }, { "id": "mms_add", "available": false }, { "id": "marshmallow_add", "available": true }, { "id": "doce_leite_add", "available": true } ]
                    })
                };
                
                // const response = await fetch('/api/items');
                const response = fakeResponse; // Using the fake response
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allItemsData = await response.json();

                if (allItemsData.shopInfo && !allItemsData.shopInfo.isOpen) {
                    formCard.style.display = 'none';
                    ordersSec.style.display = 'none';
                    if (shopClosedContainer) {
                        closedMessageEl.innerText = allItemsData.shopInfo.closedMessage.replace(/\\n/g, '\n');
                        shopClosedContainer.style.display = 'block';
                    }
                    return;
                }
                formCard.style.display = 'block';
                if (shopClosedContainer) shopClosedContainer.style.display = 'none';

                renderProdutosPrincipais();
                createSpecialProductFieldsets();
                
                const updateCheckboxDisplay = (categoryKey, fieldsetElement) => {
                    if (!allItemsData[categoryKey] || !fieldsetElement) return;
                    const checkboxes = fieldsetElement.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        const itemId = checkbox.dataset.itemId;
                        if (!itemId) return;
                        const itemData = allItemsData[categoryKey].find(item => item.id === itemId);
                        if (itemData) {
                            checkbox.disabled = !itemData.available;
                            checkbox.closest('label').classList.toggle('disabled-item', !itemData.available);
                        }
                    });
                };
                ['frutas', 'cremes', 'acompanhamentos', 'coberturas', 'adicionais'].forEach(key => {
                    const fieldsetId = 'fs' + key.charAt(0).toUpperCase() + key.slice(1);
                    const fieldset = document.getElementById(fieldsetId) || fs[key]; // Fallback for `fs.add`
                    updateCheckboxDisplay(key, fieldset);
                });


                setupAllListeners();
                enable(fs.payment);
                enable(fs.delivery);
            } catch (error) {
                console.error("Erro fatal ao carregar card√°pio:", error);
                alert("Erro ao carregar o card√°pio. Por favor, recarregue a p√°gina.");
            }
        }
        
        function createSpecialProductFieldsets() {
            if (!specialFlavorsContainer || !allItemsData.produtos_especiais) return;
            specialFlavorsContainer.innerHTML = ''; // Limpa antes de criar

            allItemsData.produtos_especiais.forEach(prod => {
                if (prod.requires_flavor_selection) {
                    const fieldset = document.createElement('fieldset');
                    fieldset.id = `fs-${prod.id}`;
                    fieldset.className = 'special-flavors-fs';
                    fieldset.disabled = true;

                    const legend = document.createElement('legend');
                    legend.innerHTML = `2. Escolha o Sabor do(a) ${prod.name} <span class="section-status">(Obrigat√≥rio)</span>`;
                    
                    const gridDiv = document.createElement('div');
                    gridDiv.className = 'grid-2';
                    gridDiv.id = `box-${prod.id}`;

                    fieldset.appendChild(legend);
                    fieldset.appendChild(gridDiv);
                    specialFlavorsContainer.appendChild(fieldset);
                }
            });
        }


        function renderProdutosPrincipais() {
             if (!boxProdutosPrincipais) return;
             boxProdutosPrincipais.innerHTML = '';
             const acaiProducts = [
                { id: 'size-300', name: 'Copo Pequeno (300ml)', price: 10.00, img: '/images/copo-pequeno.jpg', description: 'At√© 1 fruta, at√© 1 creme,<br>at√© 3 acompanhamentos,<br>at√© 1 cobertura', available: true },
                { id: 'size-500', name: 'Copo Grande (500ml)', price: 15.00, img: '/images/copo-grande.jpg', description: 'At√© 2 frutas, at√© 2 cremes,<br>at√© 3 acompanhamentos,<br>at√© 1 cobertura', available: true },
                { id: 'size-1L', name: 'Pote da Felicidade (1 litro)', price: 40.00, img: '/images/pote-felicidade.jpg', description: 'At√© 3 frutas, at√© 3 cremes,<br>at√© 4 acompanhamentos,<br>at√© 2 coberturas', available: true }
             ];

             const renderCard = (prod, type) => {
                 const imgMap = { 'copo_felicidade': '/images/copo-felicidade.jpg', 'fatia_bolo_doce_amor': '/images/fatia-bolo.jpg' };
                 const img = imgMap[prod.id] || prod.img || '/images/logo.png';
                 return `
                     <label class="produto-card ${!prod.available ? 'disabled-item' : ''}" for="prod-${prod.id}" data-product-type="${type}" data-product-id="${prod.id}" data-price="${prod.price}">
                         <img src="${img}" alt="${prod.name}" />
                         <input type="radio" name="produtoPrincipal" value="${prod.name}" id="prod-${prod.id}" ${!prod.available ? 'disabled' : ''}/>
                         <div>
                             <strong>${prod.name}</strong> - R$ ${prod.price.toFixed(2).replace('.', ',')}
                             <span>${prod.description}</span>
                         </div>
                     </label>
                 `;
             };
             acaiProducts.forEach(prod => boxProdutosPrincipais.innerHTML += renderCard(prod, 'acai'));
             (allItemsData.produtos_especiais || []).forEach(prod => boxProdutosPrincipais.innerHTML += renderCard(prod, 'produto_especial'));
        }

        function renderSpecialProductFlavors(productData) {
            const fieldset = document.getElementById(`fs-${productData.id}`);
            const targetBox = document.getElementById(`box-${productData.id}`);
            if (!fieldset || !targetBox) return;

            targetBox.innerHTML = '';
            productData.flavors.forEach(flavor => {
                targetBox.innerHTML += `
                    <label class="${!flavor.available ? 'disabled-item' : ''}">
                        <input type="radio" name="flavor" value="${flavor.name}" ${!flavor.available ? 'disabled' : ''} />
                        <span>${flavor.name}</span>
                        ${flavor.internal_description ? `<small>(${flavor.internal_description})</small>` : ''}
                    </label>`;
            });
            enable(fieldset);
        }

        function setupAllListeners() {
            // Listener para Produtos Principais
            document.querySelectorAll('input[name="produtoPrincipal"]').forEach(radio => {
                 radio.addEventListener('change', (e) => {
                    document.querySelectorAll('.produto-card.selected').forEach(l => l.classList.remove('selected'));
                    e.target.closest('label').classList.add('selected');
                    
                    resetPartialForItemSelection();

                    const selectedCard = e.target.closest('.produto-card');
                    const productType = selectedCard.dataset.productType;
                    const productId = selectedCard.dataset.productId;
                    const productPrice = parseFloat(selectedCard.dataset.price);

                    state.produtoPrincipal = { type: productType, name: e.target.value, price: productPrice, id: productId };
                    
                    if (productType === 'acai') {
                        let limits = {};
                        if (productId === 'size-300') limits = { f: 1, c: 1, a: 3, co: 1 };
                        else if (productId === 'size-500') limits = { f: 2, c: 2, a: 3, co: 1 };
                        else if (productId === 'size-1L') limits = { f: 3, c: 3, a: 4, co: 2 };
                        state.fMax = limits.f; state.cMax = limits.c; state.aMax = limits.a; state.coMax = limits.co;
                        
                        [fs.frutas, fs.cremes, fs.accomp, fs.cover, fs.askAdd].forEach(enable);
                        setupChecks(fs.frutas, limits.f, 'frutas');
                        setupChecks(fs.cremes, limits.c, 'cremes');
                        setupChecks(fs.accomp, limits.a, 'accomp');
                        setupChecks(fs.cover, limits.co, 'cover');
                    } else if (productType === 'produto_especial') {
                        const productData = allItemsData.produtos_especiais.find(p => p.id === productId);
                        if (productData && productData.requires_flavor_selection) {
                            renderSpecialProductFlavors(productData);
                        }
                    }
                    checkIfCanFinish();
                 });
            });

            // Listeners para checkboxes de A√ßa√≠
            const setupChecks = (fieldset, max, key) => {
                const originalBox = fieldset.querySelector('.grid-2');
                const newBox = originalBox.cloneNode(true);
                originalBox.parentNode.replaceChild(newBox, originalBox);
                
                const checkboxes = newBox.querySelectorAll('input[type="checkbox"]');
                const noneCheckbox = Array.from(checkboxes).find(c => c.value.toLowerCase().includes('nenhum'));
                
                state[key] = [];
                if (noneCheckbox && !noneCheckbox.disabled) {
                    noneCheckbox.checked = true;
                    state[key].push(noneCheckbox.value);
                } else { // Handle case where "Nenhum" is disabled
                     state[key] = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
                }
                updateCounter(cnt[key], state[key].filter(v => !v.toLowerCase().includes('nenhum')).length, max);
                
                checkboxes.forEach(chk => {
                    chk.addEventListener('change', () => {
                        if (chk === noneCheckbox && chk.checked) {
                            checkboxes.forEach(other => { if(other !== chk) other.checked = false; });
                        } else if(chk.checked && noneCheckbox) {
                            noneCheckbox.checked = false;
                        }

                        state[key] = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
                        let count = state[key].filter(v => !v.toLowerCase().includes('nenhum')).length;

                        if (count > max) {
                            chk.checked = false;
                            alert(`M√°ximo de ${max} op√ß√µes para esta categoria.`);
                            state[key] = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
                            count = state[key].filter(v => !v.toLowerCase().includes('nenhum')).length;
                        }
                        
                        if (count === 0 && noneCheckbox && !noneCheckbox.disabled) {
                            noneCheckbox.checked = true;
                            state[key] = [noneCheckbox.value];
                        }

                        updateCounter(cnt[key], count, max);
                        checkIfCanFinish();
                    });
                });
            };

            // Listener para todos os radios (sabores, pagamento, etc.)
            form.addEventListener('change', e => {
                if (e.target.type !== 'radio') return;

                const name = e.target.name;
                document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.closest('label')?.classList.remove('selected-radio'));
                e.target.closest('label').classList.add('selected-radio');
                
                if(name === 'flavor') {
                    state.selectedFlavor = e.target.value;
                } else if (name === 'wantAdd') {
                    state.wantAdd = e.target.value;
                    if(state.wantAdd === 'Sim') {
                        enable(fs.add);
                        setupChecks(fs.add, 14, 'add');
                    } else {
                        disable(fs.add);
                    }
                } else if (name === 'payment' || name === 'delivery') {
                    state[name] = e.target.value;
                    if (name === 'payment') pixInfoDiv.classList.toggle('hidden', e.target.value !== 'Pix');
                    renderOrders(); // Recalculate total on delivery change
                }
                checkIfCanFinish();
            });

            // Listeners para bot√µes
            btnCancel.addEventListener('click', () => {
                if (confirm("Tem certeza que deseja limpar o formul√°rio e o pedido atual?")) resetForm();
            });

            btnAdd.addEventListener('click', () => {
                orders.push(JSON.parse(JSON.stringify(state)));
                renderOrders();
                resetPartialForItemSelection();
                document.querySelectorAll('input[name="produtoPrincipal"]').forEach(r => r.checked = false);
                document.querySelectorAll('.produto-card.selected').forEach(l => l.classList.remove('selected'));
                checkIfCanFinish();
            });

            btnFinish.addEventListener('click', async () => {
                 if (btnAdd.disabled === false && validateCurrentOrderItem()) { 
                    orders.push(JSON.parse(JSON.stringify(state)));
                    renderOrders();
                }
                if (orders.length === 0) {
                    alert("Seu pedido est√° vazio.");
                    return;
                }
                
                const summary = generateSummaryText();
                const phoneNumber = '5598985016035';
                const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(summary.admin)}`;

                alert("Simula√ß√£o: Pedido seria enviado e voc√™ redirecionado para o WhatsApp.\n\n" + summary.admin);
                console.log("Payload para o servidor:", {
                    pedidoCompleto: summary.items,
                    valorTotal: summary.total,
                    metodoPagamento: state.payment,
                    tipoEntrega: state.delivery,
                    resumoParaAdmin: summary.admin
                });
                // window.location.href = whatsappURL; // Comentado para n√£o redirecionar
                await resetForm();
            });
            
            // Listener for "Repeat Item" button using event delegation
            ordersList.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-repeat')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    if (index >= 0 && index < orders.length) {
                        const itemToRepeat = JSON.parse(JSON.stringify(orders[index]));
                        orders.splice(index + 1, 0, itemToRepeat);
                        renderOrders();
                    }
                }
            });
        }
        
        // --- L√ìGICA DE GERA√á√ÉO DE RESUMO E RENDERIZA√á√ÉO DE PEDIDOS ---
        function renderOrders() {
            ordersSec.style.display = orders.length > 0 ? 'block' : 'none';
            ordersList.innerHTML = '';
            let totalGeral = 0;
            const deliveryFeeMatch = state.delivery ? String(state.delivery).match(/R\$ (\d+[,.]\d{2})/) : null;
            const deliveryFee = deliveryFeeMatch ? parseFloat(deliveryFeeMatch[1].replace(',', '.')) : 0;

            orders.forEach((order, i) => {
                let subTotal = order.produtoPrincipal.price;
                let details = '';
                if(order.produtoPrincipal.type === 'acai') {
                    const formatList = (list) => list && !list.some(v => v.toLowerCase().includes('nenhum')) ? list.join(', ') : 'Nenhum';
                    details += `Frutas: ${formatList(order.frutas)}<br>`;
                    details += `Cremes: ${formatList(order.cremes)}<br>`;
                    details += `Acompanhamentos: ${formatList(order.accomp)}<br>`;
                    details += `Coberturas: ${formatList(order.cover)}<br>`;
                    if (order.wantAdd === 'Sim' && order.add && !order.add.some(v => v.toLowerCase().includes('nenhum'))) {
                        order.add.forEach(addon => subTotal += 1.00);
                        details += `Adicionais: ${formatList(order.add)}`;
                    } else {
                        details += `Adicionais: Nenhum`;
                    }
                } else if(order.produtoPrincipal.type === 'produto_especial') {
                    details += `Sabor: ${order.selectedFlavor || 'N/A'}`;
                }
                
                const li = document.createElement('li');
                li.innerHTML = `
                    <strong>Item ${i+1}: ${order.produtoPrincipal.name}</strong><br>
                    ${details}<br>
                    <strong>Subtotal: R$ ${subTotal.toFixed(2).replace('.', ',')}</strong>
                    <div class="order-item-actions">
                        <button class="btn-repeat" data-index="${i}">üîÅ Repetir</button>
                    </div>
                `;
                ordersList.appendChild(li);
                totalGeral += subTotal;
            });
            totalGeral += deliveryFee;
            orderPageTotalValueEl.textContent = totalGeral.toFixed(2).replace('.', ',');
        }

        function generateSummaryText() {
            let totalGeral = 0;
            const itemsPayload = [];
            let adminText = "Blue A√ßa√≠ - Novo Pedido!\n\n";

            orders.forEach((order, i) => {
                let subTotal = order.produtoPrincipal.price;
                const itemPayload = { produto: order.produtoPrincipal.name, tipo: order.produtoPrincipal.type };
                
                adminText += `*Item ${i+1}:* ${order.produtoPrincipal.name}\n`;

                if(order.produtoPrincipal.type === 'acai') {
                    const formatList = (list) => list && !list.some(v => v.toLowerCase().includes('nenhum')) ? list.join(', ') : 'Nenhum';
                    itemPayload.frutas = formatList(order.frutas);
                    itemPayload.cremes = formatList(order.cremes);
                    itemPayload.acompanhamentos = formatList(order.accomp);
                    itemPayload.coberturas = formatList(order.cover);
                    adminText += `*Frutas:* ${itemPayload.frutas}\n*Cremes:* ${itemPayload.cremes}\n*Acompanhamentos:* ${itemPayload.acompanhamentos}\n*Coberturas:* ${itemPayload.coberturas}\n`;


                    // L√≥gica para Adicionais
                    if (order.wantAdd === 'Sim' && order.add && !order.add.some(v => v.toLowerCase().includes('nenhum'))) {
                        order.add.forEach(addon => subTotal += 1.00);
                        const formattedAdicionais = order.add.map(a => a.split(' - R$')[0].toUpperCase()).join(', ');
                        itemPayload.adicionais = formattedAdicionais;
                        adminText += `*Adicionais:* *${itemPayload.adicionais}*\n`;
                    } else {
                        itemPayload.adicionais = 'Nenhum';
                        adminText += `*Adicionais:* ${itemPayload.adicionais}\n`;
                    }
                } else if (order.produtoPrincipal.type === 'produto_especial') {
                    itemPayload.sabor = order.selectedFlavor || 'N/A';
                    adminText += `*Sabor:* ${itemPayload.sabor}\n`;
                }

                adminText += '\n'; // Linha em branco entre os itens

                itemPayload.totalPedido = subTotal.toFixed(2);
                itemsPayload.push(itemPayload);
                totalGeral += subTotal;
            });
            
            const deliveryFeeMatch = state.delivery ? String(state.delivery).match(/R\$ (\d+[,.]\d{2})/) : null;
            const deliveryFee = deliveryFeeMatch ? parseFloat(deliveryFeeMatch[1].replace(',', '.')) : 0;
            totalGeral += deliveryFee;

            adminText += `------------------------------\n`;
            adminText += `*Pagamento:* ${state.payment}\n`;
            adminText += `*Entrega/Retirada:* ${String(state.delivery).split(' - R$')[0]}\n`;
            if (deliveryFee > 0) adminText += `*Taxa de Entrega:* R$ ${deliveryFee.toFixed(2).replace('.', ',')}\n`;
            adminText += `*TOTAL GERAL DO PEDIDO: R$ ${totalGeral.toFixed(2).replace('.', ',')}*\n`;

            return { admin: adminText, items: itemsPayload, total: totalGeral };
        }

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            resetForm();
        });
    </script>
</body>
</html>
