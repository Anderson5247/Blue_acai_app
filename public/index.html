<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blue A√ßa√≠ ‚Äì Card√°pio Interativo</title>
    <style>
        :root {
            --purple: #5A0F8D;
            --light-purple: #F3E5FF;
            --dark-text: #333;
            --card-bg: #fff;
            --danger-red: #dc3545;
            --danger-red-hover: #c82333;
            --success-green: #28a745;
            --success-green-hover: #218838;
        }
        #shopClosedContainer #closedMessageText {
            white-space: pre-wrap;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--light-purple);
            color: var(--dark-text);
        }

        header {
            background: var(--purple);
            color: #fff;
            text-align: center;
            padding: 1rem;
        }

        header img {
            max-width: 120px;
            margin-bottom: .5rem;
        }

        main {
            max-width: 800px;
            margin: 1rem auto;
            padding: 0 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        fieldset {
            border: none;
            margin: 1rem 0;
            padding: 0;
            transition: opacity .3s;
        }
        
        fieldset.hidden {
            display: none;
        }

        fieldset[disabled] {
            opacity: .6;
        }

        fieldset[disabled] label, fieldset[disabled] input, fieldset[disabled] textarea {
            pointer-events: none;
        }


        legend {
            font-weight: bold;
            margin-bottom: .5rem;
            color: var(--purple);
            font-size: 1.1em;
            width: 100%;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        legend .section-status {
            font-weight: normal;
            font-size: 0.85em;
            color: #666;
            margin-left: 5px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: .75rem;
        }

        label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: .95rem;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        label:hover:not(.disabled-item) {
            background-color: #f0f0f0;
        }

        label.disabled-item {
            text-decoration: none !important;
            color: #aaa !important;
            cursor: not-allowed;
            pointer-events: none;
            opacity: 0.7;
        }
        
        label.disabled-item img {
            filter: grayscale(100%);
        }


        label input[type="checkbox"],
        label input[type="radio"] {
            margin-right: .5rem;
            cursor: pointer;
        }

        label input[type="checkbox"]:disabled,
        label input[type="radio"]:disabled {
            cursor: not-allowed;
        }
        
        #clientName, #addressInput {
            width: 100%;
            padding: 0.6rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
            font-family: 'Segoe UI', sans-serif;
        }
        #clientName:focus, #addressInput:focus {
            outline: none;
            border-color: var(--purple);
            box-shadow: 0 0 0 2px var(--light-purple);
        }

        .counter {
            margin-left: .5rem;
            color: var(--purple);
            font-weight: normal;
            font-size: .9rem;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: .75rem;
            margin-top: 1.5rem;
        }

        .buttons button {
            padding: .75rem;
            border: none;
            border-radius: 4px;
            background: var(--purple);
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .buttons button#btnCancel {
            background-color: var(--danger-red);
        }
        .buttons button#btnCancel:hover:not(:disabled) {
            background-color: var(--danger-red-hover);
        }

        .buttons button:hover:not(:disabled) {
            background-color: #4a0c74;
        }

        .buttons button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #summary {
            display: none;
            white-space: pre-wrap;
        }

        #ordersSection {
            border-top: 2px solid var(--purple);
            margin-top: 1.5rem;
            padding-top: 1rem;
        }

        #ordersList li {
            margin-bottom: .75rem;
            list-style: none;
            padding-left: 1.5rem;
            position: relative;
            border-bottom: 1px dashed #eee;
            padding-bottom: 0.75rem;
        }
        
        .repeat-item-btn {
            background-color: var(--success-green);
            color: white;
            border: none;
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        .repeat-item-btn:hover {
            background-color: var(--success-green-hover);
        }
        .order-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }


        #ordersList li::before {
            content: 'üç¶';
            position: absolute;
            left: 0;
            top: 0;
            font-size: 0.9em;
        }

        .produtos-opcoes { display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin-top: 1rem; }
        .produto-card { background: var(--card-bg); border: 2px solid #ccc; border-radius: 10px; padding: 1rem; width: 210px; text-align: center; transition: 0.3s; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; position: relative; }
        .produto-card input[type="radio"] {
            position: absolute;
            top: 10px;
            right: 10px;
            transform: scale(1.3);
            cursor: pointer;
            accent-color: var(--purple);
            z-index: 2;
        }
        .produto-card:hover { border-color: var(--purple); transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12); }
        label.produto-card.selected { border-color: var(--purple); box-shadow: 0 5px 10px rgba(90, 15, 141, 0.2); background-color: #faf5ff; }
        .produto-card img { width: 100%; max-height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 0.75rem; }
        .produto-card strong { font-size: 1rem; color: #333; display: block; margin-top: 0.5rem; }
        .produto-card span { font-size: 0.85rem; color: #555; margin-top: 0.25rem; display: block; line-height: 1.3; }
        
        .pix-info-container {
            background-color: #fdf1ff;
            border: 1px solid var(--purple);
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        .pix-info-container.hidden {
            display: none;
        }
        .pix-info-container h3 { color: var(--purple); margin-bottom: 0.75rem; }
        .pix-info-container p { margin-bottom: 0.5rem; line-height: 1.4; }
        .pix-info-container small { color: #555; font-style: italic; }

        #orderPageTotal {
            text-align: right; margin-top: 1rem; font-weight: bold;
            font-size: 1.1em; padding: 0.75rem; background-color: #f0f0f0;
            border-top: 1px solid #ddd; border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .produto-card .banner-mais-vendido {
            position: absolute;
            top: 10px;
            left: -8px;
            background-color: #dc3545;
            color: white;
            padding: 5px 15px;
            font-size: 0.8rem;
            font-weight: bold;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transform: rotate(-5deg);
            z-index: 3;
        }

        /* --- ESTILOS PARA OS CARDS DE OP√á√ïES --- */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 1rem;
        }
        .option-card {
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        .option-card:hover {
            border-color: var(--purple);
            transform: translateY(-2px);
        }
        .option-card.selected-radio {
            border-color: var(--purple);
            background-color: #faf5ff;
            box-shadow: 0 3px 8px rgba(90, 15, 141, 0.15);
        }
        .option-card img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        .option-card span {
            font-weight: 500;
            font-size: 0.9rem;
        }
        .option-card input[type="radio"] {
            position: absolute;
            top: 8px;
            right: 8px;
            transform: scale(1.3);
            accent-color: var(--purple);
        }
    </style>
</head>
<body>
    <header>
        <img src="/images/logo.png" alt="Logomarca Blue A√ßa√≠" />
        <h1>Blue A√ßa√≠</h1>
        <p>Monte seu a√ßa√≠ como quiser!</p>
    </header>
    <main>
        <div class="card">
            <form id="formPedido">
                <fieldset id="fsProdutoPrincipal">
                    <legend>1. Escolha o Produto <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="produtos-opcoes" id="boxProdutosPrincipais">
                        </div>
                </fieldset>

                <div id="productOptionsContainer" style="display: none;">
                    <fieldset id="fsSorveteSabor" class="hidden">
                        <legend>2. Escolha o Sabor <span class="section-status">(Obrigat√≥rio, 1 op√ß√£o)</span></legend>
                        <div class="options-grid" id="boxSorveteSabor">
                           </div>
                    </fieldset>
                    <fieldset id="fsFrutas" class="hidden">
                        <legend>2. Frutas <span id="cntFrutas" class="counter">(0/?)</span></legend>
                        <div class="grid-2" id="boxFrutas"></div>
                    </fieldset>
                    <fieldset id="fsCremes" class="hidden">
                        <legend>3. Cremes <span id="cntCremes" class="counter">(0/?)</span></legend>
                        <div class="grid-2" id="boxCremes"></div>
                    </fieldset>
                    <fieldset id="fsAccomp" class="hidden">
                        <legend>4. Acompanhamentos <span id="cntAccomp" class="counter">(0/?)</span></legend>
                        <div class="grid-2" id="boxAccomp"></div>
                    </fieldset>
                    <fieldset id="fsCoverage" class="hidden">
                        <legend>5. Cobertura(s) <span id="cntCover" class="counter">(0/?)</span></legend>
                        <div class="grid-2" id="boxCoverage"></div>
                    </fieldset>
                    <fieldset id="fsAskAdd" class="hidden">
                        <legend>6. Deseja Adicionais?</legend>
                        <div class="grid-2">
                            <label><input type="radio" name="wantAdd" value="Sim" />Sim</label>
                            <label><input type="radio" name="wantAdd" value="N√£o" />N√£o</label>
                        </div>
                    </fieldset>
                    <fieldset id="fsAdd" class="hidden">
                        <legend>7. Adicionais <span id="cntAdd" class="counter"></span></legend>
                        <div class="grid-2" id="boxAdd"></div>
                    </fieldset>
                </div>

                <fieldset id="fsClientName" disabled>
                    <legend>8. Seu Nome <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div>
                         <input type="text" id="clientName" placeholder="Digite seu nome para identifica√ß√£o" required />
                    </div>
                </fieldset>

               <fieldset id="fsDelivery">
                    <legend>9. Entrega ou Retirada <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="delivery" value="Retirada" required />Retirada</label>
                        <label><input type="radio" name="delivery" value="Consumo no local" required />Consumo no local</label>
                        <label><input type="radio" name="delivery" value="Cedral - R$ 3.00" />Entrega - Cedral (R$ 3.00)</label>
                        <label><input type="radio" name="delivery" value="Outeiro - R$ 5.00" />Entrega - Outeiro (R$ 5.00)</label>
                    </div>
                </fieldset>
            <div id="storeAddressInfo" style="display: none; text-align: center; background-color: #f3e5ff; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <h3 style="color: var(--purple); margin-bottom: 0.5rem;">Nosso Endere√ßo:</h3>
                    <p>
                        Rua do Porto, Outeiro-Cedral
                    </p>
                </div>
                
                <fieldset id="fsAddress" style="display: none;">
                    <legend>10. Endere√ßo para Entrega <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div>
                        <textarea id="addressInput" rows="3" placeholder="Ex: Rua, N√∫mero, Bairro, Ponto de Refer√™ncia..."></textarea>
                    </div>
                </fieldset>

                <fieldset id="fsPayment" disabled>
                    <legend>11. Forma de Pagamento <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="payment" value="Pix" required />Pix</label>
                        <label><input type="radio" name="payment" value="Dinheiro" />Dinheiro</label>
                        <label><input type="radio" name="payment" value="Cart√£o" />Cart√£o</label>
                    </div>
                </fieldset>

                <div class="buttons">
                    <button type="button" id="btnCancel">‚ùå Cancelar Pedido Atual</button>
                    <button type="button" id="btnAdd" disabled>‚ûï Adicionar Item ao Pedido</button>
                    <button type="button" id="btnFinish" disabled>‚úÖ Finalizar e Enviar Pedido</button>
                </div>

                <div id="pixInfo" class="pix-info-container hidden">
                    <h3>Pagamento via PIX</h3>
                    <p><strong>Nome:</strong> Bruna Raquel Carvalho Campos</p>
                    <p><strong>Chave PIX (Celular):</strong> (98) 985016035</p>
                    <p><small>Por favor, envie o comprovante ap√≥s finalizar o pedido no WhatsApp.</small></p>
                </div>

            </form>
        </div>

        <div class="card" id="ordersSection" style="display:none;">
            <h2>Seus Itens no Pedido:</h2>
            <ul id="ordersList"></ul>
            <div id="orderPageTotal">
                Total Geral (com frete): R$ <span id="orderPageTotalValue">0,00</span>
            </div>
        </div>

        <div id="summary" style="display: none;"></div>
    </main>
    
    <div id="shopClosedContainer" class="card" style="display: none; text-align: center; padding: 2rem; margin: 1rem auto; max-width: 800px;">
        <h2>Estamos Fechados no Momento</h2>
        <p id="closedMessageText" style="margin-top: 1rem; font-size: 1.1em; line-height: 1.6;"></p>
    </div>
<script>
    // --- SELETORES ---
    const fs = {
        produtoPrincipal: document.getElementById('fsProdutoPrincipal'),
        frutas: document.getElementById('fsFrutas'),
        cremes: document.getElementById('fsCremes'),
        accomp: document.getElementById('fsAccomp'),
        cover: document.getElementById('fsCoverage'),
        sorveteSabor: document.getElementById('fsSorveteSabor'),
        askAdd: document.getElementById('fsAskAdd'),
        add: document.getElementById('fsAdd'),
        clientName: document.getElementById('fsClientName'),
        address: document.getElementById('fsAddress'),
        payment: document.getElementById('fsPayment'),
        delivery: document.getElementById('fsDelivery')
    };
    const cnt = {
        frutas: document.getElementById('cntFrutas'), cremes: document.getElementById('cntCremes'),
        accomp: document.getElementById('cntAccomp'), cover: document.getElementById('cntCover'),
        add: document.getElementById('cntAdd')
    };
    const boxProdutosPrincipais = document.getElementById('boxProdutosPrincipais');
    const productOptionsContainer = document.getElementById('productOptionsContainer');
    
    const btnAdd = document.getElementById('btnAdd');
    const btnFinish = document.getElementById('btnFinish');
    const btnCancel = document.getElementById('btnCancel');
    const ordersSec = document.getElementById('ordersSection');
    const ordersList = document.getElementById('ordersList');
    const summaryEl = document.getElementById("summary");
    const form = document.getElementById('formPedido');
    const pixInfoDiv = document.getElementById('pixInfo');
    const orderPageTotalValueEl = document.getElementById('orderPageTotalValue');
    const clientNameInput = document.getElementById('clientName');
    const addressInput = document.getElementById('addressInput');

    const formCard = document.querySelector('#formPedido').closest('.card');
    const shopClosedContainer = document.getElementById('shopClosedContainer');
    const closedMessageEl = document.querySelector('#shopClosedContainer #closedMessageText');

    let state = {};
    let orders = [];
    let allItemsData = {};

    // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
    function renderDynamicCheckboxes(containerId, items, noneOptionText) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        items.forEach(item => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = item.name;
            checkbox.id = `chk-${item.id}`;
            checkbox.disabled = !item.available;
            label.classList.toggle('disabled-item', !item.available);
            label.title = item.available ? '' : 'Item indispon√≠vel';
            label.htmlFor = checkbox.id;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${item.name}`));
            container.appendChild(label);
        });
        if (noneOptionText) {
            const noneLabel = document.createElement('label');
            const noneCheckbox = document.createElement('input');
            noneCheckbox.type = 'checkbox';
            noneCheckbox.value = noneOptionText;
            noneCheckbox.id = `chk-${containerId}-nenhum`;
            noneLabel.htmlFor = noneCheckbox.id;
            noneLabel.appendChild(noneCheckbox);
            noneLabel.appendChild(document.createTextNode(` ${noneOptionText}`));
            container.appendChild(noneLabel);
        }
    }

    function renderFlavorCards(containerId, items, name) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        items.forEach(item => {
            const label = document.createElement('label');
            label.className = 'option-card';
            label.classList.toggle('disabled-item', !item.available);
            label.title = item.available ? item.name : 'Sabor indispon√≠vel';
            label.htmlFor = `radio-${item.id}`;

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = name;
            radio.value = item.name;
            radio.id = `radio-${item.id}`;
            radio.disabled = !item.available;
            
            label.innerHTML = `
                <img src="${item.img || '/images/default-product.png'}" alt="${item.name}">
                <span>${item.name}</span>
            `;
            label.appendChild(radio);
            container.appendChild(label);
        });
    }
    
    // --- L√ìGICA PRINCIPAL ---
    const enable = el => { if (el) { el.removeAttribute('disabled'); el.classList.remove('hidden'); } };
    const disable = el => { if (el) { el.setAttribute('disabled', 'true'); el.classList.add('hidden'); } };
    function clearCheckboxes(fieldset) { if (fieldset) fieldset.querySelectorAll('input[type="checkbox"]:checked:not([disabled])').forEach(chk => chk.checked = false); }
    function clearRadios(name) { document.querySelectorAll(`input[name="${name}"]`).forEach(r => { r.checked = false; r.closest('label')?.classList.remove('selected-radio'); }); }

    function resetPartialForItemSelection() {
        state = { ...state,
            produtoPrincipal: undefined, size: undefined, fMax: undefined, cMax: undefined,
            aMax: undefined, coMax: undefined, addMax: undefined, frutas: [], cremes: [],
            accomp: [], cover: [], add: [], wantAdd: undefined, sorveteSabor: undefined
        };

        productOptionsContainer.style.display = 'none';
        Object.values(fs).forEach(f => {
            if(f.id !== 'fsProdutoPrincipal' && f.id !== 'fsClientName' && f.id !== 'fsDelivery' && f.id !== 'fsAddress' && f.id !== 'fsPayment') {
                 disable(f);
                 if (f.querySelectorAll('input[type="checkbox"]').length > 0) clearCheckboxes(f);
                 if (f.querySelectorAll('input[type="radio"]').length > 0) clearRadios(f.querySelector('input[type="radio"]').name);
            }
        });
        updateCounter(cnt.frutas, 0, '?'); updateCounter(cnt.cremes, 0, '?');
        updateCounter(cnt.accomp, 0, '?'); updateCounter(cnt.cover, 0, '?');
        updateCounter(cnt.add, 0);
          
        btnAdd.disabled = true;
        btnFinish.disabled = orders.length === 0;
    }

    function validateCurrentOrderItem() {
        if (!state.produtoPrincipal || !state.produtoPrincipal.type) return false;
        const { type } = state.produtoPrincipal;

        const checkAddonsValidity = () => {
            if (!fs.askAdd.hasAttribute('disabled')) {
                if (state.wantAdd === undefined) return false;
                if (state.wantAdd === 'Sim') {
                    const items = state.add || [];
                    if (items.length === 0) return false;
                    return !(items.includes('Nenhum Adicional') && items.length > 1);
                }
            }
            return true;
        };

        if (type === 'acai') {
            const checkSection = (key) => (state[key] || []).length > 0;
            return checkSection('frutas') && checkSection('cremes') && checkSection('accomp') && checkSection('cover') && checkAddonsValidity();
        } else if (type === 'sorvete') {
            const isPote = state.produtoPrincipal.id === 'sorvete-pote';
            const addonsOk = isPote ? checkAddonsValidity() : true;
            return !!state.sorveteSabor && (state.cover || []).length > 0 && addonsOk;
        } else if (type === 'bebida') {
             return checkAddonsValidity();
        }
        return true; 
    }

    async function fetchAndApplyItemAvailability() {
        try {
            const response = await fetch('/api/items');
            if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
            allItemsData = await response.json();

            if (allItemsData.shopInfo && !allItemsData.shopInfo.isOpen) {
                formCard.style.display = 'none';
                shopClosedContainer.style.display = 'block';
                if(closedMessageEl) closedMessageEl.textContent = allItemsData.shopInfo.closedMessage;
                return;
            }
            formCard.style.display = 'block';
            shopClosedContainer.style.display = 'none';
            
            renderDynamicCheckboxes('boxFrutas', allItemsData.frutas, 'Nenhuma das op√ß√µes');
            renderDynamicCheckboxes('boxCremes', allItemsData.cremes, 'Nenhuma das op√ß√µes');
            renderDynamicCheckboxes('boxAccomp', allItemsData.acompanhamentos, 'Nenhuma das op√ß√µes');
            renderDynamicCheckboxes('boxCoverage', allItemsData.coberturas, 'Nenhuma das op√ß√µes');
            renderDynamicCheckboxes('boxAdd', allItemsData.adicionais, 'Nenhum Adicional');
            renderFlavorCards('boxSorveteSabor', allItemsData.sorvete_sabores, 'sorveteSabor');
            
            renderProdutosPrincipais();
            setupProdutoPrincipalListeners();
            setupRadioListener('payment');
            clientNameInput.addEventListener('input', checkIfCanFinish);
            addressInput.addEventListener('input', checkIfCanFinish);
            enable(fs.clientName); enable(fs.payment);

            const deliveryRadios = document.querySelectorAll('input[name="delivery"]');
            const shopInfo = allItemsData.shopInfo || {};
            const masterDeliverySwitch = shopInfo.isDeliveryAvailable === true;
            const locations = shopInfo.deliveryLocations || { cedral: false, outeiro: false };
            
            deliveryRadios.forEach(radio => {
                const label = radio.closest('label');
                if (!label) return;
                let isEnabled = radio.value === 'Retirada' || radio.value === 'Consumo no local';
                if (radio.value.toLowerCase().includes('cedral')) {
                    isEnabled = masterDeliverySwitch && locations.cedral;
                } else if (radio.value.toLowerCase().includes('outeiro')) {
                    isEnabled = masterDeliverySwitch && locations.outeiro;
                }
                
                radio.disabled = !isEnabled;
                label.classList.toggle('disabled-item', !isEnabled);
            });
            setupRadioListener('delivery');
        } catch (error) {
            console.error("Erro ao carregar o card√°pio:", error);
            alert("Erro ao carregar o card√°pio. Por favor, recarregue a p√°gina.");
        }
    }
    
    function renderProdutosPrincipais() {
        if (!boxProdutosPrincipais) return;
        boxProdutosPrincipais.innerHTML = '';
        const acaiProducts = [
            { id: 'size-300', name: 'Copo Pequeno (300ml)', price: 10.00, img: '/images/copo-pequeno.jpg', desc: 'At√© 1 fruta, at√© 1 creme,<br>at√© 3 acompanhamentos,<br>at√© 1 cobertura', available: true, type: 'acai' },
            { id: 'size-500', name: 'Copo Grande (500ml)', price: 15.00, img: '/images/copo-grande.jpg', desc: 'At√© 2 frutas, at√© 2 cremes,<br>at√© 3 acompanhamentos,<br>at√© 1 cobertura', available: true, isBestseller: true, type: 'acai' },
            { id: 'size-1L', name: 'Pote da Felicidade (1 litro)', price: 40.00, img: '/images/pote-felicidade.jpg', desc: 'At√© 3 frutas, at√© 3 cremes,<br>at√© 3 acompanhamentos,<br>at√© 2 coberturas', available: true, type: 'acai' }
        ];
        acaiProducts.forEach(prod => { boxProdutosPrincipais.innerHTML += createProductCardHTML(prod, 'acai'); });
        (allItemsData.produtos_especiais || []).forEach(prod => { boxProdutosPrincipais.innerHTML += createProductCardHTML(prod, prod.type || 'produto_especial'); });
    }

    function createProductCardHTML(prod, type) {
        const disabledClass = !prod.available ? 'disabled-item' : '';
        const inputDisabled = !prod.available ? 'disabled' : '';
        const title = !prod.available ? 'Produto indispon√≠vel' : '';
        const inputId = `prod-${prod.id}`;
        const bestsellerBanner = prod.isBestseller ? '<div class="banner-mais-vendido">O MAIS VENDIDO</div>' : '';
        return `
            <label class="produto-card ${disabledClass}" for="${inputId}" data-product-type="${type}" data-product-id="${prod.id}" data-price="${prod.price}" title="${title}">
                ${bestsellerBanner}
                <img src="${prod.img || '/images/default-product.png'}" alt="${prod.name}" />
                <input type="radio" name="produtoPrincipal" value="${prod.name}" id="${inputId}" required ${inputDisabled}/>
                <div>
                    <strong>${prod.name}</strong> - R$ ${prod.price.toFixed(2).replace('.', ',')}
                    <span>${prod.desc || prod.description || ''}</span>
                </div>
            </label>
        `;
    }

    function setupProdutoPrincipalListeners() {
        document.querySelectorAll('input[name="produtoPrincipal"]').forEach(radio => {
            if (radio.disabled) return;
            radio.addEventListener('change', (e) => {
                document.querySelectorAll('.produto-card').forEach(label => label.classList.remove('selected'));
                const selectedCard = e.target.closest('.produto-card:not(.disabled-item)');
                selectedCard?.classList.add('selected');

                const savedPayment = state.payment;
                const savedDelivery = state.delivery;
                resetPartialForItemSelection(); 
                state.payment = savedPayment;
                state.delivery = savedDelivery;
                if (state.payment) document.querySelector(`input[name="payment"][value="${state.payment}"]`)?.closest('label')?.classList.add('selected-radio');
                if (state.delivery) {
                    const deliveryRadio = document.querySelector(`input[name="delivery"][value="${state.delivery}"]`);
                    if(deliveryRadio) {
                        deliveryRadio.closest('label')?.classList.add('selected-radio');
                        if(!['Retirada', 'Consumo no local'].includes(state.delivery)) fs.address.style.display = 'block';
                    }
                }
                if (pixInfoDiv) pixInfoDiv.classList.toggle('hidden', state.payment !== 'Pix');

                const productType = selectedCard?.dataset.productType;
                const productName = e.target.value;
                const productPrice = parseFloat(selectedCard?.dataset.price || 0);
                const productId = selectedCard?.dataset.productId; 

                state.produtoPrincipal = { type: productType, name: productName, price: productPrice, id: productId };
                productOptionsContainer.style.display = 'block';

                if (productType === 'acai') {
                    if (productId === 'size-300') {
                        state.fMax = 1; state.cMax = 1; state.aMax = 3; state.coMax = 1;
                    } else if (productId === 'size-500') {
                        state.fMax = 2; state.cMax = 2; state.aMax = 3; state.coMax = 1;
                    } else if (productId === 'size-1L') {
                        state.fMax = 3; state.cMax = 3; state.aMax = 3; state.coMax = 2;
                    }
                    state.addMax = undefined; // Sem limite para adicionais de a√ßa√≠
                    
                    [fs.frutas, fs.cremes, fs.accomp, fs.cover, fs.askAdd].forEach(enable);
                    fs.cover.querySelector('legend').textContent = '5. Cobertura(s)';
                    setupChecks(fs.frutas, state.fMax, 'frutas'); 
                    setupChecks(fs.cremes, state.cMax, 'cremes');
                    setupChecks(fs.accomp, state.aMax, 'accomp'); 
                    setupChecks(fs.cover, state.coMax, 'cover');
                    setupRadioListener('wantAdd');
                } else if (productType === 'sorvete') {
                    enable(fs.sorveteSabor); setupRadioListener('sorveteSabor');
                    enable(fs.cover); fs.cover.querySelector('legend').textContent = '3. Escolha a Calda (1 op√ß√£o)'; setupChecks(fs.cover, 1, 'cover');
                    if (productId === 'sorvete-pote') {
                        state.addMax = undefined; // Sem limite
                        enable(fs.askAdd); setupRadioListener('wantAdd');
                    }
                } else if (productType === 'bebida') {
                    state.addMax = undefined; // Sem limite
                    enable(fs.cover); fs.cover.querySelector('legend').textContent = 'Turbine sua Bebida (at√© 2 caldas)'; setupChecks(fs.cover, 2, 'cover');
                    enable(fs.askAdd); setupRadioListener('wantAdd');
                }
                checkIfCanFinish();
            });
        });
    }

    function setupRadioListener(name) {
        const storeAddressInfo = document.getElementById('storeAddressInfo');
        document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
            r.addEventListener('change', ev => {
                if (r.disabled) return;
                state[name] = ev.target.value;
                document.querySelectorAll(`input[name="${name}"]`).forEach(radioEl => radioEl.closest('label')?.classList.remove('selected-radio'));
                ev.target.closest('label:not(.disabled-item)')?.classList.add('selected-radio');
                if (name === 'delivery') {
                    const isDelivery = !['Retirada', 'Consumo no local'].includes(ev.target.value);
                    fs.address.style.display = isDelivery ? 'block' : 'none';
                    if (isDelivery) { enable(fs.address); } else { document.getElementById('addressInput').value = ''; }
                    storeAddressInfo.style.display = isDelivery ? 'none' : 'block';
                }
                if (name === 'wantAdd') {
                    if(state.wantAdd === 'Sim') {
                        enable(fs.add);
                        setupChecks(fs.add, state.addMax, 'add');
                    } else {
                        disable(fs.add);
                        state.add = [];
                        clearCheckboxes(fs.add);
                        updateCounter(cnt.add, 0);
                    }
                }
                if (name === 'payment' && pixInfoDiv) pixInfoDiv.classList.toggle('hidden', ev.target.value !== 'Pix');
                checkIfCanFinish();
            });
        });
    }

    function setupChecks(fieldsetElement, max, key) { 
        const box = fieldsetElement.querySelector('.grid-2, .options-grid'); 
        if (!box) return;
        const counterEl = cnt[key];
        const allCheckboxes = box.querySelectorAll('input[type=checkbox]');
        const noneValue = key === 'add' ? 'Nenhum Adicional' : 'Nenhuma das op√ß√µes';
        const noneCheckbox = Array.from(allCheckboxes).find(c => c.value === noneValue);

        state[key] = (state[key] || []).filter(itemName => Array.from(allCheckboxes).some(c => c.value === itemName && !c.disabled));
        if (!fieldsetElement.hasAttribute('disabled') && state[key].length === 0 && noneCheckbox && !noneCheckbox.disabled) {
            noneCheckbox.checked = true;
            state[key] = [noneValue];
        }
        let initialCount = (key !== 'add' && state[key].includes(noneValue)) ? 0 : state[key].length;
        updateCounter(counterEl, initialCount, max, key);

        allCheckboxes.forEach(chk => {
            chk.addEventListener('change', () => {
                if (chk.disabled) return;
                
                let currentSelected = [...box.querySelectorAll('input[type=checkbox]:checked:not([disabled])')].map(c => c.value);

                if (noneCheckbox) {
                    if (chk === noneCheckbox && chk.checked) {
                        currentSelected = [noneValue];
                        allCheckboxes.forEach(other => { if (other !== noneCheckbox) other.checked = false; });
                    } else if (chk.checked && currentSelected.includes(noneValue)) {
                        noneCheckbox.checked = false;
                        currentSelected = currentSelected.filter(v => v !== noneValue);
                    }
                }
                
                if (currentSelected.length === 0 && noneCheckbox && !noneCheckbox.disabled) {
                    noneCheckbox.checked = true;
                    currentSelected = [noneValue];
                }
                
                state[key] = currentSelected;
                let count = (key !== 'add' && state[key].includes(noneValue)) ? 0 : state[key].length;

                if (max !== undefined && count > max) {
                    chk.checked = false;
                    state[key] = state[key].filter(item => item !== chk.value);
                    if (state[key].length === 0 && noneCheckbox && !noneCheckbox.disabled) {
                        noneCheckbox.checked = true; state[key] = [noneValue];
                    }
                    count = (key !== 'add' && state[key].includes(noneValue)) ? 0 : state[key].length;
                    alert(`M√°ximo de ${max} ${key === 'cover' ? 'cobertura(s)' : key}.`);
                }

                updateCounter(counterEl, count, max, key);
                checkIfCanFinish();
            });
        });
    }

    function updateCounter(element, count, max, key) {
        if (!element) return;
        if (key === 'add') { // Para adicionais, nunca mostrar o /max
             element.textContent = `( ${count} )`;
        } else {
             element.textContent = `( ${count} / ${max ?? '?'} )`;
        }
    }

    // --- L√ìGICA DE PEDIDO ---
    function checkIfCanFinish() {
        const itemValid = validateCurrentOrderItem();
        const clientNameFilled = clientNameInput.value.trim() !== '';
        const paymentSelected = !!state.payment;
        const deliverySelected = !!state.delivery;
        let addressOk = !deliverySelected || ['Retirada', 'Consumo no local'].includes(state.delivery) || addressInput.value.trim() !== '';
        
        const canProceed = itemValid && clientNameFilled && paymentSelected && deliverySelected && addressOk;
        btnAdd.disabled = !canProceed;
        const hasItemsInCart = orders.length > 0;
        btnFinish.disabled = !( (hasItemsInCart && clientNameFilled && paymentSelected && deliverySelected && addressOk) || canProceed );
    }

    function renderOrders() {
        ordersSec.style.display = orders.length > 0 ? 'block' : 'none';
        ordersList.innerHTML = '';
        let totalGeralItensPagina = 0;
        let taxaEntregaPagina = 0;
        if (orders.length > 0 && orders[0].delivery && orders[0].delivery.includes('R$')) {
            taxaEntregaPagina = parseFloat(orders[0].delivery.match(/R\$ (\d+[,.]\d{2})/)[1].replace(',', '.'));
        }

        orders.forEach((orderItem, i) => {
            const li = document.createElement('li');
            let itemDetailsHtml = '';
            let subTotalItem = orderItem.produtoPrincipal?.price || 0;
            const { type } = orderItem.produtoPrincipal;
            
            if (type === 'acai') {
                itemDetailsHtml += `Frutas: ${orderItem.frutas?.join(', ') || 'Nenhuma'}<br>Cremes: ${orderItem.cremes?.join(', ') || 'Nenhum'}<br>Acompanhamentos: ${orderItem.accomp?.join(', ') || 'Nenhum'}<br>Coberturas: ${orderItem.cover?.join(', ') || 'Nenhum'}<br>`;
            } else if (type === 'sorvete') {
                itemDetailsHtml += `Sabor: ${orderItem.sorveteSabor || 'Nenhum'}<br>Calda: ${orderItem.cover?.join(', ') || 'Nenhuma'}<br>`;
            } else if (type === 'bebida') {
                if (orderItem.cover && orderItem.cover.length > 0 && !orderItem.cover.includes('Nenhuma das op√ß√µes')) {
                    itemDetailsHtml += `Caldas: ${orderItem.cover.join(', ')}<br>`;
                }
            }
            
            if (orderItem.add && orderItem.add.length > 0 && !orderItem.add.includes('Nenhum Adicional')) {
                itemDetailsHtml += `Adicionais: ${orderItem.add.map(item => item.split(' - R$ ')[0]).join(', ')}`;
                orderItem.add.forEach(addon => { if (addon.includes('R$')) subTotalItem += parseFloat(addon.match(/R\$ (\d+[,.]\d{2})/)[1].replace(',', '.')); });
            }

            li.innerHTML = `<div class="order-item-header"><strong>Item ${i + 1}: ${orderItem.produtoPrincipal?.name || 'Item'}</strong><button class="repeat-item-btn" data-index="${i}">üîÅ Repetir Item</button></div>${itemDetailsHtml}<br><strong>Subtotal do Item: R$ ${subTotalItem.toFixed(2).replace('.', ',')}</strong>`;
            totalGeralItensPagina += subTotalItem;
            ordersList.appendChild(li);
        });

        document.querySelectorAll('.repeat-item-btn').forEach(btn => btn.addEventListener('click', (e) => repeatOrderItem(parseInt(e.target.dataset.index, 10))));
        if (orderPageTotalValueEl) orderPageTotalValueEl.textContent = (totalGeralItensPagina + taxaEntregaPagina).toFixed(2).replace('.', ',');
    }
    
    function repeatOrderItem(index) {
        if (index > -1 && index < orders.length) {
            orders.splice(index + 1, 0, JSON.parse(JSON.stringify(orders[index])));
            renderOrders();
            checkIfCanFinish();
        }
    }

    function generateSummaryText() {
        if (orders.length === 0) return "Nenhum item no pedido.";
        const clientName = clientNameInput.value.trim();
        const address = addressInput.value.trim();
        let summaryText = `Blue A√ßa√≠ - *Novo Pedido!*\n\n*Cliente:* ${clientName}\n`;
        if (orders[0].delivery && !['Retirada', 'Consumo no local'].includes(orders[0].delivery) && address) {
            summaryText += `*Endere√ßo:* ${address}\n`;
        }
        summaryText += "------------------------------\n\n";

        let totalGeralPedido = 0, deliveryFee = 0;
        const { payment: paymentMethod, delivery: deliveryType } = orders[0];

        orders.forEach((orderItem, i) => {
            let subTotalItem = orderItem.produtoPrincipal?.price || 0;
            const { name, type } = orderItem.produtoPrincipal;
            summaryText += `*Item ${i + 1}: ${name}*\n`;
            
            const formatList = (list) => (list && list.length > 0 && !list.includes('Nenhuma das op√ß√µes') && !list.includes('Nenhum Adicional')) ? list.join(', ') : 'Nenhuma';

            if (type === 'acai') {
                summaryText += `Frutas: ${formatList(orderItem.frutas)}\nCremes: ${formatList(orderItem.cremes)}\nAcompanhamentos: ${formatList(orderItem.accomp)}\nCoberturas: ${formatList(orderItem.cover)}\n`;
            } else if (type === 'sorvete') {
                summaryText += `Sabor: ${orderItem.sorveteSabor || 'N/A'}\nCalda: ${formatList(orderItem.cover)}\n`;
            } else if (type === 'bebida') {
                if (orderItem.cover && orderItem.cover.length > 0 && !orderItem.cover.includes('Nenhuma das op√ß√µes')) {
                    summaryText += `Caldas: ${formatList(orderItem.cover)}\n`;
                }
            }
            
            if (orderItem.add && orderItem.add.length > 0 && !orderItem.add.includes('Nenhum Adicional')) {
                summaryText += `Adicionais: ${orderItem.add.map(a => a.split(' - R$ ')[0].toUpperCase()).join(', ')}\n`;
                orderItem.add.forEach(addon => { if (addon.includes('R$')) subTotalItem += parseFloat(addon.match(/R\$ (\d+[,.]\d{2})/)[1].replace(',', '.')); });
            }
            summaryText += `Subtotal do Item: R$ ${subTotalItem.toFixed(2).replace('.', ',')}\n\n`;
            totalGeralPedido += subTotalItem;
        });
        
        if (deliveryType?.includes('R$')) {
            deliveryFee = parseFloat(deliveryType.match(/R\$ (\d+[,.]\d{2})/)[1].replace(',', '.'));
        }
        
        summaryText += `------------------------------\n*Forma de Pagamento:* ${paymentMethod || 'N/A'}\n*Entrega/Retirada:* ${deliveryType?.split(' - R$')[0] || 'N/A'}\n`;
        if (deliveryFee > 0) {
            summaryText += `*Taxa de Entrega:* R$ ${deliveryFee.toFixed(2).replace('.', ',')}\n`;
            totalGeralPedido += deliveryFee;
        }
        summaryText += `\n*TOTAL GERAL DO PEDIDO: R$ ${totalGeralPedido.toFixed(2).replace('.', ',')}*`;
        summaryEl.textContent = summaryText;
        return summaryText;
    }

    btnAdd.onclick = () => {
        if (btnAdd.disabled) return;
        state.address = addressInput.value.trim();
        orders.push(JSON.parse(JSON.stringify(state)));
        renderOrders();
        const savedPayment = state.payment, savedDelivery = state.delivery;
        resetPartialForItemSelection();
        state.payment = savedPayment; state.delivery = savedDelivery;
        if (savedPayment) document.querySelector(`input[name="payment"][value="${savedPayment}"]`)?.closest('label')?.classList.add('selected-radio');
        if (savedDelivery) {
            const radio = document.querySelector(`input[name="delivery"][value="${savedDelivery}"]`);
            if (radio) {
                radio.closest('label')?.classList.add('selected-radio');
                if (!['Retirada', 'Consumo no local'].includes(savedDelivery)) { fs.address.style.display = 'block'; enable(fs.address); }
            }
        }
        if (pixInfoDiv) pixInfoDiv.classList.toggle('hidden', state.payment !== 'Pix');
        document.querySelectorAll('.produto-card.selected').forEach(c => c.classList.remove('selected'));
        clearRadios('produtoPrincipal');
        checkIfCanFinish();
    };

    btnFinish.onclick = async () => {
        if (btnFinish.disabled) return alert("Por favor, complete todos os campos obrigat√≥rios.");
        if (!!state.produtoPrincipal) {
             state.address = addressInput.value.trim();
             orders.push(JSON.parse(JSON.stringify(state)));
        }
        
        if (orders.length > 0) {
            renderOrders();
            const summaryTextContent = generateSummaryText();
            const phoneNumber = '5598985016035';
            const encodedText = encodeURIComponent(summaryTextContent);
            alert("Pedido finalizado! Voc√™ ser√° redirecionado para o WhatsApp.");
            window.location.href = `https://wa.me/${phoneNumber}?text=${encodedText}`;
            await resetForm(); 
        } else {
            alert("Adicione um item antes de finalizar.");
        }
    };

    btnCancel.onclick = async () => { if (confirm("Deseja cancelar o pedido e limpar tudo?")) await resetForm(); };

    async function resetForm() {
        state = {}; orders = [];
        form.reset();
        clientNameInput.value = ''; addressInput.value = '';
        fs.address.style.display = 'none';
        renderOrders();
        if(pixInfoDiv) pixInfoDiv.classList.add('hidden');
        document.querySelectorAll('.selected-radio, .produto-card.selected').forEach(el => el.classList.remove('selected', 'selected-radio'));
        productOptionsContainer.style.display = 'none';
        await fetchAndApplyItemAvailability();
        btnAdd.disabled = true; btnFinish.disabled = true;
    }

    document.addEventListener('DOMContentLoaded', () => { resetForm(); });
</script>
</body>
</html>
