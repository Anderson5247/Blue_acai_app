<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blue A√ßa√≠ ‚Äì Card√°pio Interativo</title>
    <style>
        :root {
            --purple: #5A0F8D;
            --light-purple: #F3E5FF;
            --dark-text: #333;
            --card-bg: #fff;
            --danger-red: #dc3545;
            --danger-red-hover: #c82333;
            --success-green: #28a745;
            --success-green-hover: #218838;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--light-purple);
            color: var(--dark-text);
        }

        header {
            background: var(--purple);
            color: #fff;
            text-align: center;
            padding: 1rem;
        }

        header img {
            max-width: 120px;
            margin-bottom: .5rem;
        }

        main {
            max-width: 800px;
            margin: 1rem auto;
            padding: 0 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        fieldset {
            border: none;
            margin: 1rem 0;
            transition: opacity .3s;
        }

        fieldset[disabled] {
            opacity: .6;
        }

        fieldset[disabled] label {
            pointer-events: none;
        }


        legend {
            font-weight: bold;
            margin-bottom: .5rem;
            color: var(--purple);
        }

        legend .section-status {
            font-weight: normal;
            font-size: 0.85em;
            color: #666;
            margin-left: 5px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: .75rem;
        }

        label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: .95rem;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        label:hover:not(.disabled-item) {
            background-color: #f0f0f0;
        }

        label.disabled-item {
            text-decoration: line-through;
            color: #aaa !important;
            cursor: not-allowed;
            pointer-events: none;
        }

        label input[type="checkbox"],
        label input[type="radio"] {
            margin-right: .5rem;
            cursor: pointer;
        }

        label input[type="checkbox"]:disabled,
        label input[type="radio"]:disabled {
            cursor: not-allowed;
        }
        
        #clientName {
            width: 100%;
            padding: 0.6rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        #clientName:focus {
            outline: none;
            border-color: var(--purple);
            box-shadow: 0 0 0 2px var(--light-purple);
        }

        .counter {
            margin-left: .5rem;
            color: var(--purple);
            font-weight: normal;
            font-size: .9rem;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: .75rem;
            margin-top: 1.5rem;
        }

        .buttons button {
            padding: .75rem;
            border: none;
            border-radius: 4px;
            background: var(--purple);
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .buttons button#btnCancel {
            background-color: var(--danger-red);
        }
        .buttons button#btnCancel:hover:not(:disabled) {
            background-color: var(--danger-red-hover);
        }

        .buttons button:hover:not(:disabled) {
            background-color: #4a0c74;
        }

        .buttons button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #summary {
            display: none;
            white-space: pre-wrap;
        }

        #ordersSection {
            border-top: 2px solid var(--purple);
            margin-top: 1.5rem;
            padding-top: 1rem;
        }

        #ordersList li {
            margin-bottom: .75rem;
            list-style: none;
            padding-left: 1.5rem;
            position: relative;
            border-bottom: 1px dashed #eee;
            padding-bottom: 0.75rem;
        }
        
        /* NOVO: Estilo para o bot√£o de repetir item */
        .repeat-item-btn {
            background-color: var(--success-green);
            color: white;
            border: none;
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        .repeat-item-btn:hover {
            background-color: var(--success-green-hover);
        }
        .order-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }


        #ordersList li::before {
            content: 'üç¶';
            position: absolute;
            left: 0;
            top: 0;
            font-size: 0.9em;
        }

        .produtos-opcoes { display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin-top: 1rem; }
        .produto-card { background: var(--card-bg); border: 2px solid #ccc; border-radius: 10px; padding: 1rem; width: 210px; text-align: center; transition: 0.3s; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; position: relative; }
        .produto-card input[type="radio"] {
            position: absolute;
            top: 10px;
            right: 10px;
            transform: scale(1.3);
            cursor: pointer;
            accent-color: var(--purple);
            z-index: 2;
        }
        .produto-card:hover { border-color: var(--purple); transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12); }
        label.produto-card.selected { border-color: var(--purple); box-shadow: 0 5px 10px rgba(90, 15, 141, 0.2); background-color: #faf5ff; }
        .produto-card img { width: 100%; max-height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 0.75rem; }
        .produto-card strong { font-size: 1rem; color: #333; display: block; margin-top: 0.5rem; }
        .produto-card span { font-size: 0.85rem; color: #555; margin-top: 0.25rem; display: block; line-height: 1.3; }
        
        .pix-info-container {
            background-color: #fdf1ff;
            border: 1px solid var(--purple);
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        .pix-info-container.hidden {
            display: none;
        }
        .pix-info-container h3 { color: var(--purple); margin-bottom: 0.75rem; }
        .pix-info-container p { margin-bottom: 0.5rem; line-height: 1.4; }
        .pix-info-container small { color: #555; font-style: italic; }

        #orderPageTotal {
            text-align: right; margin-top: 1rem; font-weight: bold;
            font-size: 1.1em; padding: 0.75rem; background-color: #f0f0f0;
            border-top: 1px solid #ddd; border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        #fsCopoFelicidadeFlavors .grid-2 label {
            border: 1px solid #ccc; padding: 10px; border-radius: 5px; background-color: #f9f9f9;
            display: flex; align-items: center;
        }
        #fsCopoFelicidadeFlavors .grid-2 label.selected-radio {
            border-color: var(--purple); background-color: #e9d8f3; font-weight: bold;
        }
        #fsCopoFelicidadeFlavors .grid-2 label input[type="radio"] {
            margin-right: 0.5rem; cursor: pointer; accent-color: var(--purple);
        }
        #fsCopoFelicidadeFlavors .grid-2 label small {
            display: block; font-size: 0.8em; color: #555;
            margin-left: 1.5rem; margin-top: 0.2em; font-weight: normal;
        }
        #fsCopoFelicidadeFlavors .grid-2 label span {
            display: inline; font-weight: bold;
        }

    </style>
</head>
<body>
    <header>
        <img src="/images/logo.png" alt="Logomarca Blue A√ßa√≠" />
        <h1>Blue A√ßa√≠</h1>
        <p>Monte seu a√ßa√≠ como quiser!</p>
    </header>
    <main>
        <div class="card">
            <form id="formPedido">
                <fieldset id="fsProdutoPrincipal">
                    <legend>1. Escolha o Produto <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="produtos-opcoes" id="boxProdutosPrincipais">
                        </div>
                </fieldset>

                <fieldset id="fsCopoFelicidadeFlavors" disabled>
                    <legend>2. Escolha o Sabor <span class="section-status">(Obrigat√≥rio para Copo da Felicidade)</span></legend>
                    <div class="grid-2" id="boxCopoFelicidadeFlavors">
                        </div>
                </fieldset>

                <fieldset id="fsFrutas" disabled><legend>2. Frutas <span id="cntFrutas" class="counter">(0/?)</span></legend><div class="grid-2" id="boxFrutas"><label for="chk-morango"><input type="checkbox" value="Morango" id="chk-morango" data-item-id="morango" />Morango</label><label for="chk-banana"><input type="checkbox" value="Banana" id="chk-banana" data-item-id="banana" />Banana</label><label for="chk-kiwi"><input type="checkbox" value="Kiwi" id="chk-kiwi" data-item-id="kiwi" />Kiwi</label><label for="chk-maca"><input type="checkbox" value="Ma√ß√£" id="chk-maca" data-item-id="maca" />Ma√ß√£</label><label for="chk-uva"><input type="checkbox" value="Uva" id="chk-uva" data-item-id="uva" />Uva</label><label for="chk-frutas-nenhuma"><input type="checkbox" value="Nenhuma" id="chk-frutas-nenhuma" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsCremes" disabled><legend>3. Cremes <span id="cntCremes" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCremes"><label for="chk-ninho"><input type="checkbox" value="Ninho" id="chk-ninho" data-item-id="ninho" />Ninho</label><label for="chk-maracuja"><input type="checkbox" value="Maracuj√°" id="chk-maracuja" data-item-id="maracuja" />Maracuj√°</label><label for="chk-morango-creme"><input type="checkbox" value="Morango (Creme)" id="chk-morango-creme" data-item-id="morango_creme" />Morango (Creme)</label><label for="chk-tutti-frutti-creme"><input type="checkbox" value="Tutti Frutti (Creme)" id="chk-tutti-frutti-creme" data-item-id="tutti_frutti_creme" />Tutti Frutti (Creme)</label><label for="chk-chocolate-avela"><input type="checkbox" value="Chocolate com Avel√£" id="chk-chocolate-avela" data-item-id="chocolate_avela" />Chocolate c/Avel√£</label><label for="chk-cremes-nenhum"><input type="checkbox" value="Nenhuma" id="chk-cremes-nenhum"/>Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsAccomp" disabled><legend>4. Acompanhamentos <span id="cntAccomp" class="counter">(0/?)</span></legend><div class="grid-2" id="boxAccomp"><label for="chk-amendoim-acomp"><input type="checkbox" value="Amendoim" id="chk-amendoim-acomp" data-item-id="amendoim_acomp" />Amendoim</label><label for="chk-pacoca-acomp"><input type="checkbox" value="Pa√ßoca" id="chk-pacoca-acomp" data-item-id="pacoca_acomp" />Pa√ßoca</label><label for="chk-granola-acomp"><input type="checkbox" value="Granola" id="chk-granola-acomp" data-item-id="granola_acomp" />Granola</label><label for="chk-farinha-lactea-acomp"><input type="checkbox" value="Farinha L√°ctea" id="chk-farinha-lactea-acomp" data-item-id="farinha_lactea_acomp" />Farinha L√°ctea</label><label for="chk-leite-po-acomp"><input type="checkbox" value="Leite em P√≥" id="chk-leite-po-acomp" data-item-id="leite_po_acomp" />Leite em P√≥</label><label for="chk-confetes-acomp"><input type="checkbox" value="Confetes" id="chk-confetes-acomp" data-item-id="confetes_acomp" />Confetes</label><label for="chk-tapioca-acomp"><input type="checkbox" value="Tapioca" id="chk-tapioca-acomp" data-item-id="tapioca_acomp" />Tapioca</label><label for="chk-uva-passa-acomp"><input type="checkbox" value="Uva Passa" id="chk-uva-passa-acomp" data-item-id="uva_passa_acomp" />Uva Passa</label><label for="chk-accomp-nenhum"><input type="checkbox" value="Nenhuma" id="chk-accomp-nenhum" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsCoverage" disabled><legend>5. Cobertura(s) <span id="cntCover" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCoverage"><label for="chk-chocolate-cob"><input type="checkbox" value="Chocolate" id="chk-chocolate-cob" data-item-id="chocolate_cob" />Chocolate</label><label for="chk-morango-cob"><input type="checkbox" value="Morango (Cobertura)" id="chk-morango-cob" data-item-id="morango_cob" />Morango (Cobertura)</label><label for="chk-leite-condensado-cob"><input type="checkbox" value="Leite Condensado" id="chk-leite-condensado-cob" data-item-id="leite_condensado_cob" />Leite Condensado</label><label for="chk-tutti-frutti-cob"><input type="checkbox" value="Tutti Frutti (Cobertura)" id="chk-tutti-frutti-cob" data-item-id="tutti_frutti_cob" />Tutti Frutti (Cobertura)</label><label for="chk-ice-blue-cob"><input type="checkbox" value="Ice Blue" id="chk-ice-blue-cob" data-item-id="ice_blue_cob" />Ice Blue</label><label for="chk-kiwi-cob"><input type="checkbox" value="Kiwi (Cobertura)" id="chk-kiwi-cob" data-item-id="kiwi_cob" />Kiwi (Cobertura)</label><label for="chk-cover-nenhuma"><input type="checkbox" value="Nenhuma" id="chk-cover-nenhuma" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsAskAdd" disabled><legend>6. Deseja adicionais? <span class="section-status">(Obrigat√≥rio para A√ßa√≠)</span></legend><div class="grid-2"><label><input type="radio" name="wantAdd" value="Sim" required />Sim</label><label><input type="radio" name="wantAdd" value="N√£o" />N√£o</label></div></fieldset>
                <fieldset id="fsAdd" disabled><legend>7. Adicionais <span id="cntAdd" class="counter">(0/14)</span></legend><div class="grid-2" id="boxAdd"><label for="chk-ovomaltine-add"><input type="checkbox" value="Ovomaltine - R$ 1.00" id="chk-ovomaltine-add" data-item-id="ovomaltine_add" />Ovomaltine R$ 1.00</label><label for="chk-escureto-add"><input type="checkbox" value="Escureto - R$ 1.00" id="chk-escureto-add" data-item-id="escureto_add" />Escureto R$ 1.00</label><label for="chk-chocoball-add"><input type="checkbox" value="Chocoball - R$ 1.00" id="chk-chocoball-add" data-item-id="chocoball_add" />Chocoball R$ 1.00</label><label for="chk-amendoim-add"><input type="checkbox" value="Amendoim (Adicional) - R$ 1.00" id="chk-amendoim-add" data-item-id="amendoim_add" />Amendoim (Adicional) - R$ 1.00</label><label for="chk-pacoca-add"><input type="checkbox" value="Pa√ßoca (Adicional) - R$ 1.00" id="chk-pacoca-add" data-item-id="pacoca_add" />Pa√ßoca (Adicional) - R$ 1.00</label><label for="chk-granola-add"><input type="checkbox" value="Granola (Adicional) - R$ 1.00" id="chk-granola-add" data-item-id="granola_add" />Granola (Adicional) - R$ 1.00</label><label for="chk-farinha-lactea-add"><input type="checkbox" value="Farinha L√°ctea (Adicional) - R$ 1.00" id="chk-farinha-lactea-add" data-item-id="farinha_lactea_add" />Farinha L√°ctea (Adicional) - R$ 1.00</label><label for="chk-leite-po-add"><input type="checkbox" value="Leite em p√≥ (Adicional) - R$ 1.00" id="chk-leite-po-add" data-item-id="leite_po_add" />Leite em p√≥ (Adicional) - R$ 1.00</label><label for="chk-confetes-add"><input type="checkbox" value="Confetes (Adicional) - R$ 1.00" id="chk-confetes-add" data-item-id="confetes_add" />Confetes (Adicional) - R$ 1.00</label><label for="chk-tapioca-add"><input type="checkbox" value="Tapioca (Adicional) - R$ 1.00" id="chk-tapioca-add" data-item-id="tapioca_add" />Tapioca (Adicional) - R$ 1.00</label><label for="chk-uva-passa-add"><input type="checkbox" value="Uva Passa (Adicional) - R$ 1.00" id="chk-uva-passa-add" data-item-id="uva_passa_add" />Uva Passa (Adicional) - R$ 1.00</label><label for="chk-mms-add"><input type="checkbox" value="M&MS - R$ 1.00" id="chk-mms-add" data-item-id="mms_add" />M&MS - R$ 1.00</label><label for="chk-marshmallow-add"><input type="checkbox" value="Marshmallow - R$ 1.00" id="chk-marshmallow-add" data-item-id="marshmallow_add" />Marshmallow - R$ 1.00</label><label for="chk-doce-leite-add"><input type="checkbox" value="Doce de leite - R$ 1.00" id="chk-doce-leite-add" data-item-id="doce_leite_add" />Doce de leite - R$ 1.00</label><label for="chk-add-nenhum"><input type="checkbox" value="Nenhum Adicional" id="chk-add-nenhum" />Nenhum Adicional</label></div></fieldset>

                <fieldset id="fsClientName" disabled>
                    <legend>8. Seu Nome <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div>
                         <input type="text" id="clientName" placeholder="Digite seu nome para identifica√ß√£o" required />
                    </div>
                </fieldset>

                <fieldset id="fsPayment" disabled>
                    <legend>9. Forma de Pagamento <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="payment" value="Pix" required />Pix</label>
                        <label><input type="radio" name="payment" value="Dinheiro" />Dinheiro</label>
                        <label><input type="radio" name="payment" value="Cart√£o" />Cart√£o</label>
                    </div>
                </fieldset>

                <fieldset id="fsDelivery" disabled>
                    <legend>10. Entrega ou Retirada <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="delivery" value="Retirada" required />Retirada</label>
                        <label><input type="radio" name="delivery" value="Outeiro - R$ 3.00" />Entrega - Outeiro (R$ 3.00)</label>
                        <label><input type="radio" name="delivery" value="Cedral - R$ 5.00" />Entrega - Cedral (R$ 5.00)</label>
                    </div>
                </fieldset>

                <div class="buttons">
                    <button type="button" id="btnCancel">‚ùå Cancelar Pedido Atual</button>
                    <button type="button" id="btnAdd" disabled>‚ûï Adicionar Item ao Pedido</button>
                    <button type="button" id="btnFinish" disabled>‚úÖ Finalizar e Enviar Pedido</button>
                </div>

                <div id="pixInfo" class="pix-info-container hidden">
                    <h3>Pagamento via PIX</h3>
                    <p><strong>Nome:</strong> Bruna Raquel Carvalho Campos</p>
                    <p><strong>Chave PIX (Celular):</strong> (98) 985016035</p>
                    <p><small>Por favor, envie o comprovante ap√≥s finalizar o pedido no WhatsApp.</small></p>
                </div>

            </form>
        </div>

        <div class="card" id="ordersSection" style="display:none;">
            <h2>Seus Itens no Pedido:</h2>
            <ul id="ordersList"></ul>
            <div id="orderPageTotal">
                Total Geral (com frete): R$ <span id="orderPageTotalValue">0,00</span>
            </div>
        </div>

        <div id="summary" style="display: none;"></div>
    </main>
    
    <div id="shopClosedContainer" class="card" style="display: none; text-align: center; padding: 2rem; margin: 1rem auto; max-width: 800px;">
        <h2>Estamos Fechados no Momento</h2>
        <p id="closedMessageText" style="margin-top: 1rem; font-size: 1.1em; line-height: 1.6;"></p>
    </div>
<script>
    // --- SELETORES ---
    const fs = {
        produtoPrincipal: document.getElementById('fsProdutoPrincipal'),
        copoFelicidadeFlavors: document.getElementById('fsCopoFelicidadeFlavors'),
        frutas: document.getElementById('fsFrutas'),
        cremes: document.getElementById('fsCremes'),
        accomp: document.getElementById('fsAccomp'),
        cover: document.getElementById('fsCoverage'),
        askAdd: document.getElementById('fsAskAdd'),
        add: document.getElementById('fsAdd'),
        clientName: document.getElementById('fsClientName'), // NOVO
        payment: document.getElementById('fsPayment'),
        delivery: document.getElementById('fsDelivery')
    };
    const cnt = {
        frutas: document.getElementById('cntFrutas'), cremes: document.getElementById('cntCremes'),
        accomp: document.getElementById('cntAccomp'), cover: document.getElementById('cntCover'),
        add: document.getElementById('cntAdd')
    };
    const boxProdutosPrincipais = document.getElementById('boxProdutosPrincipais');
    const boxCopoFelicidadeFlavors = document.getElementById('boxCopoFelicidadeFlavors');
    
    const btnAdd = document.getElementById('btnAdd');
    const btnFinish = document.getElementById('btnFinish');
    const btnCancel = document.getElementById('btnCancel');
    const ordersSec = document.getElementById('ordersSection');
    const ordersList = document.getElementById('ordersList');
    const summaryEl = document.getElementById("summary");
    const form = document.getElementById('formPedido');
    const pixInfoDiv = document.getElementById('pixInfo');
    const orderPageTotalValueEl = document.getElementById('orderPageTotalValue');
    const clientNameInput = document.getElementById('clientName'); // NOVO

    const formCard = document.querySelector('#formPedido').closest('.card');
    const shopClosedContainer = document.getElementById('shopClosedContainer');
    const closedMessageEl = document.querySelector('#shopClosedContainer #closedMessageText');

    let state = {};
    let orders = [];
    let allItemsData = {};

    const enable = el => {
        if (el) {
            el.removeAttribute('disabled');
            el.querySelectorAll('label').forEach(lbl => {
                const input = lbl.querySelector('input');
                if (input && input.disabled) { 
                    lbl.style.pointerEvents = 'none';
                } else {
                    lbl.style.pointerEvents = 'auto';
                }
            });
        }
    };
    const disable = el => {
        if (el) {
            el.setAttribute('disabled', '');
            el.querySelectorAll('label').forEach(lbl => lbl.style.pointerEvents = 'none');
        }
    };

    function clearCheckboxes(fieldset) {
         if (fieldset) {
            fieldset.querySelectorAll('input[type="checkbox"]:checked:not([disabled])').forEach(chk => chk.checked = false);
            const noneValues = ['Nenhuma', 'Nenhum Adicional'];
            noneValues.forEach(noneVal => {
                const noneChk = fieldset.querySelector(`input[value="${noneVal}"]:not([disabled])`);
                 if (noneChk && noneChk.checked) noneChk.checked = false;
            });
         }
    }

    function clearRadios(name) {
        document.querySelectorAll(`input[name="${name}"]:checked`).forEach(r => r.checked = false);
        document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.closest('label')?.classList.remove('selected-radio'));
    }

    function disableAllAcaiAndAddonFieldsets() {
          console.log("Desabilitando fieldsets de a√ßa√≠ e adicionais.");
          [fs.frutas, fs.cremes, fs.accomp, fs.cover, fs.askAdd, fs.add].forEach(f => {
              disable(f);
              clearCheckboxes(f);
          });
          state.frutas = []; updateCounter(cnt.frutas, 0, '?');
          state.cremes = []; updateCounter(cnt.cremes, 0, '?');
          state.accomp = []; updateCounter(cnt.accomp, 0, '?');
          state.cover = []; updateCounter(cnt.cover, 0, '?');
          state.add = []; updateCounter(cnt.add, 0, 14);
          state.wantAdd = undefined; clearRadios('wantAdd');
    }

    function resetPartialForItemSelection() {
          console.log("resetPartialForItemSelection: Resetando para novo item.");
          state.produtoPrincipal = undefined;
          state.size = undefined;
          state.fMax = state.cMax = state.aMax = state.coMax = state.addMax = undefined;
          state.frutas = []; state.cremes = []; state.accomp = []; state.cover = []; state.add = [];
          state.wantAdd = undefined;
          state.selectedCopoFelicidadeFlavor = undefined;

          [fs.frutas, fs.cremes, fs.accomp, fs.cover, fs.askAdd, fs.add, fs.copoFelicidadeFlavors].forEach(f => {
              disable(f);
              if (f.querySelectorAll('input[type="checkbox"]').length > 0) clearCheckboxes(f);
              if (f.querySelectorAll('input[type="radio"]').length > 0) {
                  const radioName = f.querySelector('input[type="radio"]')?.name;
                  if (radioName) clearRadios(radioName);
              }
          });
          updateCounter(cnt.frutas, 0, '?'); updateCounter(cnt.cremes, 0, '?');
          updateCounter(cnt.accomp, 0, '?'); updateCounter(cnt.cover, 0, '?');
          updateCounter(cnt.add, 0, 14);
          
          enable(fs.produtoPrincipal);
          btnAdd.disabled = true;
          btnFinish.disabled = orders.length === 0;
          console.log("resetPartialForItemSelection: Conclu√≠do.");
    }

    function validateCurrentOrderItem() {
        if (!state.produtoPrincipal || !state.produtoPrincipal.type) return false;

        const noneAddValue = 'Nenhum Adicional';
        const noneValue = 'Nenhuma'; 

        if (state.produtoPrincipal.type === 'acai') {
            state.frutas = state.frutas || []; state.cremes = state.cremes || [];
            state.accomp = state.accomp || []; state.cover = state.cover || [];
            state.add = state.add || [];

            const checkSectionValidity = (fieldset, stateKey) => {
                if (!fieldset || fieldset.hasAttribute('disabled')) return true;
                const itemsSelected = state[stateKey];
                if (!itemsSelected || itemsSelected.length === 0) return false; 
                const noneOptionValue = stateKey === 'add' ? noneAddValue : noneValue;
                return !(itemsSelected.includes(noneOptionValue) && itemsSelected.length > 1);
            };

            const frutasOk = checkSectionValidity(fs.frutas, 'frutas');
            const cremesOk = checkSectionValidity(fs.cremes, 'cremes');
            const accompOk = checkSectionValidity(fs.accomp, 'accomp');
            const coverOk = checkSectionValidity(fs.cover, 'cover');

            let addOk = true;
            if (fs.askAdd && !fs.askAdd.hasAttribute('disabled')) { 
                if (state.wantAdd === undefined) return false; 
                if (state.wantAdd === 'Sim') {
                    addOk = checkSectionValidity(fs.add, 'add');
                }
            }
            return frutasOk && cremesOk && accompOk && coverOk && addOk;

        } else if (state.produtoPrincipal.type === 'produto_especial') {
            const productData = allItemsData.produtos_especiais.find(p => p.id === state.produtoPrincipal.id);
            // Se o produto especial tiver "flavors" (sabores), a sele√ß√£o de um sabor √© obrigat√≥ria
            if (productData && productData.flavors && productData.flavors.length > 0) {
                return state.selectedCopoFelicidadeFlavor !== undefined &&
                       state.selectedCopoFelicidadeFlavor !== null &&
                       state.selectedCopoFelicidadeFlavor !== '';
            }
            // Se n√£o tiver sabores, √© v√°lido por si s√≥
            return true;
        } else {
            console.warn("Tipo de produto desconhecido:", state.produtoPrincipal);
            return false;
        }
    }
    
    async function fetchAndApplyItemAvailability() {
        console.log("fetchAndApplyItemAvailability: Buscando dados de itens...");
        try {
            const response = await fetch('/api/items');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            allItemsData = await response.json();
            console.log("fetchAndApplyItemAvailability: Dados recebidos:", allItemsData);

            if (allItemsData.shopInfo && !allItemsData.shopInfo.isOpen) {
                if (formCard) formCard.style.display = 'none';
                if (ordersSec) ordersSec.style.display = 'none';
                if (shopClosedContainer && closedMessageEl) {
                    closedMessageEl.innerText = allItemsData.shopInfo.closedMessage;
                    shopClosedContainer.style.display = 'block';
                }
                return;
            }

            if (formCard) formCard.style.display = 'block';
            if (shopClosedContainer) shopClosedContainer.style.display = 'none';
            
            renderProdutosPrincipais();

            const updateCheckboxDisplay = (categoryKey, fieldsetElement) => {
                if (!allItemsData[categoryKey] || !fieldsetElement) return;
                const checkboxes = fieldsetElement.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    const itemId = checkbox.dataset.itemId;
                    if (!itemId && !checkbox.value.toLowerCase().includes("nenhum")) return;
                    let itemData = itemId ? allItemsData[categoryKey].find(item => item.id === itemId) : null;
                    const label = checkbox.closest('label');
                    if (itemData) { 
                        checkbox.disabled = !itemData.available;
                        if(label) label.classList.toggle('disabled-item', !itemData.available);
                        if(label) label.title = itemData.available ? '' : 'Item indispon√≠vel';
                    } else if (checkbox.value.toLowerCase().includes("nenhum")) {
                        checkbox.disabled = false;
                        if (label) { label.classList.remove('disabled-item'); label.title = '';}
                    }
                });
            };

            updateCheckboxDisplay('frutas', fs.frutas);
            updateCheckboxDisplay('cremes', fs.cremes);
            updateCheckboxDisplay('acompanhamentos', fs.accomp);
            updateCheckboxDisplay('coberturas', fs.cover);
            updateCheckboxDisplay('adicionais', fs.add);

            setupProdutoPrincipalListeners();
            setupRadioListener('payment');
            setupRadioListener('delivery');
            clientNameInput.addEventListener('input', checkIfCanFinish); // NOVO

            enable(fs.payment);
            enable(fs.delivery);
            enable(fs.clientName); // NOVO

        } catch (error) {
            console.error("fetchAndApplyItemAvailability: Erro ao carregar:", error);
            alert("Erro ao carregar o card√°pio. Por favor, recarregue a p√°gina.");
            disableAllFieldsetsInForm();
        }
    }

    function renderProdutosPrincipais() {
        if (!boxProdutosPrincipais) return;
        boxProdutosPrincipais.innerHTML = '';
        
        // Renderiza A√ßa√≠s
        const acaiProducts = allItemsData.acai_sizes || [];
        acaiProducts.forEach(prod => {
            boxProdutosPrincipais.innerHTML += createProductCardHTML(prod, 'acai');
        });

        // NOVO: Renderiza todos os Produtos Especiais
        const specialProducts = allItemsData.produtos_especiais || [];
        specialProducts.forEach(prod => {
             boxProdutosPrincipais.innerHTML += createProductCardHTML(prod, 'produto_especial');
        });
        
        renderCopoFelicidadeFlavors(); // Prepara os sabores, mas mant√©m escondido
    }

    function createProductCardHTML(prod, type) {
        const disabledClass = !prod.available ? 'disabled-item' : '';
        const inputDisabled = !prod.available ? 'disabled' : '';
        const title = !prod.available ? 'Produto indispon√≠vel' : '';
        // Usa o ID do produto para o 'for' e 'id' do input para garantir unicidade
        const inputId = `prod-${prod.id}`; 
        
        return `
            <label class="produto-card ${disabledClass}" for="${inputId}" data-product-type="${type}" data-product-id="${prod.id}" data-price="${prod.price}" title="${title}">
                <img src="${prod.img || '/images/default-product.png'}" alt="${prod.name}" />
                <input type="radio" name="produtoPrincipal" value="${prod.name}" id="${inputId}" required ${inputDisabled}/>
                <div>
                    <strong>${prod.name}</strong> - R$ ${prod.price.toFixed(2).replace('.', ',')}
                    <span>${prod.desc || prod.description || ''}</span>
                </div>
            </label>
        `;
    }

    function renderCopoFelicidadeFlavors() {
        const copoFelicidadeData = allItemsData.produtos_especiais?.find(p => p.id === 'copo_felicidade');
        
        if (!boxCopoFelicidadeFlavors || !copoFelicidadeData || !copoFelicidadeData.flavors || copoFelicidadeData.flavors.length === 0) {
            boxCopoFelicidadeFlavors.innerHTML = (copoFelicidadeData && copoFelicidadeData.available) ? '<p>Nenhuma op√ß√£o de sabor configurada.</p>' : '';
            return;
        }
        boxCopoFelicidadeFlavors.innerHTML = '';
        copoFelicidadeData.flavors.forEach(flavor => {
            const flavorDisabled = !flavor.available ? 'disabled' : '';
            const labelClass = !flavor.available ? 'disabled-item' : '';
            const title = !flavor.available ? 'Sabor indispon√≠vel' : '';

            boxCopoFelicidadeFlavors.innerHTML += `
                <label for="flavor-${flavor.id}" class="${labelClass}" title="${title}">
                    <input type="radio" name="copoFelicidadeFlavor" value="${flavor.name}" id="flavor-${flavor.id}" data-flavor-id="${flavor.id}" required ${flavorDisabled} />
                    <span>${flavor.name}</span>
                    ${flavor.internal_description ? `<small>(${flavor.internal_description})</small>` : ''}
                </label>`;
        });
        setupRadioListener('copoFelicidadeFlavor');
    }

    function setupProdutoPrincipalListeners() {
        document.querySelectorAll('input[name="produtoPrincipal"]').forEach(radio => {
            if (radio.disabled) return;
            if (radio._productListener) radio.removeEventListener('change', radio._productListener);
            
            const newProductListener = (e) => {
                document.querySelectorAll('.produto-card').forEach(label => label.classList.remove('selected'));
                e.target.closest('.produto-card:not(.disabled-item)')?.classList.add('selected');

                const savedPayment = state.payment;
                const savedDelivery = state.delivery;
                resetPartialForItemSelection(); 
                state.payment = savedPayment;
                state.delivery = savedDelivery;
                if (state.payment) document.querySelector(`input[name="payment"][value="${state.payment}"]`)?.closest('label')?.classList.add('selected-radio');
                if (state.delivery) document.querySelector(`input[name="delivery"][value="${state.delivery}"]`)?.closest('label')?.classList.add('selected-radio');
                if (pixInfoDiv) pixInfoDiv.classList.toggle('hidden', state.payment !== 'Pix');

                const selectedCard = e.target.closest('.produto-card');
                const productType = selectedCard?.dataset.productType;
                const productName = e.target.value;
                const productPrice = parseFloat(selectedCard?.dataset.price || 0);
                const productId = selectedCard?.dataset.productId; 

                state.produtoPrincipal = { type: productType, name: productName, price: productPrice, id: productId };

                if (productType === 'acai') {
                    disable(fs.copoFelicidadeFlavors);
                    clearRadios('copoFelicidadeFlavor');
                    state.selectedCopoFelicidadeFlavor = undefined;

                    let fMax = 0, cMax = 0, aMax = 0, coMax = 0;
                    if (productId === 'size-300') { fMax = 1; cMax = 1; aMax = 3; coMax = 1; }
                    else if (productId === 'size-500') { fMax = 2; cMax = 2; aMax = 3; coMax = 1; }
                    else if (productId === 'size-1L') { fMax = 3; cMax = 3; aMax = 4; coMax = 2; }
                    state.fMax = fMax; state.cMax = cMax; state.aMax = aMax; state.coMax = coMax; state.addMax = 14;

                    [fs.frutas, fs.cremes, fs.accomp, fs.cover, fs.askAdd].forEach(enable);
                    setupChecks(fs.frutas, fMax, 'frutas');
                    setupChecks(fs.cremes, cMax, 'cremes');
                    setupChecks(fs.accomp, aMax, 'accomp');
                    setupChecks(fs.cover, coMax, 'cover');
                    setupRadioListener('wantAdd', 'askAdd');
                
                } else if (productType === 'produto_especial') {
                    disableAllAcaiAndAddonFieldsets();
                    const productData = allItemsData.produtos_especiais.find(p => p.id === productId);
                    // S√≥ habilita o fieldset de sabores se o produto espec√≠fico for o Copo da Felicidade
                    if (productId === 'copo_felicidade' && productData?.flavors) {
                        enable(fs.copoFelicidadeFlavors); 
                    } else {
                        disable(fs.copoFelicidadeFlavors);
                        clearRadios('copoFelicidadeFlavor');
                        state.selectedCopoFelicidadeFlavor = undefined;
                    }
                } else {
                    disableAllAcaiAndAddonFieldsets();
                    disable(fs.copoFelicidadeFlavors);
                    clearRadios('copoFelicidadeFlavor'); state.selectedCopoFelicidadeFlavor = undefined;
                }
                checkIfCanFinish();
            };
            radio.addEventListener('change', newProductListener);
            radio._productListener = newProductListener;
        });
    }

    function setupRadioListener(name, stageToAdvanceOnClick) {
        document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
            if (r.disabled) return;
            if (r._currentListener) r.removeEventListener('change', r._currentListener);
            
            const new_listener = ev => {
                state[name] = ev.target.value;
                document.querySelectorAll(`input[name="${name}"]`).forEach(radioEl => {
                    radioEl.closest('label')?.classList.remove('selected-radio');
                });
                ev.target.closest('label:not(.disabled-item)')?.classList.add('selected-radio');

                if (name === 'copoFelicidadeFlavor') {
                    state.selectedCopoFelicidadeFlavor = ev.target.value;
                } else if (name === 'wantAdd' && stageToAdvanceOnClick) {
                    advanceStage(stageToAdvanceOnClick);
                }

                if (name === 'payment' && pixInfoDiv) {
                    pixInfoDiv.classList.toggle('hidden', ev.target.value !== 'Pix');
                }
                checkIfCanFinish();
            };
            r.addEventListener('change', new_listener);
            r._currentListener = new_listener;
        });
    }

    function setupChecks(fieldsetElement, max, key) { 
        const box = fieldsetElement.querySelector('.grid-2'); 
        if (!box) return;
        
        const counterEl = cnt[key];
        const allCheckboxesInBox = box.querySelectorAll('input[type=checkbox]');
        const noneValue = key === 'add' ? 'Nenhum Adicional' : 'Nenhuma';
        const noneCheckbox = box.querySelector(`input[value="${noneValue}"]`);

        state[key] = state[key] || [];
        state[key] = state[key].filter(itemName => {
            const chk = Array.from(allCheckboxesInBox).find(c => c.value === itemName);
            return chk && !chk.disabled;
        });
        
        if (fieldsetElement && !fieldsetElement.hasAttribute('disabled')) {
            if (state[key].length === 0 && noneCheckbox && !noneCheckbox.disabled) {
                noneCheckbox.checked = true;
                state[key] = [noneValue]; 
            }
        }

        let initialCount = state[key].includes(noneValue) ? 0 : state[key].filter(item => item !== noneValue).length;
        updateCounter(counterEl, initialCount, max);

        allCheckboxesInBox.forEach(chk => {
            if (chk._currentListener) chk.removeEventListener('change', chk._currentListener);
            
            const new_listener = () => {
                if (chk.disabled && !chk.value.toLowerCase().includes("nenhum")) return;

                const currentSelectedInBox = [...box.querySelectorAll('input[type=checkbox]:checked:not([disabled])')];
                const isNoneChecked = noneCheckbox && noneCheckbox.checked;

                if (noneCheckbox) {
                    if (chk === noneCheckbox && chk.checked) {
                        allCheckboxesInBox.forEach(otherChk => {
                            if (otherChk !== noneCheckbox && !otherChk.disabled) otherChk.checked = false;
                        });
                        state[key] = [noneValue];
                    } else if (chk !== noneCheckbox && chk.checked && isNoneChecked) {
                        if (!noneCheckbox.disabled) noneCheckbox.checked = false;
                        state[key] = currentSelectedInBox.filter(c => c !== noneCheckbox).map(i => i.value);
                    } else {
                        state[key] = currentSelectedInBox.map(i => i.value);
                        if (state[key].length === 0 && noneCheckbox && !noneCheckbox.disabled) {
                            noneCheckbox.checked = true; state[key] = [noneValue];
                        } else if (state[key].length > 0 && state[key].some(val => val !== noneValue) && noneCheckbox && noneCheckbox.checked && !noneCheckbox.disabled) {
                            noneCheckbox.checked = false;
                            state[key] = state[key].filter(item => item !== noneValue);
                        }
                    }
                } else {
                    state[key] = currentSelectedInBox.map(i => i.value);
                }

                let actualSelectedCount = state[key].includes(noneValue) ? 0 : state[key].filter(item => item !== noneValue).length;

                if (max !== undefined && actualSelectedCount > max) {
                    chk.checked = false;
                    state[key] = state[key].filter(item => item !== chk.value);
                    if (state[key].length === 0 && noneCheckbox && !noneCheckbox.disabled) {
                        noneCheckbox.checked = true; state[key] = [noneValue];
                    }
                    actualSelectedCount = state[key].includes(noneValue) ? 0 : state[key].filter(item => item !== noneValue).length;
                    alert(`M√°ximo ${max} ${key === 'add' ? 'adicionais' : key}.`);
                }

                updateCounter(counterEl, actualSelectedCount, max);
                checkIfCanFinish();
            };
            chk.addEventListener('change', new_listener);
            chk._currentListener = new_listener;
        });
    }

    function updateCounter(element, count, max) {
        if (element) {
            element.textContent = `( ${count} / ${max !== undefined ? max : '?'} )`;
        }
    }

    function advanceStage(stage) {
        switch (stage) {
            case 'askAdd':
                if (state.wantAdd === 'Sim') {
                    enable(fs.add);
                    setupChecks(fs.add, state.addMax !== undefined ? state.addMax : 14, 'add');
                    const currentAddCount = state.add ? state.add.filter(item => item !== 'Nenhum Adicional').length : 0;
                    updateCounter(cnt.add, currentAddCount, state.addMax !== undefined ? state.addMax : 14);
                } else if (state.wantAdd === 'N√£o') {
                    state.add = ['Nenhum Adicional'];
                    disable(fs.add);
                    clearCheckboxes(fs.add);
                    updateCounter(cnt.add, 0, state.addMax !== undefined ? state.addMax : 14);
                }
                break;
        }
        checkIfCanFinish();
    }

    function checkIfCanFinish() {
        const itemValid = validateCurrentOrderItem();
        const paymentSelected = state.payment && !fs.payment.hasAttribute('disabled');
        const deliverySelected = state.delivery && !fs.delivery.hasAttribute('disabled');
        const clientNameFilled = clientNameInput.value.trim() !== ''; // NOVO

        const canProceedCurrentItem = itemValid && paymentSelected && deliverySelected && clientNameFilled;

        btnAdd.disabled = !canProceedCurrentItem;
        btnFinish.disabled = !(canProceedCurrentItem || (orders.length > 0 && paymentSelected && deliverySelected && clientNameFilled));
    }

    function renderOrders() {
        ordersSec.style.display = orders.length > 0 ? 'block' : 'none';
        ordersList.innerHTML = '';
        let totalGeralItensPagina = 0;
        let taxaEntregaPagina = 0;
        let localEntregaPagina = "Retirada";

        orders.forEach((orderItem, i) => {
            const li = document.createElement('li');
            let itemDetailsHtml = '';
            let subTotalItem = 0;

            const itemNameForDisplay = orderItem.produtoPrincipal?.name || 'Produto Desconhecido';
            subTotalItem = orderItem.produtoPrincipal?.price || 0;

            if (orderItem.produtoPrincipal?.type === 'produto_especial') {
                if (orderItem.selectedCopoFelicidadeFlavor) {
                    itemDetailsHtml += `Sabor: ${orderItem.selectedCopoFelicidadeFlavor}`;
                } else {
                    itemDetailsHtml += `(Produto sem op√ß√µes adicionais)`;
                }
            } else { 
                const displayFrutas = orderItem.frutas?.length > 0 && !orderItem.frutas.includes('Nenhuma') ? orderItem.frutas.join(', ') : 'Nenhuma';
                const displayCremes = orderItem.cremes?.length > 0 && !orderItem.cremes.includes('Nenhuma') ? orderItem.cremes.join(', ') : 'Nenhum';
                const displayAccomp = orderItem.accomp?.length > 0 && !orderItem.accomp.includes('Nenhuma') ? orderItem.accomp.join(', ') : 'Nenhum';
                const displayCover = orderItem.cover?.length > 0 && !orderItem.cover.includes('Nenhuma') ? orderItem.cover.join(', ') : 'Nenhuma';
                itemDetailsHtml += `Frutas: ${displayFrutas}<br>Cremes: ${displayCremes}<br>Acompanhamentos: ${displayAccomp}<br>Coberturas: ${displayCover}<br>`;

                let displayAdd = 'Nenhum Adicional';
                if (orderItem.add && orderItem.add.length > 0 && !orderItem.add.includes('Nenhum Adicional')) {
                    displayAdd = orderItem.add.map(item => item.split(' - R$ ')[0]).join(', ');
                     orderItem.add.forEach(addon => {
                         if (addon.includes('R$')) {
                             const addonPriceMatch = addon.match(/R\$ (\d+[,.]\d{2})/);
                             if (addonPriceMatch) subTotalItem += parseFloat(addonPriceMatch[1].replace(',', '.'));
                         }
                     });
                }
                itemDetailsHtml += `Adicionais: ${displayAdd}`;
            }
            
            // NOVO: Adiciona cabe√ßalho com bot√£o de repetir
            li.innerHTML = `
                <div class="order-item-header">
                    <strong>Item ${i + 1}: ${itemNameForDisplay}</strong>
                    <button class="repeat-item-btn" data-index="${i}">üîÅ Repetir Item</button>
                </div>
                ${itemDetailsHtml}<br>
                <strong>Subtotal do Item: R$ ${subTotalItem.toFixed(2).replace('.', ',')}</strong>
            `;

            totalGeralItensPagina += subTotalItem;

            if (i === 0 && orderItem.delivery) {
                localEntregaPagina = orderItem.delivery.split(' - R$ ')[0];
                if (orderItem.delivery.includes('R$')) {
                    const deliveryPriceMatch = orderItem.delivery.match(/R\$ (\d+[,.]\d{2})/);
                    if (deliveryPriceMatch) taxaEntregaPagina = parseFloat(deliveryPriceMatch[1].replace(',', '.'));
                }
            }
            ordersList.appendChild(li);
        });

        // NOVO: Adiciona event listeners aos bot√µes de repetir
        document.querySelectorAll('.repeat-item-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index, 10);
                repeatOrderItem(index);
            });
        });

        let totalFinalPagina = totalGeralItensPagina;
        if (localEntregaPagina !== "Retirada" && taxaEntregaPagina > 0) {
            totalFinalPagina += taxaEntregaPagina;
        }

        if (orderPageTotalValueEl) orderPageTotalValueEl.textContent = totalFinalPagina.toFixed(2).replace('.', ',');
    }
    
    // NOVO: Fun√ß√£o para repetir um item do pedido
    function repeatOrderItem(index) {
        if (index > -1 && index < orders.length) {
            const itemToRepeat = JSON.parse(JSON.stringify(orders[index]));
            orders.splice(index + 1, 0, itemToRepeat); // Insere o item duplicado logo ap√≥s o original
            renderOrders(); // Re-renderiza a lista de pedidos atualizada
            checkIfCanFinish(); // Re-valida o estado dos bot√µes
        }
    }

    function generateSummaryText() {
        if (orders.length === 0) return "Nenhum item no pedido.";

        const clientName = clientNameInput.value.trim();
        let summaryText = "Blue A√ßa√≠ - *Novo Pedido!*\n\n";
        if (clientName) {
             summaryText += `*Cliente:* ${clientName}\n`;
        }
        summaryText += "------------------------------\n\n";

        let totalGeralPedido = 0;
        let deliveryFee = 0;
        let deliveryLocation = "Retirada";
        let paymentMethod = orders[0].payment || "N√£o especificado";

        orders.forEach((orderItem, i) => {
            let subTotalItem = 0;
            const itemName = orderItem.produtoPrincipal?.name || 'Produto Desconhecido';
            subTotalItem = orderItem.produtoPrincipal?.price || 0;

            summaryText += `*Item ${i + 1}: ${itemName}*\n`;

            if (orderItem.produtoPrincipal?.type === 'produto_especial') {
                if(orderItem.selectedCopoFelicidadeFlavor) {
                    summaryText += `Sabor: ${orderItem.selectedCopoFelicidadeFlavor}\n`;
                }
            } else {
                summaryText += `Frutas: ${orderItem.frutas?.includes('Nenhuma') ? 'Nenhuma' : (orderItem.frutas?.join(', ') || 'Nenhuma')}\n`;
                summaryText += `Cremes: ${orderItem.cremes?.includes('Nenhuma') ? 'Nenhuma' : (orderItem.cremes?.join(', ') || 'Nenhum')}\n`;
                summaryText += `Acompanhamentos: ${orderItem.accomp?.includes('Nenhuma') ? 'Nenhuma' : (orderItem.accomp?.join(', ') || 'Nenhum')}\n`;
                summaryText += `Coberturas: ${orderItem.cover?.includes('Nenhuma') ? 'Nenhuma' : (orderItem.cover?.join(', ') || 'Nenhuma')}\n`;
                if (orderItem.add && !orderItem.add.includes('Nenhum Adicional')) {
                    // NOVO: Adicionais em mai√∫sculo
                    const adicionaisNomes = orderItem.add.map(a => a.split(' - R$ ')[0].toUpperCase()).join(', ');
                    summaryText += `Adicionais: ${adicionaisNomes}\n`;
                     orderItem.add.forEach(addon => {
                         const pricePart = addon.split(' - R$ ')[1];
                         if(pricePart) subTotalItem += parseFloat(pricePart.replace(',', '.'));
                     });
                } else {
                    summaryText += `Adicionais: Nenhum Adicional\n`;
                }
            }
            summaryText += `Subtotal do Item: R$ ${subTotalItem.toFixed(2).replace('.', ',')}\n\n`; // NOVO: Espa√ßamento com \n\n
            totalGeralPedido += subTotalItem;

            if (i === 0) {
                deliveryLocation = orderItem.delivery ? orderItem.delivery.split(' - R$ ')[0] : "Retirada";
                if (orderItem.delivery && orderItem.delivery.includes('R$')) {
                    const deliveryPriceMatch = orderItem.delivery.match(/R\$ (\d+[,.]\d{2})/);
                    if (deliveryPriceMatch) deliveryFee = parseFloat(deliveryPriceMatch[1].replace(',', '.'));
                }
            }
        });

        summaryText += `------------------------------\n`;
        summaryText += `*Forma de Pagamento:* ${paymentMethod}\n`;
        summaryText += `*Entrega/Retirada:* ${deliveryLocation}\n`;
        if (deliveryLocation !== "Retirada" && deliveryFee > 0) {
            summaryText += `*Taxa de Entrega:* R$ ${deliveryFee.toFixed(2).replace('.', ',')}\n`;
            totalGeralPedido += deliveryFee;
        }
        summaryText += `\n*TOTAL GERAL DO PEDIDO: R$ ${totalGeralPedido.toFixed(2).replace('.', ',')}*`;
        summaryEl.textContent = summaryText;
        return summaryText;
    }

    btnAdd.onclick = () => {
        if (validateCurrentOrderItem() && state.payment && state.delivery && clientNameInput.value.trim() !== '') {
            orders.push(JSON.parse(JSON.stringify(state)));
            renderOrders();
            
            const savedPayment = state.payment;
            const savedDelivery = state.delivery;
            resetPartialForItemSelection();
            state.payment = savedPayment;
            state.delivery = savedDelivery;
            
            if (savedPayment) document.querySelector(`input[name="payment"][value="${savedPayment}"]`)?.closest('label')?.classList.add('selected-radio');
            if (savedDelivery) document.querySelector(`input[name="delivery"][value="${savedDelivery}"]`)?.closest('label')?.classList.add('selected-radio');
            if (pixInfoDiv && state.payment === 'Pix') pixInfoDiv.classList.remove('hidden'); else if (pixInfoDiv) pixInfoDiv.classList.add('hidden');
            
            document.querySelectorAll('.produto-card.selected').forEach(card => card.classList.remove('selected'));
            clearRadios('produtoPrincipal');

            checkIfCanFinish();
        } else {
            alert("Por favor, complete todas as sele√ß√µes obrigat√≥rias, incluindo seu nome, forma de pagamento e entrega/retirada.");
        }
    };

    btnFinish.onclick = async () => {
        const clientNameFilled = clientNameInput.value.trim() !== '';
        if (orders.length === 0 && !validateCurrentOrderItem()) {
             alert("Seu pedido est√° vazio. Por favor, adicione ao menos um item.");
             return;
        }
        if (!clientNameFilled) {
            alert("Por favor, informe seu nome para finalizar o pedido.");
            clientNameInput.focus();
            return;
        }

        const currentItemValidAndComplete = validateCurrentOrderItem() && state.payment && state.delivery;

        if (currentItemValidAndComplete && state.produtoPrincipal) {
            const lastOrderClean = orders.length > 0 ? JSON.stringify(cleanOrderForComparison(orders[orders.length - 1])) : null;
            const currentStateClean = JSON.stringify(cleanOrderForComparison(state));
            if (!lastOrderClean || currentStateClean !== lastOrderClean || orders.length === 0) {
                orders.push(JSON.parse(JSON.stringify(state)));
            }
        }
        
        if (orders.length > 0) {
            renderOrders();
            const summaryTextContent = generateSummaryText();
            const phoneNumber = '5598985016035';
            const encodedText = encodeURIComponent(summaryTextContent);
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedText}`;

            // ... (o resto da fun√ß√£o com o payload para o servidor continua igual)
            
            // Simula√ß√£o de envio para o WhatsApp
            alert("Pedido finalizado! Voc√™ ser√° redirecionado para o WhatsApp.");
            window.location.href = whatsappURL;
            await resetForm(); 

        } else {
            alert("Adicione pelo menos um item ao pedido antes de finalizar.");
        }
    };

    function cleanOrderForComparison(orderState) {
        if (!orderState) return null;
        const clean = { ...orderState };
        delete clean.fMax; delete clean.cMax; delete clean.aMax; delete clean.coMax; delete clean.addMax;
        delete clean.payment; delete clean.delivery;
        return clean;
    }

    btnCancel.onclick = async () => {
        if (confirm("Tem certeza que deseja cancelar o pedido e limpar todas as sele√ß√µes?")) {
            await resetForm();
        }
    };

    async function resetForm() {
        state = {}; orders = [];
        form.reset(); // Limpa todos os campos do formul√°rio
        clientNameInput.value = ''; // Garante que o nome seja limpo
        renderOrders();
        if(pixInfoDiv) pixInfoDiv.classList.add('hidden');
        
        document.querySelectorAll('.selected-radio, .produto-card.selected').forEach(el => el.classList.remove('selected', 'selected-radio'));
        
        const allFieldsets = form.querySelectorAll('fieldset');
        allFieldsets.forEach(fset => {
            if (fset.id !== 'fsProdutoPrincipal') disable(fset); else enable(fset);
        });
        disable(fs.copoFelicidadeFlavors);
        
        await fetchAndApplyItemAvailability(); // Recarrega os dados e reabilita os campos necess√°rios
        
        updateCounter(cnt.frutas, 0, '?'); updateCounter(cnt.cremes, 0, '?');
        updateCounter(cnt.accomp, 0, '?'); updateCounter(cnt.cover, 0, '?');
        updateCounter(cnt.add, 0, 14);

        btnAdd.disabled = true; btnFinish.disabled = true;
    }

    function disableAllFieldsetsInForm() {
         form.querySelectorAll('fieldset').forEach(disable);
    }

    document.addEventListener('DOMContentLoaded', () => {
        resetForm();
    });
</script>
</body>
</html>
